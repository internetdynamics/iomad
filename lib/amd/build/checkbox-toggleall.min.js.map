{"version":3,"file":"checkbox-toggleall.min.js","sources":["../src/checkbox-toggleall.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * A module to help with toggle select/deselect all.\r\n *\r\n * @module     core/checkbox-toggleall\r\n * @copyright  2019 Andrew Nicols <andrew@nicols.co.uk>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\ndefine(['jquery', 'core/pubsub'], function($, PubSub) {\r\n\r\n    /**\r\n     * Whether event listeners have already been registered.\r\n     *\r\n     * @private\r\n     * @type {boolean}\r\n     */\r\n    var registered = false;\r\n\r\n    /**\r\n     * List of custom events that this module publishes.\r\n     *\r\n     * @private\r\n     * @type {{checkboxToggled: string}}\r\n     */\r\n    var events = {\r\n        checkboxToggled: 'core/checkbox-toggleall:checkboxToggled',\r\n    };\r\n\r\n    /**\r\n     * Fetches elements that are member of a given toggle group.\r\n     *\r\n     * @private\r\n     * @param {jQuery} root The root jQuery element.\r\n     * @param {string} toggleGroup The toggle group name that we're searching form.\r\n     * @param {boolean} exactMatch Whether we want an exact match we just want to match toggle groups that start with the given\r\n     *                             toggle group name.\r\n     * @returns {jQuery} The elements matching the given toggle group.\r\n     */\r\n    var getToggleGroupElements = function(root, toggleGroup, exactMatch) {\r\n        if (exactMatch) {\r\n            return root.find('[data-action=\"toggle\"][data-togglegroup=\"' + toggleGroup + '\"]');\r\n        } else {\r\n            return root.find('[data-action=\"toggle\"][data-togglegroup^=\"' + toggleGroup + '\"]');\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Fetches the slave checkboxes for a given toggle group.\r\n     *\r\n     * @private\r\n     * @param {jQuery} root The root jQuery element.\r\n     * @param {string} toggleGroup The toggle group name.\r\n     * @returns {jQuery} The slave checkboxes belonging to the toggle group.\r\n     */\r\n    var getAllSlaveCheckboxes = function(root, toggleGroup) {\r\n        return getToggleGroupElements(root, toggleGroup, false).filter('[data-toggle=\"slave\"]');\r\n    };\r\n\r\n    /**\r\n     * Fetches the master elements (checkboxes or buttons) that control the slave checkboxes in a given toggle group.\r\n     *\r\n     * @private\r\n     * @param {jQuery} root The root jQuery element.\r\n     * @param {string} toggleGroup The toggle group name.\r\n     * @param {boolean} exactMatch\r\n     * @returns {jQuery} The control elements belonging to the toggle group.\r\n     */\r\n    var getControlCheckboxes = function(root, toggleGroup, exactMatch) {\r\n        return getToggleGroupElements(root, toggleGroup, exactMatch).filter('[data-toggle=\"master\"]');\r\n    };\r\n\r\n    /**\r\n     * Fetches the action elements that perform actions on the selected checkboxes in a given toggle group.\r\n     *\r\n     * @private\r\n     * @param {jQuery} root The root jQuery element.\r\n     * @param {string} toggleGroup The toggle group name.\r\n     * @returns {jQuery} The action elements belonging to the toggle group.\r\n     */\r\n    var getActionElements = function(root, toggleGroup) {\r\n        return getToggleGroupElements(root, toggleGroup, true).filter('[data-toggle=\"action\"]');\r\n    };\r\n\r\n    /**\r\n     * Toggles the slave checkboxes in a given toggle group when a master element in that toggle group is toggled.\r\n     *\r\n     * @private\r\n     * @param {Object} e The event object.\r\n     */\r\n    var toggleSlavesFromMasters = function(e) {\r\n        var root = e.data.root;\r\n        var target = $(e.target);\r\n\r\n        var toggleGroupName = target.data('togglegroup');\r\n        var targetState;\r\n        if (target.is(':checkbox')) {\r\n            targetState = target.is(':checked');\r\n        } else {\r\n            targetState = target.data('checkall') === 1;\r\n        }\r\n\r\n        toggleSlavesToState(root, toggleGroupName, targetState);\r\n    };\r\n\r\n    /**\r\n     * Toggles the slave checkboxes from the masters.\r\n     *\r\n     * @param {HTMLElement} root\r\n     * @param {String} toggleGroupName\r\n     */\r\n    var updateSlavesFromMasterState = function(root, toggleGroupName) {\r\n        // Normalise to jQuery Object.\r\n        root = $(root);\r\n\r\n        var target = getControlCheckboxes(root, toggleGroupName, false);\r\n        var targetState;\r\n        if (target.is(':checkbox')) {\r\n            targetState = target.is(':checked');\r\n        } else {\r\n            targetState = target.data('checkall') === 1;\r\n        }\r\n\r\n        toggleSlavesToState(root, toggleGroupName, targetState);\r\n    };\r\n\r\n    /**\r\n     * Toggles the master checkboxes and action elements in a given toggle group.\r\n     *\r\n     * @param {jQuery} root The root jQuery element.\r\n     * @param {String} toggleGroupName The name of the toggle group\r\n     */\r\n    var toggleMastersAndActionElements = function(root, toggleGroupName) {\r\n        var toggleGroupSlaves = getAllSlaveCheckboxes(root, toggleGroupName);\r\n        if (toggleGroupSlaves.length > 0) {\r\n            var toggleGroupCheckedSlaves = toggleGroupSlaves.filter(':checked');\r\n            var targetState = toggleGroupSlaves.length === toggleGroupCheckedSlaves.length;\r\n\r\n            // Make sure to toggle the exact master checkbox in the given toggle group.\r\n            setMasterStates(root, toggleGroupName, targetState, true);\r\n            // Enable the action elements if there's at least one checkbox checked in the given toggle group.\r\n            // Disable otherwise.\r\n            setActionElementStates(root, toggleGroupName, !toggleGroupCheckedSlaves.length);\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Returns an array containing every toggle group level of a given toggle group.\r\n     *\r\n     * @param {String} toggleGroupName The name of the toggle group\r\n     * @return {Array} toggleGroupLevels Array that contains every toggle group level of a given toggle group\r\n     */\r\n    var getToggleGroupLevels = function(toggleGroupName) {\r\n        var toggleGroups = toggleGroupName.split(' ');\r\n        var toggleGroupLevels = [];\r\n        var toggleGroupLevel = '';\r\n\r\n        toggleGroups.forEach(function(toggleGroupName) {\r\n            toggleGroupLevel += ' ' + toggleGroupName;\r\n            toggleGroupLevels.push(toggleGroupLevel.trim());\r\n        });\r\n\r\n        return toggleGroupLevels;\r\n    };\r\n\r\n    /**\r\n     * Toggles the slave checkboxes to a specific state.\r\n     *\r\n     * @param {HTMLElement} root\r\n     * @param {String} toggleGroupName\r\n     * @param {Bool} targetState\r\n     */\r\n    var toggleSlavesToState = function(root, toggleGroupName, targetState) {\r\n        var slaves = getAllSlaveCheckboxes(root, toggleGroupName);\r\n        // Set the slave checkboxes from the masters and manually trigger the native 'change' event.\r\n        slaves.prop('checked', targetState).trigger('change');\r\n        // Get all checked slaves after the change of state.\r\n        var checkedSlaves = slaves.filter(':checked');\r\n\r\n        // Toggle the master checkbox in the given toggle group.\r\n        setMasterStates(root, toggleGroupName, targetState, false);\r\n        // Enable the action elements if there's at least one checkbox checked in the given toggle group. Disable otherwise.\r\n        setActionElementStates(root, toggleGroupName, !checkedSlaves.length);\r\n\r\n        // Get all toggle group levels and toggle accordingly all parent master checkboxes and action elements from each\r\n        // level. Exclude the given toggle group (toggleGroupName) as the master checkboxes and action elements from this\r\n        // level have been already toggled.\r\n        var toggleGroupLevels = getToggleGroupLevels(toggleGroupName)\r\n            .filter(toggleGroupLevel => toggleGroupLevel !== toggleGroupName);\r\n\r\n        toggleGroupLevels.forEach(function(toggleGroupLevel) {\r\n            // Toggle the master checkboxes action elements in the given toggle group level.\r\n            toggleMastersAndActionElements(root, toggleGroupLevel);\r\n        });\r\n\r\n        PubSub.publish(events.checkboxToggled, {\r\n            root: root,\r\n            toggleGroupName: toggleGroupName,\r\n            slaves: slaves,\r\n            checkedSlaves: checkedSlaves,\r\n            anyChecked: targetState,\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Set the state for an entire group of checkboxes.\r\n     *\r\n     * @param {HTMLElement} root\r\n     * @param {String} toggleGroupName\r\n     * @param {Bool} targetState\r\n     */\r\n    var setGroupState = function(root, toggleGroupName, targetState) {\r\n        // Normalise to jQuery Object.\r\n        root = $(root);\r\n\r\n        // Set the master and slaves.\r\n        setMasterStates(root, toggleGroupName, targetState, true);\r\n        toggleSlavesToState(root, toggleGroupName, targetState);\r\n    };\r\n\r\n    /**\r\n     * Toggles the master checkboxes in a given toggle group when all or none of the slave checkboxes in the same toggle group\r\n     * have been selected.\r\n     *\r\n     * @private\r\n     * @param {Object} e The event object.\r\n     */\r\n    var toggleMastersFromSlaves = function(e) {\r\n        var root = e.data.root;\r\n        var target = $(e.target);\r\n        var toggleGroupName = target.data('togglegroup');\r\n        var slaves = getAllSlaveCheckboxes(root, toggleGroupName);\r\n        var checkedSlaves = slaves.filter(':checked');\r\n\r\n        // Get all toggle group levels for the given toggle group and toggle accordingly all master checkboxes\r\n        // and action elements from each level.\r\n        var toggleGroupLevels = getToggleGroupLevels(toggleGroupName);\r\n        toggleGroupLevels.forEach(function(toggleGroupLevel) {\r\n            // Toggle the master checkboxes action elements in the given toggle group level.\r\n            toggleMastersAndActionElements(root, toggleGroupLevel);\r\n        });\r\n\r\n        PubSub.publish(events.checkboxToggled, {\r\n            root: root,\r\n            toggleGroupName: toggleGroupName,\r\n            slaves: slaves,\r\n            checkedSlaves: checkedSlaves,\r\n            anyChecked: !!checkedSlaves.length,\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Enables or disables the action elements.\r\n     *\r\n     * @private\r\n     * @param {jQuery} root The root jQuery element.\r\n     * @param {string} toggleGroupName The toggle group name of the action element(s).\r\n     * @param {boolean} disableActionElements Whether to disable or to enable the action elements.\r\n     */\r\n    var setActionElementStates = function(root, toggleGroupName, disableActionElements) {\r\n        getActionElements(root, toggleGroupName).prop('disabled', disableActionElements);\r\n    };\r\n\r\n    /**\r\n     * Selects or deselects the master elements.\r\n     *\r\n     * @private\r\n     * @param {jQuery} root The root jQuery element.\r\n     * @param {string} toggleGroupName The toggle group name of the master element(s).\r\n     * @param {boolean} targetState Whether to select (true) or deselect (false).\r\n     * @param {boolean} exactMatch Whether to do an exact match for the toggle group name or not.\r\n     */\r\n    var setMasterStates = function(root, toggleGroupName, targetState, exactMatch) {\r\n        // Set the master checkboxes value and ARIA labels..\r\n        var masters = getControlCheckboxes(root, toggleGroupName, exactMatch);\r\n        masters.prop('checked', targetState);\r\n        masters.each(function(i, masterElement) {\r\n            masterElement = $(masterElement);\r\n\r\n            var targetString;\r\n            if (targetState) {\r\n                targetString = masterElement.data('toggle-deselectall');\r\n            } else {\r\n                targetString = masterElement.data('toggle-selectall');\r\n            }\r\n\r\n            if (masterElement.is(':checkbox')) {\r\n                var masterLabel = root.find('[for=\"' + masterElement.attr('id') + '\"]');\r\n                if (masterLabel.length) {\r\n                    if (masterLabel.html() !== targetString) {\r\n                        masterLabel.html(targetString);\r\n                    }\r\n                }\r\n            } else {\r\n                masterElement.text(targetString);\r\n                // Set the checkall data attribute.\r\n                masterElement.data('checkall', targetState ? 0 : 1);\r\n            }\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Registers the event listeners.\r\n     *\r\n     * @private\r\n     */\r\n    var registerListeners = function() {\r\n        if (!registered) {\r\n            registered = true;\r\n\r\n            var root = $(document.body);\r\n            root.on('click', '[data-action=\"toggle\"][data-toggle=\"master\"]', {root: root}, toggleSlavesFromMasters);\r\n            root.on('click', '[data-action=\"toggle\"][data-toggle=\"slave\"]', {root: root}, toggleMastersFromSlaves);\r\n        }\r\n    };\r\n\r\n    return {\r\n        init: function() {\r\n            registerListeners();\r\n        },\r\n        events: events,\r\n        setGroupState: setGroupState,\r\n        updateSlavesFromMasterState: updateSlavesFromMasterState,\r\n    };\r\n});\r\n"],"names":["define","$","PubSub","registered","events","checkboxToggled","getToggleGroupElements","root","toggleGroup","exactMatch","find","getAllSlaveCheckboxes","filter","getControlCheckboxes","toggleSlavesFromMasters","e","targetState","data","target","toggleGroupName","is","toggleSlavesToState","toggleMastersAndActionElements","toggleGroupSlaves","length","toggleGroupCheckedSlaves","setMasterStates","setActionElementStates","getToggleGroupLevels","toggleGroups","split","toggleGroupLevels","toggleGroupLevel","forEach","push","trim","slaves","prop","trigger","checkedSlaves","publish","anyChecked","toggleMastersFromSlaves","disableActionElements","getActionElements","masters","each","i","masterElement","targetString","masterLabel","attr","html","text","init","document","body","on","registerListeners","setGroupState","updateSlavesFromMasterState"],"mappings":"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"}