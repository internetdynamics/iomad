{"version":3,"file":"link.min.js","sources":["../src/link.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Link helper for Tiny Link plugin.\r\n *\r\n * @module      tiny_link/link\r\n * @copyright   2023 Huong Nguyen <huongnv13@gmail.com>\r\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport Templates from 'core/templates';\r\nimport Pending from 'core/pending';\r\nimport Selectors from 'tiny_link/selectors';\r\n\r\n/**\r\n * Handle insertion of a new link, or update of an existing one.\r\n *\r\n * @param {Element} currentForm\r\n * @param {TinyMCE} editor\r\n */\r\nexport const setLink = (currentForm, editor) => {\r\n    const input = currentForm.querySelector(Selectors.elements.urlEntry);\r\n    let value = input.value;\r\n\r\n    if (value !== '') {\r\n        const pendingPromise = new Pending('tiny_link/setLink');\r\n        // We add a prefix if it is not already prefixed.\r\n        value = value.trim();\r\n        const expr = new RegExp(/^[a-zA-Z]*\\.*\\/|^#|^[a-zA-Z]*:/);\r\n        if (!expr.test(value)) {\r\n            value = 'http://' + value;\r\n        }\r\n\r\n        // Add the link.\r\n        setLinkOnSelection(currentForm, editor, value).then(pendingPromise.resolve);\r\n    }\r\n};\r\n\r\n/**\r\n * Handle unlink of a link\r\n *\r\n * @param {TinyMCE} editor\r\n */\r\nexport const unSetLink = (editor) => {\r\n    if (editor.hasPlugin('rtc', true)) {\r\n        editor.execCommand('unlink');\r\n    } else {\r\n        const dom = editor.dom;\r\n        const selection = editor.selection;\r\n        const bookmark = selection.getBookmark();\r\n        const rng = selection.getRng().cloneRange();\r\n        const startAnchorElm = dom.getParent(rng.startContainer, 'a[href]', editor.getBody());\r\n        const endAnchorElm = dom.getParent(rng.endContainer, 'a[href]', editor.getBody());\r\n        if (startAnchorElm) {\r\n            rng.setStartBefore(startAnchorElm);\r\n        }\r\n        if (endAnchorElm) {\r\n            rng.setEndAfter(endAnchorElm);\r\n        }\r\n        selection.setRng(rng);\r\n        editor.execCommand('unlink');\r\n        selection.moveToBookmark(bookmark);\r\n    }\r\n};\r\n\r\n/**\r\n * Final step setting the anchor on the selection.\r\n *\r\n * @param {Element} currentForm\r\n * @param {TinyMCE} editor\r\n * @param {String} url URL the link will point to.\r\n */\r\nconst setLinkOnSelection = async(currentForm, editor, url) => {\r\n    const urlText = currentForm.querySelector(Selectors.elements.urlText);\r\n    const target = currentForm.querySelector(Selectors.elements.openInNewWindow);\r\n    let textToDisplay = urlText.value.replace(/(<([^>]+)>)/gi, \"\").trim();\r\n\r\n    if (textToDisplay === '') {\r\n        textToDisplay = url;\r\n    }\r\n\r\n    const context = {\r\n        url: url,\r\n        newwindow: target.checked,\r\n    };\r\n    if (urlText.getAttribute('data-link-on-element')) {\r\n        context.title = textToDisplay;\r\n        context.name = editor.selection.getNode().outerHTML;\r\n    } else {\r\n        context.name = textToDisplay;\r\n    }\r\n    const {html} = await Templates.renderForPromise('tiny_link/embed_link', context);\r\n    const currentLink = getSelectedLink(editor);\r\n    if (currentLink) {\r\n        currentLink.outerHTML = html;\r\n    } else {\r\n        editor.insertContent(html);\r\n    }\r\n};\r\n\r\n/**\r\n * Get current link data.\r\n *\r\n * @param {TinyMCE} editor\r\n * @returns {{}}\r\n */\r\nexport const getCurrentLinkData = (editor) => {\r\n    let properties = {};\r\n    const link = getSelectedLink(editor);\r\n    if (link) {\r\n        const url = link.getAttribute('href');\r\n        const target = link.getAttribute('target');\r\n        const textToDisplay = link.innerText;\r\n        const title = link.getAttribute('title');\r\n\r\n        if (url !== '') {\r\n            properties.url = url;\r\n        }\r\n        if (target === '_blank') {\r\n            properties.newwindow = true;\r\n        }\r\n        if (title && title !== '') {\r\n            properties.urltext = title.trim();\r\n        } else if (textToDisplay !== '') {\r\n            properties.urltext = textToDisplay.trim();\r\n        }\r\n    } else {\r\n        // Check if the user is selecting some text before clicking on the Link button.\r\n        const selectedNode = editor.selection.getNode();\r\n        if (selectedNode) {\r\n            const textToDisplay = getTextSelection(editor);\r\n            if (textToDisplay !== '') {\r\n                properties.urltext = textToDisplay.trim();\r\n                properties.hasTextToDisplay = true;\r\n                properties.hasPlainTextSelected = true;\r\n            } else {\r\n                if (selectedNode.getAttribute('data-mce-selected')) {\r\n                    properties.setLinkOnElement = true;\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    return properties;\r\n};\r\n\r\n/**\r\n * Get selected link.\r\n *\r\n * @param {TinyMCE} editor\r\n * @returns {Element}\r\n */\r\nconst getSelectedLink = (editor) => {\r\n    return getAnchorElement(editor);\r\n};\r\n\r\n/**\r\n * Get anchor element.\r\n *\r\n * @param {TinyMCE} editor\r\n * @param {Element} selectedElm\r\n * @returns {Element}\r\n */\r\nconst getAnchorElement = (editor, selectedElm) => {\r\n    selectedElm = selectedElm || editor.selection.getNode();\r\n    return editor.dom.getParent(selectedElm, 'a[href]');\r\n};\r\n\r\n/**\r\n * Get only the selected text.\r\n * In some cases, window.getSelection() is not run as expected. We should only get the text value\r\n * For ex: <img src=\"\" alt=\"XYZ\">Some text here\r\n *          window.getSelection() will return XYZSome text here\r\n *\r\n * @param {TinyMCE} editor\r\n * @return {string} Selected text\r\n */\r\nconst getTextSelection = (editor) => {\r\n    let selText = '';\r\n    const sel = editor.selection.getSel();\r\n    const rangeCount = sel.rangeCount;\r\n    if (rangeCount) {\r\n        let rangeTexts = [];\r\n        for (let i = 0; i < rangeCount; ++i) {\r\n            rangeTexts.push('' + sel.getRangeAt(i));\r\n        }\r\n        selText = rangeTexts.join('');\r\n    }\r\n\r\n    return selText;\r\n};\r\n\r\n/**\r\n * Check the current selected element is an anchor or not.\r\n *\r\n * @param {TinyMCE} editor\r\n * @param {Element} selectedElm\r\n * @returns {boolean}\r\n */\r\nconst isInAnchor = (editor, selectedElm) => getAnchorElement(editor, selectedElm) !== null;\r\n\r\n/**\r\n * Change state of button.\r\n *\r\n * @param {TinyMCE} editor\r\n * @param {function()} toggler\r\n * @returns {function()}\r\n */\r\nconst toggleState = (editor, toggler) => {\r\n    editor.on('NodeChange', toggler);\r\n    return () => editor.off('NodeChange', toggler);\r\n};\r\n\r\n/**\r\n * Change the active state of button.\r\n *\r\n * @param {TinyMCE} editor\r\n * @returns {function(*): function(): *}\r\n */\r\nexport const toggleActiveState = (editor) => (api) => {\r\n    const updateState = () => api.setActive(!editor.mode.isReadOnly() && isInAnchor(editor, editor.selection.getNode()));\r\n    updateState();\r\n    return toggleState(editor, updateState);\r\n};\r\n"],"names":["currentForm","editor","value","querySelector","Selectors","elements","urlEntry","pendingPromise","Pending","trim","RegExp","test","setLinkOnSelection","then","resolve","hasPlugin","execCommand","dom","selection","bookmark","getBookmark","rng","getRng","cloneRange","startAnchorElm","getParent","startContainer","getBody","endAnchorElm","endContainer","setStartBefore","setEndAfter","setRng","moveToBookmark","async","url","urlText","target","openInNewWindow","textToDisplay","replace","context","newwindow","checked","getAttribute","title","name","getNode","outerHTML","html","Templates","renderForPromise","currentLink","getSelectedLink","insertContent","properties","link","innerText","urltext","selectedNode","getTextSelection","hasTextToDisplay","hasPlainTextSelected","setLinkOnElement","getAnchorElement","selectedElm","selText","sel","getSel","rangeCount","rangeTexts","i","push","getRangeAt","join","api","updateState","setActive","mode","isReadOnly","isInAnchor","toggler","on","off","toggleState"],"mappings":"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"}