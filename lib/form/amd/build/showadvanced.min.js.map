{"version":3,"file":"showadvanced.min.js","sources":["../src/showadvanced.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * A class to help show and hide advanced form content.\r\n *\r\n * @module     core_form/showadvanced\r\n * @copyright  2016 Damyon Wiese <damyon@moodle.com>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\ndefine(['jquery', 'core/log', 'core/str', 'core/notification'], function($, Log, Strings, Notification) {\r\n\r\n    var SELECTORS = {\r\n            FIELDSETCONTAINSADVANCED: 'fieldset.containsadvancedelements',\r\n            DIVFITEMADVANCED: 'div.fitem.advanced',\r\n            DIVADVANCEDSECTION: 'div#form-advanced-div',\r\n            DIVFCONTAINER: 'div.fcontainer',\r\n            MORELESSLINK: 'fieldset.containsadvancedelements .moreless-toggler'\r\n        },\r\n        CSS = {\r\n            SHOW: 'show',\r\n            MORELESSACTIONS: 'moreless-actions',\r\n            MORELESSTOGGLER: 'moreless-toggler',\r\n            SHOWLESS: 'moreless-less'\r\n        },\r\n        WRAPPERS = {\r\n            FITEM: '<div class=\"fitem\"></div>',\r\n            FELEMENT: '<div class=\"felement\"></div>',\r\n            ADVANCEDDIV: '<div id=\"form-advanced-div\"></div>'\r\n        },\r\n        IDPREFIX = 'showadvancedid-';\r\n\r\n    /** @property {Integer} uniqIdSeed Auto incrementing number used to generate ids. */\r\n    var uniqIdSeed = 0;\r\n\r\n    /**\r\n     * ShowAdvanced behaviour class.\r\n     *\r\n     * @class core_form/showadvanced\r\n     * @param {String} id The id of the form.\r\n     */\r\n    var ShowAdvanced = function(id) {\r\n        this.id = id;\r\n\r\n        var form = $(document.getElementById(id));\r\n        this.enhanceForm(form);\r\n    };\r\n\r\n    /** @property {String} id The form id to enhance. */\r\n    ShowAdvanced.prototype.id = '';\r\n\r\n    /**\r\n     * @method enhanceForm\r\n     * @param {JQuery} form JQuery selector representing the form\r\n     * @return {ShowAdvanced}\r\n     */\r\n    ShowAdvanced.prototype.enhanceForm = function(form) {\r\n        var fieldsets = form.find(SELECTORS.FIELDSETCONTAINSADVANCED);\r\n\r\n        // Enhance each fieldset in the form matching the selector.\r\n        fieldsets.each(function(index, item) {\r\n            this.enhanceFieldset($(item));\r\n        }.bind(this));\r\n\r\n        // Attach some event listeners.\r\n        // Subscribe more/less links to click event.\r\n        form.on('click', SELECTORS.MORELESSLINK, this.switchState);\r\n\r\n        // Subscribe to key events but filter for space or enter.\r\n        form.on('keydown', SELECTORS.MORELESSLINK, function(e) {\r\n            // Enter or space.\r\n            if (e.which == 13 || e.which == 32) {\r\n                return this.switchState(e);\r\n            }\r\n            return true;\r\n        }.bind(this));\r\n        return this;\r\n    };\r\n\r\n\r\n    /**\r\n     * Generates a uniq id for the dom element it's called on unless the element already has an id.\r\n     * The id is set on the dom node before being returned.\r\n     *\r\n     * @method generateId\r\n     * @param {JQuery} node JQuery selector representing a single DOM Node.\r\n     * @return {String}\r\n     */\r\n    ShowAdvanced.prototype.generateId = function(node) {\r\n        var id = node.prop('id');\r\n        if (typeof id === 'undefined') {\r\n            id = IDPREFIX + (uniqIdSeed++);\r\n            node.prop('id', id);\r\n        }\r\n        return id;\r\n    };\r\n\r\n    /**\r\n     * @method enhanceFieldset\r\n     * @param {JQuery} fieldset JQuery selector representing a fieldset\r\n     * @return {ShowAdvanced}\r\n     */\r\n    ShowAdvanced.prototype.enhanceFieldset = function(fieldset) {\r\n        var statuselement = $('input[name=mform_showmore_' + fieldset.prop('id') + ']');\r\n        if (!statuselement.length) {\r\n            Log.debug(\"M.form.showadvanced::processFieldset was called on an fieldset without a status field: '\" +\r\n                fieldset.prop('id') + \"'\");\r\n            return this;\r\n        }\r\n\r\n        // Fetch some strings.\r\n        Strings.get_strings([{\r\n            key: 'showmore',\r\n            component: 'core_form'\r\n        }, {\r\n            key: 'showless',\r\n            component: 'core_form'\r\n        }]).then(function(results) {\r\n            var showmore = results[0],\r\n                showless = results[1];\r\n\r\n            // Generate more/less links.\r\n            var morelesslink = $('<a href=\"#\"></a>');\r\n            morelesslink.addClass(CSS.MORELESSTOGGLER);\r\n            if (statuselement.val() === '0') {\r\n                morelesslink.html(showmore);\r\n                morelesslink.attr('aria-expanded', 'false');\r\n            } else {\r\n                morelesslink.html(showless);\r\n                morelesslink.attr('aria-expanded', 'true');\r\n                morelesslink.addClass(CSS.SHOWLESS);\r\n                fieldset.find(SELECTORS.DIVFITEMADVANCED).addClass(CSS.SHOW);\r\n            }\r\n            // Build a list of advanced fieldsets.\r\n            var idlist = [];\r\n            fieldset.find(SELECTORS.DIVFITEMADVANCED).each(function(index, node) {\r\n                idlist[idlist.length] = this.generateId($(node));\r\n            }.bind(this));\r\n\r\n            // Set aria attributes.\r\n            morelesslink.attr('role', 'button');\r\n            morelesslink.attr('aria-controls', 'form-advanced-div');\r\n\r\n            var formadvancedsection = $(WRAPPERS.ADVANCEDDIV);\r\n            fieldset.find(SELECTORS.DIVFITEMADVANCED).wrapAll(formadvancedsection);\r\n            // Add elements to the DOM.\r\n            var fitem = $(WRAPPERS.FITEM);\r\n            fitem.addClass(CSS.MORELESSACTIONS);\r\n            var felement = $(WRAPPERS.FELEMENT);\r\n            felement.append(morelesslink);\r\n            fitem.append(felement);\r\n\r\n            fieldset.find(SELECTORS.DIVADVANCEDSECTION).before(fitem);\r\n            return true;\r\n        }.bind(this)).fail(Notification.exception);\r\n\r\n        return this;\r\n    };\r\n\r\n    /**\r\n     * @method switchState\r\n     * @param {Event} e Event that triggered this action.\r\n     * @return {Boolean}\r\n     */\r\n    ShowAdvanced.prototype.switchState = function(e) {\r\n        e.preventDefault();\r\n\r\n        // Fetch some strings.\r\n        Strings.get_strings([{\r\n            key: 'showmore',\r\n            component: 'core_form'\r\n        }, {\r\n            key: 'showless',\r\n            component: 'core_form'\r\n        }]).then(function(results) {\r\n            var showmore = results[0],\r\n                showless = results[1],\r\n                fieldset = $(e.target).closest(SELECTORS.FIELDSETCONTAINSADVANCED);\r\n\r\n            // Toggle collapsed class.\r\n            fieldset.find(SELECTORS.DIVFITEMADVANCED).toggleClass(CSS.SHOW);\r\n\r\n            // Get corresponding hidden variable.\r\n            var statuselement = $('input[name=mform_showmore_' + fieldset.prop('id') + ']');\r\n\r\n            // Invert it and change the link text.\r\n            if (statuselement.val() === '0') {\r\n                statuselement.val(1);\r\n                $(e.target).addClass(CSS.SHOWLESS);\r\n                $(e.target).html(showless);\r\n                $(e.target).attr('aria-expanded', 'true');\r\n            } else {\r\n                statuselement.val(0);\r\n                $(e.target).removeClass(CSS.SHOWLESS);\r\n                $(e.target).html(showmore);\r\n                $(e.target).attr('aria-expanded', 'false');\r\n            }\r\n            return true;\r\n        }).fail(Notification.exception);\r\n\r\n        return this;\r\n    };\r\n\r\n    return {\r\n        /**\r\n         * Initialise this module.\r\n         * @method init\r\n         * @param {String} formid\r\n         * @return {ShowAdvanced}\r\n         */\r\n        init: function(formid) {\r\n            return new ShowAdvanced(formid);\r\n        }\r\n    };\r\n});\r\n"],"names":["define","$","Log","Strings","Notification","SELECTORS","CSS","WRAPPERS","uniqIdSeed","ShowAdvanced","id","form","document","getElementById","enhanceForm","prototype","find","each","index","item","enhanceFieldset","bind","this","on","switchState","e","which","generateId","node","prop","fieldset","statuselement","length","get_strings","key","component","then","results","showmore","showless","morelesslink","addClass","val","html","attr","idlist","formadvancedsection","wrapAll","fitem","felement","append","before","fail","exception","debug","preventDefault","target","closest","toggleClass","removeClass","init","formid"],"mappings":";;;;;;;AAsBAA,gCAAO,CAAC,SAAU,WAAY,WAAY,sBAAsB,SAASC,EAAGC,IAAKC,QAASC,kBAElFC,mCAC8B,oCAD9BA,2BAEsB,qBAFtBA,6BAGwB,wBAHxBA,uBAKkB,sDAElBC,SACU,OADVA,oBAEqB,mBAFrBA,oBAGqB,mBAHrBA,aAIc,gBAEdC,eACW,4BADXA,kBAEc,+BAFdA,qBAGiB,qCAKjBC,WAAa,EAQbC,aAAe,SAASC,SACnBA,GAAKA,OAENC,KAAOV,EAAEW,SAASC,eAAeH,UAChCI,YAAYH,cAIrBF,aAAaM,UAAUL,GAAK,GAO5BD,aAAaM,UAAUD,YAAc,SAASH,aAC1BA,KAAKK,KAAKX,oCAGhBY,KAAK,SAASC,MAAOC,WACtBC,gBAAgBnB,EAAEkB,QACzBE,KAAKC,OAIPX,KAAKY,GAAG,QAASlB,uBAAwBiB,KAAKE,aAG9Cb,KAAKY,GAAG,UAAWlB,uBAAwB,SAASoB,UAEjC,IAAXA,EAAEC,OAA0B,IAAXD,EAAEC,OACZJ,KAAKE,YAAYC,IAG9BJ,KAAKC,OACAA,MAYXb,aAAaM,UAAUY,WAAa,SAASC,UACrClB,GAAKkB,KAAKC,KAAK,kBACD,IAAPnB,KACPA,GA7DO,kBA6DUF,aACjBoB,KAAKC,KAAK,KAAMnB,KAEbA,IAQXD,aAAaM,UAAUK,gBAAkB,SAASU,cAC1CC,cAAgB9B,EAAE,6BAA+B6B,SAASD,KAAK,MAAQ,YACtEE,cAAcC,QAOnB7B,QAAQ8B,YAAY,CAAC,CACjBC,IAAK,WACLC,UAAW,aACZ,CACCD,IAAK,WACLC,UAAW,eACXC,KAAK,SAASC,aACVC,SAAWD,QAAQ,GACnBE,SAAWF,QAAQ,GAGnBG,aAAevC,EAAE,oBACrBuC,aAAaC,SAASnC,qBACM,MAAxByB,cAAcW,OACdF,aAAaG,KAAKL,UAClBE,aAAaI,KAAK,gBAAiB,WAEnCJ,aAAaG,KAAKJ,UAClBC,aAAaI,KAAK,gBAAiB,QACnCJ,aAAaC,SAASnC,cACtBwB,SAASd,KAAKX,4BAA4BoC,SAASnC,eAGnDuC,OAAS,GACbf,SAASd,KAAKX,4BAA4BY,KAAK,SAASC,MAAOU,MAC3DiB,OAAOA,OAAOb,QAAUV,KAAKK,WAAW1B,EAAE2B,QAC5CP,KAAKC,OAGPkB,aAAaI,KAAK,OAAQ,UAC1BJ,aAAaI,KAAK,gBAAiB,yBAE/BE,oBAAsB7C,EAAEM,sBAC5BuB,SAASd,KAAKX,4BAA4B0C,QAAQD,yBAE9CE,MAAQ/C,EAAEM,gBACdyC,MAAMP,SAASnC,yBACX2C,SAAWhD,EAAEM,0BACjB0C,SAASC,OAAOV,cAChBQ,MAAME,OAAOD,UAEbnB,SAASd,KAAKX,8BAA8B8C,OAAOH,QAC5C,GACT3B,KAAKC,OAAO8B,KAAKhD,aAAaiD,WAEzB/B,OAnDHpB,IAAIoD,MAAM,2FACNxB,SAASD,KAAK,MAAQ,KACnBP,OAyDfb,aAAaM,UAAUS,YAAc,SAASC,UAC1CA,EAAE8B,iBAGFpD,QAAQ8B,YAAY,CAAC,CACjBC,IAAK,WACLC,UAAW,aACZ,CACCD,IAAK,WACLC,UAAW,eACXC,MAAK,SAASC,aACVC,SAAWD,QAAQ,GACnBE,SAAWF,QAAQ,GACnBP,SAAW7B,EAAEwB,EAAE+B,QAAQC,QAAQpD,oCAGnCyB,SAASd,KAAKX,4BAA4BqD,YAAYpD,cAGlDyB,cAAgB9B,EAAE,6BAA+B6B,SAASD,KAAK,MAAQ,WAG/C,MAAxBE,cAAcW,OACdX,cAAcW,IAAI,GAClBzC,EAAEwB,EAAE+B,QAAQf,SAASnC,cACrBL,EAAEwB,EAAE+B,QAAQb,KAAKJ,UACjBtC,EAAEwB,EAAE+B,QAAQZ,KAAK,gBAAiB,UAElCb,cAAcW,IAAI,GAClBzC,EAAEwB,EAAE+B,QAAQG,YAAYrD,cACxBL,EAAEwB,EAAE+B,QAAQb,KAAKL,UACjBrC,EAAEwB,EAAE+B,QAAQZ,KAAK,gBAAiB,WAE/B,KACRQ,KAAKhD,aAAaiD,WAEd/B,MAGJ,CAOHsC,KAAM,SAASC,eACJ,IAAIpD,aAAaoD"}