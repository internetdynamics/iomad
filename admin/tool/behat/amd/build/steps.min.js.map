{"version":3,"file":"steps.min.js","sources":["../src/steps.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\nimport Ajax from 'core/ajax';\r\nimport Templates from 'core/templates';\r\nimport PendingJS from 'core/pending';\r\n\r\n/**\r\n * Enhancements for the step definitions page.\r\n *\r\n * @module tool_behat/steps\r\n * @copyright 2022 Catalyst IT EU\r\n * @author Mark Johnson <mark.johnson@catalyst-eu.net>\r\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\n/**\r\n * Call the get_entity_generator web service function\r\n *\r\n * Takes the name of an entity generator and returns an object containing a list of the required fields.\r\n *\r\n * @param {String} entityType\r\n * @returns {Promise}\r\n */\r\nconst getGeneratorEntities = (entityType) => Ajax.call([{\r\n    methodname: 'tool_behat_get_entity_generator',\r\n    args: {entitytype: entityType}\r\n}])[0];\r\n\r\n/**\r\n * Render HTML for required fields\r\n *\r\n * Takes the entity data returned from getGeneratorEntities and renders the HTML to display the required fields.\r\n *\r\n * @param {String} entityData\r\n * @return {Promise}\r\n */\r\nconst getRequiredFieldsContent = (entityData) => {\r\n    if (!entityData.required?.length) {\r\n        return Promise.resolve({\r\n            html: '',\r\n            js: ''\r\n        });\r\n    }\r\n    return Templates.renderForPromise('tool_behat/steprequiredfields', {fields: entityData.required});\r\n};\r\n\r\nexport const init = () => {\r\n    // When an entity is selected in the \"the following exist\" step, fetch and display the required fields.\r\n    document.addEventListener('change', async(e) => {\r\n        const entityElement = e.target.closest('.entities');\r\n        const stepElement = e.target.closest('.stepcontent');\r\n        if (!entityElement || !stepElement) {\r\n            return;\r\n        }\r\n\r\n        const pendingPromise = new PendingJS('tool_behat/steps:change');\r\n\r\n        const entityData = await getGeneratorEntities(e.target.value);\r\n        const {html, js} = await getRequiredFieldsContent(entityData);\r\n\r\n        const stepRequiredFields = stepElement.querySelector('.steprequiredfields');\r\n        if (stepRequiredFields) {\r\n            await Templates.replaceNode(stepRequiredFields, html, js);\r\n        } else {\r\n            await Templates.appendNodeContents(stepElement, html, js);\r\n        }\r\n        pendingPromise.resolve();\r\n    });\r\n};\r\n"],"names":["document","addEventListener","async","entityElement","e","target","closest","stepElement","pendingPromise","PendingJS","entityData","entityType","value","Ajax","call","methodname","args","entitytype","html","js","required","_entityData$required","length","Templates","renderForPromise","fields","Promise","resolve","getRequiredFieldsContent","stepRequiredFields","querySelector","replaceNode","appendNodeContents"],"mappings":";;;;;;;;4NA2DoB,KAEhBA,SAASC,iBAAiB,UAAUC,MAAAA,UAC1BC,cAAgBC,EAAEC,OAAOC,QAAQ,aACjCC,YAAcH,EAAEC,OAAOC,QAAQ,oBAChCH,gBAAkBI,yBAIjBC,eAAiB,IAAIC,iBAAU,2BAE/BC,iBAlCgBC,WAkCwBP,EAAEC,OAAOO,MAlClBC,cAAKC,KAAK,CAAC,CACpDC,WAAY,kCACZC,KAAM,CAACC,WAAYN,eACnB,IAH0BA,IAAAA,iBAmChBO,KAACA,KAADC,GAAOA,SAtBaT,CAAAA,0EACzBA,WAAWU,0CAAXC,qBAAqBC,OAMnBC,mBAAUC,iBAAiB,gCAAiC,CAACC,OAAQf,WAAWU,WAL5EM,QAAQC,QAAQ,CACnBT,KAAM,GACNC,GAAI,MAkBiBS,CAAyBlB,YAE5CmB,mBAAqBtB,YAAYuB,cAAc,uBACjDD,yBACMN,mBAAUQ,YAAYF,mBAAoBX,KAAMC,UAEhDI,mBAAUS,mBAAmBzB,YAAaW,KAAMC,IAE1DX,eAAemB"}