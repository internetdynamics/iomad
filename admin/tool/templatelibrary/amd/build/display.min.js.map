{"version":3,"file":"display.min.js","sources":["../src/display.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * This module adds ajax display functions to the template library page.\r\n *\r\n * @module     tool_templatelibrary/display\r\n * @copyright  2015 Damyon Wiese <damyon@moodle.com>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\ndefine(['jquery', 'core/ajax', 'core/log', 'core/notification', 'core/templates', 'core/config', 'core/str'],\r\n       function($, ajax, log, notification, templates, config, str) {\r\n\r\n    /**\r\n     * Search through a template for a template docs comment.\r\n     *\r\n     * @param {String} templateSource The raw template\r\n     * @param {String} templateName The name of the template used to search for docs tag\r\n     * @return {String|boolean} the correct comment or false\r\n     */\r\n    var findDocsSection = function(templateSource, templateName) {\r\n\r\n        if (!templateSource) {\r\n            return false;\r\n        }\r\n        // Find the comment section marked with @template component/template.\r\n        var marker = \"@template \" + templateName,\r\n            i = 0,\r\n            sections = [];\r\n\r\n        sections = templateSource.match(/{{!([\\s\\S]*?)}}/g);\r\n\r\n        // If no sections match - show the entire file.\r\n        if (sections !== null) {\r\n            for (i = 0; i < sections.length; i++) {\r\n                var section = sections[i];\r\n                var start = section.indexOf(marker);\r\n                if (start !== -1) {\r\n                    // Remove {{! and }} from start and end.\r\n                    var offset = start + marker.length + 1;\r\n                    section = section.substr(offset, section.length - 2 - offset);\r\n                    return section;\r\n                }\r\n            }\r\n        }\r\n        // No matching comment.\r\n        return false;\r\n    };\r\n\r\n    /**\r\n     * Handle a template loaded response.\r\n     *\r\n     * @param {String} templateName The template name\r\n     * @param {String} source The template source\r\n     * @param {String} originalSource The original template source (not theme overridden)\r\n     */\r\n    var templateLoaded = function(templateName, source, originalSource) {\r\n        str.get_string('templateselected', 'tool_templatelibrary', templateName).done(function(s) {\r\n            $('[data-region=\"displaytemplateheader\"]').text(s);\r\n        }).fail(notification.exception);\r\n\r\n        // Find the comment section marked with @template component/template.\r\n        var docs = findDocsSection(source, templateName);\r\n\r\n        if (docs === false) {\r\n            // Docs was not in theme template, try original.\r\n            docs = findDocsSection(originalSource, templateName);\r\n        }\r\n\r\n        // If we found a docs section, limit the template library to showing this section.\r\n        if (docs) {\r\n            source = docs;\r\n        }\r\n\r\n        $('[data-region=\"displaytemplatesource\"]').text(source);\r\n\r\n        // Now search the text for a json example.\r\n\r\n        var example = source.match(/Example context \\(json\\):([\\s\\S]*)/);\r\n        var context = false;\r\n        if (example) {\r\n            var rawJSON = example[1].trim();\r\n            try {\r\n                context = $.parseJSON(rawJSON);\r\n            } catch (e) {\r\n                log.debug('Could not parse json example context for template.');\r\n                log.debug(e);\r\n            }\r\n        }\r\n        if (context) {\r\n            templates.render(templateName, context).done(function(html, js) {\r\n                templates.replaceNodeContents($('[data-region=\"displaytemplateexample\"]'), html, js);\r\n            }).fail(notification.exception);\r\n        } else {\r\n            str.get_string('templatehasnoexample', 'tool_templatelibrary').done(function(s) {\r\n                $('[data-region=\"displaytemplateexample\"]').text(s);\r\n            }).fail(notification.exception);\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Load the a template source from Moodle.\r\n     *\r\n     * @param {String} templateName\r\n     */\r\n    var loadTemplate = function(templateName) {\r\n        var parts = templateName.split('/');\r\n        var component = parts.shift();\r\n        var name = parts.join('/');\r\n\r\n        var promises = ajax.call([{\r\n            methodname: 'core_output_load_template',\r\n            args: {\r\n                    component: component,\r\n                    template: name,\r\n                    themename: config.theme,\r\n                    includecomments: true\r\n            }\r\n        }, {\r\n            methodname: 'tool_templatelibrary_load_canonical_template',\r\n            args: {\r\n                    component: component,\r\n                    template: name\r\n            }\r\n        }], true, false);\r\n\r\n        // When returns a new promise that is resolved when all the passed in promises are resolved.\r\n        // The arguments to the done become the values of each resolved promise.\r\n        $.when.apply($, promises)\r\n            .done(function(source, originalSource) {\r\n              templateLoaded(templateName, source, originalSource);\r\n            })\r\n            .fail(notification.exception);\r\n    };\r\n\r\n    // Add the event listeners.\r\n    $('[data-region=\"list-templates\"]').on('click', '[data-templatename]', function(e) {\r\n        var templatename = $(this).data('templatename');\r\n        e.preventDefault();\r\n        loadTemplate(templatename);\r\n    });\r\n\r\n    // This module does not expose anything.\r\n    return {};\r\n});\r\n"],"names":["define","$","ajax","log","notification","templates","config","str","findDocsSection","templateSource","templateName","sections","marker","i","match","length","section","start","indexOf","offset","substr","loadTemplate","parts","split","component","shift","name","join","promises","call","methodname","args","template","themename","theme","includecomments","when","apply","done","source","originalSource","get_string","s","text","fail","exception","docs","example","context","rawJSON","trim","parseJSON","e","debug","render","html","js","replaceNodeContents","templateLoaded","on","templatename","this","data","preventDefault"],"mappings":";;;;;;;AAsBAA,sCAAO,CAAC,SAAU,YAAa,WAAY,oBAAqB,iBAAkB,cAAe,aAC1F,SAASC,EAAGC,KAAMC,IAAKC,aAAcC,UAAWC,OAAQC,SASvDC,gBAAkB,SAASC,eAAgBC,kBAEtCD,sBACM,MAKPE,SAFAC,OAAS,aAAeF,aACxBG,EAAI,KAMS,QAHjBF,SAAWF,eAAeK,MAAM,yBAIvBD,EAAI,EAAGA,EAAIF,SAASI,OAAQF,IAAK,KAC9BG,QAAUL,SAASE,GACnBI,MAAQD,QAAQE,QAAQN,YACb,IAAXK,MAAc,KAEVE,OAASF,MAAQL,OAAOG,OAAS,SACrCC,QAAUA,QAAQI,OAAOD,OAAQH,QAAQD,OAAS,EAAII,gBAM3D,GA2DPE,aAAe,SAASX,kBACpBY,MAAQZ,aAAaa,MAAM,KAC3BC,UAAYF,MAAMG,QAClBC,KAAOJ,MAAMK,KAAK,KAElBC,SAAW1B,KAAK2B,KAAK,CAAC,CACtBC,WAAY,4BACZC,KAAM,CACEP,UAAWA,UACXQ,SAAUN,KACVO,UAAW3B,OAAO4B,MAClBC,iBAAiB,IAE1B,CACCL,WAAY,+CACZC,KAAM,CACEP,UAAWA,UACXQ,SAAUN,SAElB,GAAM,GAIVzB,EAAEmC,KAAKC,MAAMpC,EAAG2B,UACXU,MAAK,SAASC,OAAQC,iBAzEV,SAAS9B,aAAc6B,OAAQC,gBAChDjC,IAAIkC,WAAW,mBAAoB,uBAAwB/B,cAAc4B,MAAK,SAASI,GACnFzC,EAAE,yCAAyC0C,KAAKD,MACjDE,KAAKxC,aAAayC,eAGjBC,KAAOtC,gBAAgB+B,OAAQ7B,eAEtB,IAAToC,OAEAA,KAAOtC,gBAAgBgC,eAAgB9B,eAIvCoC,OACAP,OAASO,MAGb7C,EAAE,yCAAyC0C,KAAKJ,YAI5CQ,QAAUR,OAAOzB,MAAM,sCACvBkC,SAAU,KACVD,QAAS,KACLE,QAAUF,QAAQ,GAAGG,WAErBF,QAAU/C,EAAEkD,UAAUF,SACxB,MAAOG,GACLjD,IAAIkD,MAAM,sDACVlD,IAAIkD,MAAMD,IAGdJ,QACA3C,UAAUiD,OAAO5C,aAAcsC,SAASV,MAAK,SAASiB,KAAMC,IACxDnD,UAAUoD,oBAAoBxD,EAAE,0CAA2CsD,KAAMC,OAClFZ,KAAKxC,aAAayC,WAErBtC,IAAIkC,WAAW,uBAAwB,wBAAwBH,MAAK,SAASI,GACzEzC,EAAE,0CAA0C0C,KAAKD,MAClDE,KAAKxC,aAAayC,WAkCnBa,CAAehD,aAAc6B,OAAQC,mBAEtCI,KAAKxC,aAAayC,mBAI3B5C,EAAE,kCAAkC0D,GAAG,QAAS,uBAAuB,SAASP,OACxEQ,aAAe3D,EAAE4D,MAAMC,KAAK,gBAChCV,EAAEW,iBACF1C,aAAauC,iBAIV"}