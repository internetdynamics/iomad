{"version":3,"file":"select_page.min.js","sources":["../src/select_page.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * When returning to Moodle let the user select which course to add the resource to.\r\n *\r\n * @module     tool_moodlenet/select_page\r\n * @copyright  2020 Mathew May <mathew.solutions>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\ndefine([\r\n    'core/ajax',\r\n    'core/templates',\r\n    'tool_moodlenet/selectors',\r\n    'core/notification'\r\n], function(\r\n    Ajax,\r\n    Templates,\r\n    Selectors,\r\n    Notification\r\n) {\r\n    /**\r\n     * @var {string} The id corresponding to the import.\r\n     */\r\n    var importId;\r\n\r\n    /**\r\n     * Set up the page.\r\n     *\r\n     * @method init\r\n     * @param {string} importIdString the string ID of the import.\r\n     */\r\n    var init = function(importIdString) {\r\n        importId = importIdString;\r\n        var page = document.querySelector(Selectors.region.selectPage);\r\n        registerListenerEvents(page);\r\n        addCourses(page);\r\n    };\r\n\r\n    /**\r\n     * Renders the 'no-courses' template.\r\n     *\r\n     * @param {HTMLElement} areaReplace the DOM node to replace.\r\n     * @returns {Promise}\r\n     */\r\n    var renderNoCourses = function(areaReplace) {\r\n        return Templates.renderPix('courses', 'tool_moodlenet').then(function(img) {\r\n            return img;\r\n        }).then(function(img) {\r\n            var temp = document.createElement('div');\r\n            temp.innerHTML = img.trim();\r\n            return Templates.render('core_course/no-courses', {\r\n                nocoursesimg: temp.firstChild.src\r\n            });\r\n        }).then(function(html, js) {\r\n            Templates.replaceNodeContents(areaReplace, html, js);\r\n            areaReplace.classList.add('mx-auto');\r\n            areaReplace.classList.add('w-25');\r\n            return;\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Render the course cards for those supplied courses.\r\n     *\r\n     * @param {HTMLElement} areaReplace the DOM node to replace.\r\n     * @param {Array<courses>} courses the courses to render.\r\n     * @returns {Promise}\r\n     */\r\n    var renderCourses = function(areaReplace, courses) {\r\n        return Templates.render('tool_moodlenet/view-cards', {\r\n            courses: courses\r\n        }).then(function(html, js) {\r\n            Templates.replaceNodeContents(areaReplace, html, js);\r\n            areaReplace.classList.remove('mx-auto');\r\n            areaReplace.classList.remove('w-25');\r\n            return;\r\n        });\r\n    };\r\n\r\n    /**\r\n     * For a given input, the page & what to replace fetch courses and manage icons too.\r\n     *\r\n     * @method searchCourses\r\n     * @param {string} inputValue What to search for\r\n     * @param {HTMLElement} page The whole page element for our page\r\n     * @param {HTMLElement} areaReplace The Element to replace the contents of\r\n     */\r\n    var searchCourses = function(inputValue, page, areaReplace) {\r\n        var searchIcon = page.querySelector(Selectors.region.searchIcon);\r\n        var clearIcon = page.querySelector(Selectors.region.clearIcon);\r\n\r\n        if (inputValue !== '') {\r\n            searchIcon.classList.add('d-none');\r\n            clearIcon.parentElement.classList.remove('d-none');\r\n        } else {\r\n            searchIcon.classList.remove('d-none');\r\n            clearIcon.parentElement.classList.add('d-none');\r\n        }\r\n        var args = {\r\n            searchvalue: inputValue,\r\n        };\r\n        Ajax.call([{\r\n            methodname: 'tool_moodlenet_search_courses',\r\n            args: args\r\n        }])[0].then(function(result) {\r\n            if (result.courses.length === 0) {\r\n                return renderNoCourses(areaReplace);\r\n            } else {\r\n                // Add the importId to the course link\r\n                result.courses.forEach(function(course) {\r\n                    course.viewurl += '&id=' + importId;\r\n                });\r\n                return renderCourses(areaReplace, result.courses);\r\n            }\r\n        }).catch(Notification.exception);\r\n    };\r\n\r\n    /**\r\n     * Add the event listeners to our page.\r\n     *\r\n     * @method registerListenerEvents\r\n     * @param {HTMLElement} page The whole page element for our page\r\n     */\r\n    var registerListenerEvents = function(page) {\r\n        var input = page.querySelector(Selectors.region.searchInput);\r\n        var courseArea = page.querySelector(Selectors.region.courses);\r\n        var clearIcon = page.querySelector(Selectors.region.clearIcon);\r\n        clearIcon.addEventListener('click', function() {\r\n            input.value = '';\r\n            searchCourses('', page, courseArea);\r\n        });\r\n\r\n        input.addEventListener('input', debounce(function() {\r\n            searchCourses(input.value, page, courseArea);\r\n        }, 300));\r\n    };\r\n\r\n    /**\r\n     * Fetch the courses to show the user. We use the same WS structure & template as the search for consistency.\r\n     *\r\n     * @method addCourses\r\n     * @param {HTMLElement} page The whole page element for our course page\r\n     */\r\n    var addCourses = function(page) {\r\n        var courseArea = page.querySelector(Selectors.region.courses);\r\n        searchCourses('', page, courseArea);\r\n    };\r\n\r\n    /**\r\n     * Define our own debounce function as Moodle 3.7 does not have it.\r\n     *\r\n     * @method debounce\r\n     * @from underscore.js\r\n     * @copyright 2009-2020 Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors\r\n     * @licence MIT\r\n     * @param {function} func The function we want to keep calling\r\n     * @param {number} wait Our timeout\r\n     * @param {boolean} immediate Do we want to apply the function immediately\r\n     * @return {function}\r\n     */\r\n    var debounce = function(func, wait, immediate) {\r\n        var timeout;\r\n        return function() {\r\n            var context = this;\r\n            var args = arguments;\r\n            var later = function() {\r\n                timeout = null;\r\n                if (!immediate) {\r\n                    func.apply(context, args);\r\n                }\r\n            };\r\n            var callNow = immediate && !timeout;\r\n            clearTimeout(timeout);\r\n            timeout = setTimeout(later, wait);\r\n            if (callNow) {\r\n                func.apply(context, args);\r\n            }\r\n        };\r\n    };\r\n    return {\r\n        init: init,\r\n    };\r\n});\r\n"],"names":["define","Ajax","Templates","Selectors","Notification","importId","searchCourses","inputValue","page","areaReplace","searchIcon","querySelector","region","clearIcon","classList","add","parentElement","remove","args","searchvalue","call","methodname","then","result","courses","length","renderPix","img","temp","document","createElement","innerHTML","trim","render","nocoursesimg","firstChild","src","html","js","replaceNodeContents","renderNoCourses","forEach","course","viewurl","renderCourses","catch","exception","registerListenerEvents","input","searchInput","courseArea","addEventListener","value","debounce","addCourses","func","wait","immediate","timeout","context","this","arguments","later","apply","callNow","clearTimeout","setTimeout","init","importIdString","selectPage"],"mappings":";;;;;;;AAuBAA,oCAAO,CACH,YACA,iBACA,2BACA,sBACD,SACCC,KACAC,UACAC,UACAC,kBAKIC,SAgEAC,cAAgB,SAASC,WAAYC,KAAMC,iBACvCC,WAAaF,KAAKG,cAAcR,UAAUS,OAAOF,YACjDG,UAAYL,KAAKG,cAAcR,UAAUS,OAAOC,WAEjC,KAAfN,YACAG,WAAWI,UAAUC,IAAI,UACzBF,UAAUG,cAAcF,UAAUG,OAAO,YAEzCP,WAAWI,UAAUG,OAAO,UAC5BJ,UAAUG,cAAcF,UAAUC,IAAI,eAEtCG,KAAO,CACPC,YAAaZ,YAEjBN,KAAKmB,KAAK,CAAC,CACPC,WAAY,gCACZH,KAAMA,QACN,GAAGI,MAAK,SAASC,eACa,IAA1BA,OAAOC,QAAQC,OA7DL,SAAShB,oBACpBP,UAAUwB,UAAU,UAAW,kBAAkBJ,MAAK,SAASK,YAC3DA,OACRL,MAAK,SAASK,SACTC,KAAOC,SAASC,cAAc,cAClCF,KAAKG,UAAYJ,IAAIK,OACd9B,UAAU+B,OAAO,yBAA0B,CAC9CC,aAAcN,KAAKO,WAAWC,SAEnCd,MAAK,SAASe,KAAMC,IACnBpC,UAAUqC,oBAAoB9B,YAAa4B,KAAMC,IACjD7B,YAAYK,UAAUC,IAAI,WAC1BN,YAAYK,UAAUC,IAAI,WAkDfyB,CAAgB/B,cAGvBc,OAAOC,QAAQiB,SAAQ,SAASC,QAC5BA,OAAOC,SAAW,OAAStC,YA1CvB,SAASI,YAAae,gBAC/BtB,UAAU+B,OAAO,4BAA6B,CACjDT,QAASA,UACVF,MAAK,SAASe,KAAMC,IACnBpC,UAAUqC,oBAAoB9B,YAAa4B,KAAMC,IACjD7B,YAAYK,UAAUG,OAAO,WAC7BR,YAAYK,UAAUG,OAAO,WAsClB2B,CAAcnC,YAAac,OAAOC,aAE9CqB,MAAMzC,aAAa0C,YAStBC,uBAAyB,SAASvC,UAC9BwC,MAAQxC,KAAKG,cAAcR,UAAUS,OAAOqC,aAC5CC,WAAa1C,KAAKG,cAAcR,UAAUS,OAAOY,SACrChB,KAAKG,cAAcR,UAAUS,OAAOC,WAC1CsC,iBAAiB,SAAS,WAChCH,MAAMI,MAAQ,GACd9C,cAAc,GAAIE,KAAM0C,eAG5BF,MAAMG,iBAAiB,QAASE,UAAS,WACrC/C,cAAc0C,MAAMI,MAAO5C,KAAM0C,cAClC,OASHI,WAAa,SAAS9C,UAClB0C,WAAa1C,KAAKG,cAAcR,UAAUS,OAAOY,SACrDlB,cAAc,GAAIE,KAAM0C,aAexBG,SAAW,SAASE,KAAMC,KAAMC,eAC5BC,eACG,eACCC,QAAUC,KACV1C,KAAO2C,UACPC,MAAQ,WACRJ,QAAU,KACLD,WACDF,KAAKQ,MAAMJ,QAASzC,OAGxB8C,QAAUP,YAAcC,QAC5BO,aAAaP,SACbA,QAAUQ,WAAWJ,MAAON,MACxBQ,SACAT,KAAKQ,MAAMJ,QAASzC,cAIzB,CACHiD,KArJO,SAASC,gBAChB/D,SAAW+D,mBACP5D,KAAOqB,SAASlB,cAAcR,UAAUS,OAAOyD,YACnDtB,uBAAuBvC,MACvB8C,WAAW9C"}