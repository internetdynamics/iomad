{"version":3,"file":"search.min.js","sources":["../src/search.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Interface to the Lunr search engines.\r\n *\r\n * @module     tool_componentlibrary/search\r\n * @copyright  2021 Bas Brands <bas@moodle.com>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport lunrJs from 'tool_componentlibrary/lunr';\r\nimport selectors from 'tool_componentlibrary/selectors';\r\nimport Log from 'core/log';\r\nimport Notification from 'core/notification';\r\nimport {enter, escape} from 'core/key_codes';\r\n\r\nlet lunrIndex = null;\r\nlet pagesIndex = null;\r\n\r\n/**\r\n * Get the jsonFile that is generated when the component library is build.\r\n *\r\n * @method\r\n * @private\r\n * @param {String} jsonFile the URL to the json file.\r\n * @return {Object}\r\n */\r\nconst fetchJson = async(jsonFile) => {\r\n    const response = await fetch(jsonFile);\r\n\r\n    if (!response.ok) {\r\n        Log.debug(`Error getting Hugo index file: ${response.status}`);\r\n    }\r\n\r\n    return await response.json();\r\n};\r\n\r\n/**\r\n * Initiate lunr on the data in the jsonFile and add the jsondata to the pagesIndex\r\n *\r\n * @method\r\n * @private\r\n * @param {String} jsonFile the URL to the json file.\r\n */\r\nconst initLunr = jsonFile => {\r\n    fetchJson(jsonFile).then(jsondata => {\r\n        pagesIndex = jsondata;\r\n        // Using an arrow function here will break lunr on compile.\r\n        lunrIndex = lunrJs(function() {\r\n            this.ref('uri');\r\n            this.field('title', {boost: 10});\r\n            this.field('content');\r\n            this.field('tags', {boost: 5});\r\n            jsondata.forEach(p => {\r\n                this.add(p);\r\n            });\r\n        });\r\n        return null;\r\n    }).catch(Notification.exception);\r\n};\r\n\r\n/**\r\n * Setup the eventlistener to listen on user input on the search field.\r\n *\r\n * @method\r\n * @private\r\n */\r\nconst initUI = () => {\r\n    const searchInput = document.querySelector(selectors.searchinput);\r\n    searchInput.addEventListener('keyup', e => {\r\n        const query = e.currentTarget.value;\r\n        if (query.length < 2) {\r\n            document.querySelector(selectors.dropdownmenu).classList.remove('show');\r\n            return;\r\n        }\r\n        renderResults(searchIndex(query));\r\n    });\r\n    searchInput.addEventListener('keydown', e => {\r\n        if (e.keyCode === enter) {\r\n            e.preventDefault();\r\n        }\r\n        if (e.keyCode === escape) {\r\n            searchInput.value = '';\r\n        }\r\n    });\r\n};\r\n\r\n/**\r\n * Trigger a search in lunr and transform the result.\r\n *\r\n * @method\r\n * @private\r\n * @param  {String} query\r\n * @return {Array} results\r\n */\r\nconst searchIndex = query => {\r\n    // Find the item in our index corresponding to the lunr one to have more info\r\n    // Lunr result:\r\n    //  {ref: \"/section/page1\", score: 0.2725657778206127}\r\n    // Our result:\r\n    //  {title:\"Page1\", href:\"/section/page1\", ...}\r\n\r\n    return lunrIndex.search(query + ' ' + query + '*').map(result => {\r\n        return pagesIndex.filter(page => {\r\n            return page.uri === result.ref;\r\n        })[0];\r\n    });\r\n};\r\n\r\n/**\r\n * Display the 10 first results\r\n *\r\n * @method\r\n * @private\r\n * @param {Array} results to display\r\n */\r\nconst renderResults = results => {\r\n    const dropdownMenu = document.querySelector(selectors.dropdownmenu);\r\n    if (!results.length) {\r\n        dropdownMenu.classList.remove('show');\r\n        return;\r\n    }\r\n\r\n    // Clear out the results.\r\n    dropdownMenu.innerHTML = '';\r\n\r\n    const baseUrl = M.cfg.wwwroot + '/admin/tool/componentlibrary/docspage.php';\r\n\r\n    // Only show the ten first results\r\n    results.slice(0, 10).forEach(function(result) {\r\n        const link = document.createElement(\"a\");\r\n        const chapter = result.uri.split('/')[1];\r\n        link.appendChild(document.createTextNode(`${chapter} > ${result.title}`));\r\n        link.classList.add('dropdown-item');\r\n        link.href = baseUrl + result.uri;\r\n\r\n        dropdownMenu.appendChild(link);\r\n    });\r\n\r\n    dropdownMenu.classList.add('show');\r\n};\r\n\r\n/**\r\n * Initialize module.\r\n *\r\n * @method\r\n * @param {String} jsonFile Full path to the search DB json file.\r\n */\r\nexport const search = jsonFile => {\r\n    initLunr(jsonFile);\r\n    initUI();\r\n};\r\n"],"names":["lunrIndex","pagesIndex","initLunr","jsonFile","async","response","fetch","ok","debug","status","json","fetchJson","then","jsondata","ref","field","boost","forEach","p","add","catch","Notification","exception","searchIndex","query","search","map","result","filter","page","uri","renderResults","results","dropdownMenu","document","querySelector","selectors","dropdownmenu","length","classList","remove","innerHTML","baseUrl","M","cfg","wwwroot","slice","link","createElement","chapter","split","appendChild","createTextNode","title","href","searchInput","searchinput","addEventListener","e","currentTarget","value","keyCode","enter","preventDefault","escape","initUI"],"mappings":";;;;;;;gQA6BIA,UAAY,KACZC,WAAa,WA2BXC,SAAWC,WAjBCC,OAAAA,iBACRC,eAAiBC,MAAMH,iBAExBE,SAASE,iBACNC,+CAAwCH,SAASI,eAG5CJ,SAASK,QAWtBC,CAAUR,UAAUS,MAAKC,WACrBZ,WAAaY,SAEbb,WAAY,kBAAO,gBACVc,IAAI,YACJC,MAAM,QAAS,CAACC,MAAO,UACvBD,MAAM,gBACNA,MAAM,OAAQ,CAACC,MAAO,IAC3BH,SAASI,SAAQC,SACRC,IAAID,SAGV,QACRE,MAAMC,sBAAaC,YAqCpBC,YAAcC,OAOTxB,UAAUyB,OAAOD,MAAQ,IAAMA,MAAQ,KAAKE,KAAIC,QAC5C1B,WAAW2B,QAAOC,MACdA,KAAKC,MAAQH,OAAOb,MAC5B,KAWLiB,cAAgBC,gBACZC,aAAeC,SAASC,cAAcC,mBAAUC,kBACjDL,QAAQM,mBACTL,aAAaM,UAAUC,OAAO,QAKlCP,aAAaQ,UAAY,SAEnBC,QAAUC,EAAEC,IAAIC,QAAU,4CAGhCb,QAAQc,MAAM,EAAG,IAAI7B,SAAQ,SAASU,cAC5BoB,KAAOb,SAASc,cAAc,KAC9BC,QAAUtB,OAAOG,IAAIoB,MAAM,KAAK,GACtCH,KAAKI,YAAYjB,SAASkB,yBAAkBH,sBAAatB,OAAO0B,SAChEN,KAAKR,UAAUpB,IAAI,iBACnB4B,KAAKO,KAAOZ,QAAUf,OAAOG,IAE7BG,aAAakB,YAAYJ,SAG7Bd,aAAaM,UAAUpB,IAAI,yBASThB,WAClBD,SAASC,UAlFE,YACLoD,YAAcrB,SAASC,cAAcC,mBAAUoB,aACrDD,YAAYE,iBAAiB,SAASC,UAC5BlC,MAAQkC,EAAEC,cAAcC,MAC1BpC,MAAMc,OAAS,EACfJ,SAASC,cAAcC,mBAAUC,cAAcE,UAAUC,OAAO,QAGpET,cAAcR,YAAYC,WAE9B+B,YAAYE,iBAAiB,WAAWC,IAChCA,EAAEG,UAAYC,kBACdJ,EAAEK,iBAEFL,EAAEG,UAAYG,oBACdT,YAAYK,MAAQ,QAoE5BK"}