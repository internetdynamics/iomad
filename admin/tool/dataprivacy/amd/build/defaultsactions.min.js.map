{"version":3,"file":"defaultsactions.min.js","sources":["../src/defaultsactions.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * AMD module for data registry defaults actions.\r\n *\r\n * @module     tool_dataprivacy/defaultsactions\r\n * @copyright  2018 Jun Pataleta\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\ndefine([\r\n    'jquery',\r\n    'core/ajax',\r\n    'core/notification',\r\n    'core/str',\r\n    'core/modal_factory',\r\n    'core/modal_events',\r\n    'core/templates'],\r\nfunction($, Ajax, Notification, Str, ModalFactory, ModalEvents, Templates) {\r\n\r\n    /**\r\n     * List of action selectors.\r\n     *\r\n     * @type {{EDIT_LEVEL_DEFAULTS: string}}\r\n     * @type {{NEW_ACTIVITY_DEFAULTS: string}}\r\n     * @type {{EDIT_ACTIVITY_DEFAULTS: string}}\r\n     * @type {{DELETE_ACTIVITY_DEFAULTS: string}}\r\n     */\r\n    var ACTIONS = {\r\n        EDIT_LEVEL_DEFAULTS: '[data-action=\"edit-level-defaults\"]',\r\n        NEW_ACTIVITY_DEFAULTS: '[data-action=\"new-activity-defaults\"]',\r\n        EDIT_ACTIVITY_DEFAULTS: '[data-action=\"edit-activity-defaults\"]',\r\n        DELETE_ACTIVITY_DEFAULTS: '[data-action=\"delete-activity-defaults\"]'\r\n    };\r\n\r\n    /** @type {{INHERIT: Number}} **/\r\n    var INHERIT = -1;\r\n\r\n    /**\r\n     * DefaultsActions class.\r\n     */\r\n    var DefaultsActions = function() {\r\n        this.registerEvents();\r\n    };\r\n\r\n    /**\r\n     * Register event listeners.\r\n     */\r\n    DefaultsActions.prototype.registerEvents = function() {\r\n        $(ACTIONS.EDIT_LEVEL_DEFAULTS).click(function(e) {\r\n            e.preventDefault();\r\n\r\n            var button = $(this);\r\n            var contextLevel = button.data('contextlevel');\r\n            var category = button.data('category');\r\n            var purpose = button.data('purpose');\r\n\r\n            // Get options.\r\n            var requests = [\r\n                {methodname: 'tool_dataprivacy_get_category_options', args: {}},\r\n                {methodname: 'tool_dataprivacy_get_purpose_options', args: {}}\r\n            ];\r\n\r\n            var promises = Ajax.call(requests);\r\n            var titlePromise = Str.get_string('editdefaults', 'tool_dataprivacy', $('#defaults-header').text());\r\n            $.when(promises[0], promises[1], titlePromise).then(function(categoryResponse, purposeResponse, title) {\r\n                var categories = categoryResponse.options;\r\n                var purposes = purposeResponse.options;\r\n                showDefaultsFormModal(title, contextLevel, category, purpose, null, categories, purposes, null);\r\n\r\n                return true;\r\n            }).catch(Notification.exception);\r\n        });\r\n\r\n        $(ACTIONS.NEW_ACTIVITY_DEFAULTS).click(function(e) {\r\n            e.preventDefault();\r\n\r\n            var button = $(this);\r\n            var contextLevel = button.data('contextlevel');\r\n\r\n            // Get options.\r\n            var requests = [\r\n                {methodname: 'tool_dataprivacy_get_category_options', args: {}},\r\n                {methodname: 'tool_dataprivacy_get_purpose_options', args: {}},\r\n                {methodname: 'tool_dataprivacy_get_activity_options', args: {'nodefaults': true}}\r\n            ];\r\n\r\n            var promises = Ajax.call(requests);\r\n            var titlePromise = Str.get_string('addnewdefaults', 'tool_dataprivacy');\r\n\r\n            $.when(promises[0], promises[1], promises[2], titlePromise).then(\r\n                function(categoryResponse, purposeResponse, activityResponse, title) {\r\n                    var categories = categoryResponse.options;\r\n                    var purposes = purposeResponse.options;\r\n                    var activities = activityResponse.options;\r\n\r\n                    showDefaultsFormModal(title, contextLevel, null, null, null, categories, purposes, activities);\r\n\r\n                    return true;\r\n\r\n                }).catch(Notification.exception);\r\n            }\r\n        );\r\n\r\n        $(ACTIONS.EDIT_ACTIVITY_DEFAULTS).click(function(e) {\r\n            e.preventDefault();\r\n\r\n            var button = $(this);\r\n            var contextLevel = button.data('contextlevel');\r\n            var category = button.data('category');\r\n            var purpose = button.data('purpose');\r\n            var activity = button.data('activityname');\r\n\r\n            // Get options.\r\n            var requests = [\r\n                {methodname: 'tool_dataprivacy_get_category_options', args: {}},\r\n                {methodname: 'tool_dataprivacy_get_purpose_options', args: {}},\r\n                {methodname: 'tool_dataprivacy_get_activity_options', args: {}}\r\n            ];\r\n\r\n            var promises = Ajax.call(requests);\r\n            var titlePromise = Str.get_string('editmoduledefaults', 'tool_dataprivacy');\r\n\r\n            $.when(promises[0], promises[1], promises[2], titlePromise).then(\r\n                function(categoryResponse, purposeResponse, activityResponse, title) {\r\n                    var categories = categoryResponse.options;\r\n                    var purposes = purposeResponse.options;\r\n                    var activities = activityResponse.options;\r\n\r\n                    showDefaultsFormModal(title, contextLevel, category, purpose, activity, categories, purposes, activities);\r\n\r\n                    return true;\r\n\r\n                }).catch(Notification.exception);\r\n            }\r\n        );\r\n\r\n        $(ACTIONS.DELETE_ACTIVITY_DEFAULTS).click(function(e) {\r\n            e.preventDefault();\r\n\r\n            var button = $(this);\r\n            var contextLevel = button.data('contextlevel');\r\n            var activity = button.data('activityname');\r\n            var activityDisplayName = button.data('activitydisplayname');\r\n            // Set category and purpose to inherit (-1).\r\n            var category = INHERIT;\r\n            var purpose = INHERIT;\r\n\r\n            ModalFactory.create({\r\n                title: Str.get_string('deletedefaults', 'tool_dataprivacy', activityDisplayName),\r\n                body: Templates.render('tool_dataprivacy/delete_activity_defaults', {\"activityname\": activityDisplayName}),\r\n                type: ModalFactory.types.SAVE_CANCEL,\r\n                large: true\r\n            }).then(function(modal) {\r\n                modal.setSaveButtonText(Str.get_string('delete'));\r\n\r\n                // Handle save event.\r\n                modal.getRoot().on(ModalEvents.save, function() {\r\n                    setContextDefaults(contextLevel, category, purpose, activity, false);\r\n                });\r\n\r\n                // Handle hidden event.\r\n                modal.getRoot().on(ModalEvents.hidden, function() {\r\n                    // Destroy when hidden.\r\n                    modal.destroy();\r\n                });\r\n\r\n                modal.show();\r\n\r\n                return true;\r\n            }).catch(Notification.exception);\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Prepares and renders the modal for setting the defaults for the given context level/plugin.\r\n     *\r\n     * @param {String} title The modal's title.\r\n     * @param {Number} contextLevel The context level to set defaults for.\r\n     * @param {Number} category The current category ID.\r\n     * @param {Number} purpose The current purpose ID.\r\n     * @param {String} activity The plugin name of the activity. Optional.\r\n     * @param {Array} categoryOptions The list of category options.\r\n     * @param {Array} purposeOptions The list of purpose options.\r\n     * @param {Array} activityOptions The list of activity options. Optional.\r\n     */\r\n    function showDefaultsFormModal(title, contextLevel, category, purpose, activity,\r\n                                   categoryOptions, purposeOptions, activityOptions) {\r\n\r\n        if (category !== null) {\r\n            categoryOptions.forEach(function(currentValue) {\r\n                if (currentValue.id === category) {\r\n                    currentValue.selected = true;\r\n                }\r\n            });\r\n        }\r\n\r\n        if (purpose !== null) {\r\n            purposeOptions.forEach(function(currentValue) {\r\n                if (currentValue.id === purpose) {\r\n                    currentValue.selected = true;\r\n                }\r\n            });\r\n        }\r\n\r\n        var templateContext = {\r\n            \"contextlevel\": contextLevel,\r\n            \"categoryoptions\": categoryOptions,\r\n            \"purposeoptions\": purposeOptions\r\n        };\r\n\r\n        // Check the activityOptions parameter that was passed.\r\n        if (activityOptions !== null && activityOptions.length) {\r\n            // Check the activity parameter that was passed.\r\n            if (activity === null) {\r\n                // We're setting a new defaults for a module.\r\n                templateContext.newactivitydefaults = true;\r\n\r\n            } else {\r\n                // Edit mode. Set selection.\r\n                activityOptions.forEach(function(currentValue) {\r\n                    if (activity === currentValue.name) {\r\n                        currentValue.selected = true;\r\n                    }\r\n                });\r\n            }\r\n\r\n            templateContext.modemodule = true;\r\n            templateContext.activityoptions = activityOptions;\r\n        }\r\n\r\n        ModalFactory.create({\r\n            title: title,\r\n            body: Templates.render('tool_dataprivacy/category_purpose_form', templateContext),\r\n            type: ModalFactory.types.SAVE_CANCEL,\r\n            large: true\r\n        }).then(function(modal) {\r\n\r\n            // Handle save event.\r\n            modal.getRoot().on(ModalEvents.save, function() {\r\n                var activity = $('#activity');\r\n                var activityVal = typeof activity !== 'undefined' ? activity.val() : null;\r\n                var override = $('#override');\r\n                var overrideVal = typeof override !== 'undefined' ? override.is(':checked') : false;\r\n\r\n                setContextDefaults($('#contextlevel').val(), $('#category').val(), $('#purpose').val(), activityVal, overrideVal);\r\n            });\r\n\r\n            // Handle hidden event.\r\n            modal.getRoot().on(ModalEvents.hidden, function() {\r\n                // Destroy when hidden.\r\n                modal.destroy();\r\n            });\r\n\r\n            modal.show();\r\n\r\n            return modal;\r\n        }).catch(Notification.exception);\r\n    }\r\n\r\n    /**\r\n     * Calls a the tool_dataprivacy_set_context_defaults WS function.\r\n     *\r\n     * @param {Number} contextLevel The context level.\r\n     * @param {Number} category The category ID.\r\n     * @param {Number} purpose The purpose ID.\r\n     * @param {String} activity The plugin name of the activity module.\r\n     * @param {Boolean} override Whether to override custom instances.\r\n     */\r\n    function setContextDefaults(contextLevel, category, purpose, activity, override) {\r\n        var request = {\r\n            methodname: 'tool_dataprivacy_set_context_defaults',\r\n            args: {\r\n                'contextlevel': contextLevel,\r\n                'category': category,\r\n                'purpose': purpose,\r\n                'override': override,\r\n                'activity': activity\r\n            }\r\n        };\r\n\r\n        Ajax.call([request])[0].done(function(data) {\r\n            if (data.result) {\r\n                window.location.reload();\r\n            }\r\n        });\r\n    }\r\n\r\n    return /** @alias module:tool_dataprivacy/defaultsactions */ {\r\n        // Public variables and functions.\r\n\r\n        /**\r\n         * Initialise the module.\r\n         *\r\n         * @method init\r\n         * @return {DefaultsActions}\r\n         */\r\n        'init': function() {\r\n            return new DefaultsActions();\r\n        }\r\n    };\r\n});\r\n"],"names":["define","$","Ajax","Notification","Str","ModalFactory","ModalEvents","Templates","ACTIONS","DefaultsActions","registerEvents","showDefaultsFormModal","title","contextLevel","category","purpose","activity","categoryOptions","purposeOptions","activityOptions","forEach","currentValue","id","selected","templateContext","length","newactivitydefaults","name","modemodule","activityoptions","create","body","render","type","types","SAVE_CANCEL","large","then","modal","getRoot","on","save","activityVal","val","override","overrideVal","is","setContextDefaults","hidden","destroy","show","catch","exception","request","methodname","args","call","done","data","result","window","location","reload","prototype","click","e","preventDefault","button","this","promises","titlePromise","get_string","text","when","categoryResponse","purposeResponse","categories","options","purposes","activityResponse","activities","activityDisplayName","setSaveButtonText"],"mappings":"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"}