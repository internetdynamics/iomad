{"version":3,"file":"form_competency_element.min.js","sources":["../src/form_competency_element.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Badge select competency actions\r\n *\r\n * @module     tool_lp/form_competency_element\r\n * @copyright  2019 Damyon Wiese <damyon@moodle.com>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\ndefine(['jquery', 'tool_lp/competencypicker', 'core/ajax', 'core/notification', 'core/templates'],\r\n        function($, Picker, Ajax, Notification, Templates) {\r\n\r\n    var pickerInstance = null;\r\n\r\n    var pageContextId = 1;\r\n\r\n    /**\r\n     * Re-render the list of selected competencies.\r\n     *\r\n     * @method renderCompetencies\r\n     * @return {boolean}\r\n     */\r\n    var renderCompetencies = function() {\r\n        var currentCompetencies = $('[data-action=\"competencies\"]').val();\r\n        var requests = [];\r\n        var i = 0;\r\n\r\n        if (currentCompetencies != '') {\r\n            currentCompetencies = currentCompetencies.split(',');\r\n            for (i = 0; i < currentCompetencies.length; i++) {\r\n                requests[requests.length] = {\r\n                    methodname: 'core_competency_read_competency',\r\n                    args: {id: currentCompetencies[i]}\r\n                };\r\n            }\r\n        }\r\n\r\n        $.when.apply($, Ajax.call(requests, false)).then(function() {\r\n            var i = 0,\r\n                competencies = [];\r\n\r\n            for (i = 0; i < arguments.length; i++) {\r\n                competencies[i] = arguments[i];\r\n            }\r\n            var context = {\r\n                competencies: competencies\r\n            };\r\n\r\n            return Templates.render('tool_lp/form_competency_list', context);\r\n        }).then(function(html, js) {\r\n            Templates.replaceNode($('[data-region=\"competencies\"]'), html, js);\r\n            return true;\r\n        }).fail(Notification.exception);\r\n\r\n        return true;\r\n    };\r\n\r\n    /**\r\n     * Deselect a competency\r\n     *\r\n     * @method unpickCompetenciesHandler\r\n     * @param {Event} e\r\n     * @return {boolean}\r\n     */\r\n    var unpickCompetenciesHandler = function(e) {\r\n        var currentCompetencies = $('[data-action=\"competencies\"]').val().split(','),\r\n            newCompetencies = [],\r\n            i,\r\n            toRemove = $(e.currentTarget).data('id');\r\n\r\n        for (i = 0; i < currentCompetencies.length; i++) {\r\n            if (currentCompetencies[i] != toRemove) {\r\n                newCompetencies[newCompetencies.length] = currentCompetencies[i];\r\n            }\r\n        }\r\n\r\n        $('[data-action=\"competencies\"]').val(newCompetencies.join(','));\r\n\r\n        return renderCompetencies();\r\n    };\r\n\r\n    /**\r\n     * Open a competencies popup to relate competencies.\r\n     *\r\n     * @method pickCompetenciesHandler\r\n     */\r\n    var pickCompetenciesHandler = function() {\r\n        var currentCompetencies = $('[data-action=\"competencies\"]').val().split(',');\r\n\r\n        if (!pickerInstance) {\r\n            pickerInstance = new Picker(pageContextId, false, 'parents', true);\r\n            pickerInstance.on('save', function(e, data) {\r\n                var before = $('[data-action=\"competencies\"]').val();\r\n                var compIds = data.competencyIds;\r\n                if (before != '') {\r\n                    compIds = compIds.concat(before.split(','));\r\n                }\r\n                var value = compIds.join(',');\r\n\r\n                $('[data-action=\"competencies\"]').val(value);\r\n\r\n                return renderCompetencies();\r\n            });\r\n        }\r\n\r\n        pickerInstance.setDisallowedCompetencyIDs(currentCompetencies);\r\n        pickerInstance.display();\r\n    };\r\n\r\n    return /** @alias module:tool_lp/form_competency_element */ {\r\n        /**\r\n         * Listen for clicks on the competency picker and push the changes to the form element.\r\n         *\r\n         * @method init\r\n         * @param {Integer} contextId\r\n         */\r\n        init: function(contextId) {\r\n            pageContextId = contextId;\r\n            renderCompetencies();\r\n            $('[data-action=\"select-competencies\"]').on('click', pickCompetenciesHandler);\r\n            $('body').on('click', '[data-action=\"deselect-competency\"]', unpickCompetenciesHandler);\r\n        }\r\n    };\r\n});\r\n"],"names":["define","$","Picker","Ajax","Notification","Templates","pickerInstance","pageContextId","renderCompetencies","currentCompetencies","val","requests","i","split","length","methodname","args","id","when","apply","call","then","competencies","arguments","context","render","html","js","replaceNode","fail","exception","unpickCompetenciesHandler","e","newCompetencies","toRemove","currentTarget","data","join","pickCompetenciesHandler","on","before","compIds","competencyIds","concat","value","setDisallowedCompetencyIDs","display","init","contextId"],"mappings":";;;;;;;AAsBAA,yCAAO,CAAC,SAAU,2BAA4B,YAAa,oBAAqB,mBACxE,SAASC,EAAGC,OAAQC,KAAMC,aAAcC,eAExCC,eAAiB,KAEjBC,cAAgB,EAQhBC,mBAAqB,eACjBC,oBAAsBR,EAAE,gCAAgCS,MACxDC,SAAW,GACXC,EAAI,KAEmB,IAAvBH,wBACAA,oBAAsBA,oBAAoBI,MAAM,KAC3CD,EAAI,EAAGA,EAAIH,oBAAoBK,OAAQF,IACxCD,SAASA,SAASG,QAAU,CACxBC,WAAY,kCACZC,KAAM,CAACC,GAAIR,oBAAoBG,YAK3CX,EAAEiB,KAAKC,MAAMlB,EAAGE,KAAKiB,KAAKT,UAAU,IAAQU,MAAK,eACzCT,EAAI,EACJU,aAAe,OAEdV,EAAI,EAAGA,EAAIW,UAAUT,OAAQF,IAC9BU,aAAaV,GAAKW,UAAUX,OAE5BY,QAAU,CACVF,aAAcA,qBAGXjB,UAAUoB,OAAO,+BAAgCD,YACzDH,MAAK,SAASK,KAAMC,WACnBtB,UAAUuB,YAAY3B,EAAE,gCAAiCyB,KAAMC,KACxD,KACRE,KAAKzB,aAAa0B,YAEd,GAUPC,0BAA4B,SAASC,OAGjCpB,EAFAH,oBAAsBR,EAAE,gCAAgCS,MAAMG,MAAM,KACpEoB,gBAAkB,GAElBC,SAAWjC,EAAE+B,EAAEG,eAAeC,KAAK,UAElCxB,EAAI,EAAGA,EAAIH,oBAAoBK,OAAQF,IACpCH,oBAAoBG,IAAMsB,WAC1BD,gBAAgBA,gBAAgBnB,QAAUL,oBAAoBG,WAItEX,EAAE,gCAAgCS,IAAIuB,gBAAgBI,KAAK,MAEpD7B,sBAQP8B,wBAA0B,eACtB7B,oBAAsBR,EAAE,gCAAgCS,MAAMG,MAAM,KAEnEP,iBACDA,eAAiB,IAAIJ,OAAOK,eAAe,EAAO,WAAW,IAC9CgC,GAAG,QAAQ,SAASP,EAAGI,UAC9BI,OAASvC,EAAE,gCAAgCS,MAC3C+B,QAAUL,KAAKM,cACL,IAAVF,SACAC,QAAUA,QAAQE,OAAOH,OAAO3B,MAAM,WAEtC+B,MAAQH,QAAQJ,KAAK,YAEzBpC,EAAE,gCAAgCS,IAAIkC,OAE/BpC,wBAIfF,eAAeuC,2BAA2BpC,qBAC1CH,eAAewC,iBAGyC,CAOxDC,KAAM,SAASC,WACXzC,cAAgByC,UAChBxC,qBACAP,EAAE,uCAAuCsC,GAAG,QAASD,yBACrDrC,EAAE,QAAQsC,GAAG,QAAS,sCAAuCR"}