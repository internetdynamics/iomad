{"version":3,"file":"competencyactions.min.js","sources":["../src/competencyactions.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Handle selection changes and actions on the competency tree.\r\n *\r\n * @module     tool_lp/competencyactions\r\n * @copyright  2015 Damyon Wiese <damyon@moodle.com>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\ndefine(['jquery',\r\n        'core/url',\r\n        'core/templates',\r\n        'core/notification',\r\n        'core/str',\r\n        'core/ajax',\r\n        'tool_lp/dragdrop-reorder',\r\n        'tool_lp/tree',\r\n        'tool_lp/dialogue',\r\n        'tool_lp/menubar',\r\n        'tool_lp/competencypicker',\r\n        'tool_lp/competency_outcomes',\r\n        'tool_lp/competencyruleconfig',\r\n        'core/pending',\r\n        ],\r\n       function(\r\n            $, url, templates, notification, str, ajax, dragdrop, Ariatree, Dialogue, menubar, Picker, Outcomes, RuleConfig, Pending\r\n        ) {\r\n\r\n    // Private variables and functions.\r\n    /** @var {Object} treeModel - This is an object representing the nodes in the tree. */\r\n    var treeModel = null;\r\n    /** @var {Node} moveSource - The start of a drag operation */\r\n    var moveSource = null;\r\n    /** @var {Node} moveTarget - The end of a drag operation */\r\n    var moveTarget = null;\r\n    /** @var {Number} pageContextId The page context ID. */\r\n    var pageContextId;\r\n    /** @var {Object} Picker instance. */\r\n    var pickerInstance;\r\n    /** @var {Object} Rule config instance. */\r\n    var ruleConfigInstance;\r\n    /** @var {Object} The competency we're picking a relation to. */\r\n    var relatedTarget;\r\n    /** @var {Object} Taxonomy constants indexed per level. */\r\n    var taxonomiesConstants;\r\n    /** @var {Array} The rules modules. Values are object containing type, namd and amd. */\r\n    var rulesModules;\r\n    /** @var {Number} the selected competency ID. */\r\n    var selectedCompetencyId = null;\r\n\r\n    /**\r\n     * Respond to choosing the \"Add\" menu item for the selected node in the tree.\r\n     * @method addHandler\r\n     */\r\n    var addHandler = function() {\r\n        var parent = $('[data-region=\"competencyactions\"]').data('competency');\r\n\r\n        var params = {\r\n            competencyframeworkid: treeModel.getCompetencyFrameworkId(),\r\n            pagecontextid: pageContextId\r\n        };\r\n\r\n        if (parent !== null) {\r\n            // We are adding at a sub node.\r\n            params.parentid = parent.id;\r\n        }\r\n\r\n        var relocate = function() {\r\n            var queryparams = $.param(params);\r\n            window.location = url.relativeUrl('/admin/tool/lp/editcompetency.php?' + queryparams);\r\n        };\r\n\r\n        if (parent !== null && treeModel.hasRule(parent.id)) {\r\n            str.get_strings([\r\n                {key: 'confirm', component: 'moodle'},\r\n                {key: 'addingcompetencywillresetparentrule', component: 'tool_lp', param: parent.shortname},\r\n                {key: 'yes', component: 'core'},\r\n                {key: 'no', component: 'core'}\r\n            ]).done(function(strings) {\r\n                notification.confirm(\r\n                    strings[0],\r\n                    strings[1],\r\n                    strings[2],\r\n                    strings[3],\r\n                    relocate\r\n                );\r\n            }).fail(notification.exception);\r\n        } else {\r\n            relocate();\r\n        }\r\n    };\r\n\r\n    /**\r\n     * A source and destination has been chosen - so time to complete a move.\r\n     * @method doMove\r\n     */\r\n    var doMove = function() {\r\n        var frameworkid = $('[data-region=\"filtercompetencies\"]').data('frameworkid');\r\n        var requests = ajax.call([{\r\n            methodname: 'core_competency_set_parent_competency',\r\n            args: {competencyid: moveSource, parentid: moveTarget}\r\n        }, {\r\n            methodname: 'tool_lp_data_for_competencies_manage_page',\r\n            args: {competencyframeworkid: frameworkid,\r\n                    search: $('[data-region=\"filtercompetencies\"] input').val()}\r\n        }]);\r\n        requests[1].done(reloadPage).fail(notification.exception);\r\n    };\r\n\r\n    /**\r\n     * Confirms a competency move.\r\n     *\r\n     * @method confirmMove\r\n     */\r\n    var confirmMove = function() {\r\n        moveTarget = typeof moveTarget === \"undefined\" ? 0 : moveTarget;\r\n        if (moveTarget == moveSource) {\r\n            // No move to do.\r\n            return;\r\n        }\r\n\r\n        var targetComp = treeModel.getCompetency(moveTarget) || {},\r\n            sourceComp = treeModel.getCompetency(moveSource) || {},\r\n            confirmMessage = 'movecompetencywillresetrules',\r\n            showConfirm = false;\r\n\r\n        // We shouldn't be moving the competency to the same parent.\r\n        if (sourceComp.parentid == moveTarget) {\r\n            return;\r\n        }\r\n\r\n        // If we are moving to a child of self.\r\n        if (targetComp.path && targetComp.path.indexOf('/' + sourceComp.id + '/') >= 0) {\r\n            confirmMessage = 'movecompetencytochildofselfwillresetrules';\r\n\r\n            // Show a confirmation if self has rules, as they'll disappear.\r\n            showConfirm = showConfirm || treeModel.hasRule(sourceComp.id);\r\n        }\r\n\r\n        // Show a confirmation if the current parent, or the destination have rules.\r\n        showConfirm = showConfirm || (treeModel.hasRule(targetComp.id) || treeModel.hasRule(sourceComp.parentid));\r\n\r\n        // Show confirm, and/or do the things.\r\n        if (showConfirm) {\r\n            str.get_strings([\r\n                {key: 'confirm', component: 'moodle'},\r\n                {key: confirmMessage, component: 'tool_lp'},\r\n                {key: 'yes', component: 'moodle'},\r\n                {key: 'no', component: 'moodle'}\r\n            ]).done(function(strings) {\r\n                notification.confirm(\r\n                    strings[0], // Confirm.\r\n                    strings[1], // Delete competency X?\r\n                    strings[2], // Delete.\r\n                    strings[3], // Cancel.\r\n                    doMove\r\n                );\r\n            }).fail(notification.exception);\r\n\r\n        } else {\r\n            doMove();\r\n        }\r\n    };\r\n\r\n    /**\r\n     * A move competency popup was opened - initialise the aria tree in it.\r\n     * @method initMovePopup\r\n     * @param {dialogue} popup The tool_lp/dialogue that was created.\r\n     */\r\n    var initMovePopup = function(popup) {\r\n        var body = $(popup.getContent());\r\n        var treeRoot = body.find('[data-enhance=movetree]');\r\n        var tree = new Ariatree(treeRoot, false);\r\n        tree.on('selectionchanged', function(evt, params) {\r\n            var target = params.selected;\r\n            moveTarget = $(target).data('id');\r\n        });\r\n        treeRoot.show();\r\n\r\n        body.on('click', '[data-action=\"move\"]', function() {\r\n          popup.close();\r\n          confirmMove();\r\n        });\r\n        body.on('click', '[data-action=\"cancel\"]', function() {\r\n          popup.close();\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Turn a flat list of competencies into a tree structure (recursive).\r\n     * @method addCompetencyChildren\r\n     * @param {Object} parent The current parent node in the tree\r\n     * @param {Object[]} competencies The flat list of competencies\r\n     */\r\n    var addCompetencyChildren = function(parent, competencies) {\r\n        var i;\r\n\r\n        for (i = 0; i < competencies.length; i++) {\r\n            if (competencies[i].parentid == parent.id) {\r\n                parent.haschildren = true;\r\n                competencies[i].children = [];\r\n                competencies[i].haschildren = false;\r\n                parent.children[parent.children.length] = competencies[i];\r\n                addCompetencyChildren(competencies[i], competencies);\r\n            }\r\n        }\r\n    };\r\n\r\n    /**\r\n     * A node was chosen and \"Move\" was selected from the menu. Open a popup to select the target.\r\n     * @param {Event} e\r\n     * @method moveHandler\r\n     */\r\n    var moveHandler = function(e) {\r\n        e.preventDefault();\r\n        var competency = $('[data-region=\"competencyactions\"]').data('competency');\r\n\r\n        // Remember what we are moving.\r\n        moveSource = competency.id;\r\n\r\n        // Load data for the template.\r\n        var requests = ajax.call([\r\n            {\r\n                methodname: 'core_competency_search_competencies',\r\n                args: {\r\n                    competencyframeworkid: competency.competencyframeworkid,\r\n                    searchtext: ''\r\n                }\r\n            }, {\r\n                methodname: 'core_competency_read_competency_framework',\r\n                args: {\r\n                    id: competency.competencyframeworkid\r\n                }\r\n            }\r\n        ]);\r\n\r\n        // When all data has arrived, continue.\r\n        $.when.apply(null, requests).done(function(competencies, framework) {\r\n\r\n            // Expand the list of competencies into a tree.\r\n            var i;\r\n            var competenciestree = [];\r\n            for (i = 0; i < competencies.length; i++) {\r\n                var onecompetency = competencies[i];\r\n                if (onecompetency.parentid == \"0\") {\r\n                    onecompetency.children = [];\r\n                    onecompetency.haschildren = 0;\r\n                    competenciestree[competenciestree.length] = onecompetency;\r\n                    addCompetencyChildren(onecompetency, competencies);\r\n                }\r\n            }\r\n\r\n            str.get_strings([\r\n                {key: 'movecompetency', component: 'tool_lp', param: competency.shortname},\r\n                {key: 'move', component: 'tool_lp'},\r\n                {key: 'cancel', component: 'moodle'}\r\n            ]).done(function(strings) {\r\n\r\n                var context = {\r\n                    framework: framework,\r\n                    competencies: competenciestree\r\n                };\r\n\r\n                templates.render('tool_lp/competencies_move_tree', context)\r\n                   .done(function(tree) {\r\n                       new Dialogue(\r\n                           strings[0], // Move competency x.\r\n                           tree, // The move tree.\r\n                           initMovePopup\r\n                       );\r\n\r\n                   }).fail(notification.exception);\r\n\r\n           }).fail(notification.exception);\r\n\r\n        }).fail(notification.exception);\r\n\r\n    };\r\n\r\n    /**\r\n     * Edit the selected competency.\r\n     * @method editHandler\r\n     */\r\n    var editHandler = function() {\r\n        var competency = $('[data-region=\"competencyactions\"]').data('competency');\r\n\r\n        var params = {\r\n            competencyframeworkid: treeModel.getCompetencyFrameworkId(),\r\n            id: competency.id,\r\n            parentid: competency.parentid,\r\n            pagecontextid: pageContextId\r\n        };\r\n\r\n        var queryparams = $.param(params);\r\n        window.location = url.relativeUrl('/admin/tool/lp/editcompetency.php?' + queryparams);\r\n    };\r\n\r\n    /**\r\n     * Re-render the page with the latest data.\r\n     * @param {Object} context\r\n     * @method reloadPage\r\n     */\r\n    var reloadPage = function(context) {\r\n        templates.render('tool_lp/manage_competencies_page', context)\r\n            .done(function(newhtml, newjs) {\r\n                $('[data-region=\"managecompetencies\"]').replaceWith(newhtml);\r\n                templates.runTemplateJS(newjs);\r\n            })\r\n           .fail(notification.exception);\r\n    };\r\n\r\n    /**\r\n     * Perform a search and render the page with the new search results.\r\n     * @param {Event} e\r\n     * @method updateSearchHandler\r\n     */\r\n    var updateSearchHandler = function(e) {\r\n        e.preventDefault();\r\n\r\n        var frameworkid = $('[data-region=\"filtercompetencies\"]').data('frameworkid');\r\n\r\n        var requests = ajax.call([{\r\n            methodname: 'tool_lp_data_for_competencies_manage_page',\r\n            args: {competencyframeworkid: frameworkid,\r\n                    search: $('[data-region=\"filtercompetencies\"] input').val()}\r\n        }]);\r\n        requests[0].done(reloadPage).fail(notification.exception);\r\n    };\r\n\r\n    /**\r\n     * Move a competency \"up\". This only affects the sort order within the same branch of the tree.\r\n     * @method moveUpHandler\r\n     */\r\n    var moveUpHandler = function() {\r\n        // We are chaining ajax requests here.\r\n        var competency = $('[data-region=\"competencyactions\"]').data('competency');\r\n        var requests = ajax.call([{\r\n            methodname: 'core_competency_move_up_competency',\r\n            args: {id: competency.id}\r\n        }, {\r\n            methodname: 'tool_lp_data_for_competencies_manage_page',\r\n            args: {competencyframeworkid: competency.competencyframeworkid,\r\n                    search: $('[data-region=\"filtercompetencies\"] input').val()}\r\n        }]);\r\n        requests[1].done(reloadPage).fail(notification.exception);\r\n    };\r\n\r\n    /**\r\n     * Move a competency \"down\". This only affects the sort order within the same branch of the tree.\r\n     * @method moveDownHandler\r\n     */\r\n    var moveDownHandler = function() {\r\n        // We are chaining ajax requests here.\r\n        var competency = $('[data-region=\"competencyactions\"]').data('competency');\r\n        var requests = ajax.call([{\r\n            methodname: 'core_competency_move_down_competency',\r\n            args: {id: competency.id}\r\n        }, {\r\n            methodname: 'tool_lp_data_for_competencies_manage_page',\r\n            args: {competencyframeworkid: competency.competencyframeworkid,\r\n                    search: $('[data-region=\"filtercompetencies\"] input').val()}\r\n        }]);\r\n        requests[1].done(reloadPage).fail(notification.exception);\r\n    };\r\n\r\n    /**\r\n     * Open a dialogue to show all the courses using the selected competency.\r\n     * @method seeCoursesHandler\r\n     */\r\n    var seeCoursesHandler = function() {\r\n        var competency = $('[data-region=\"competencyactions\"]').data('competency');\r\n\r\n        var requests = ajax.call([{\r\n            methodname: 'tool_lp_list_courses_using_competency',\r\n            args: {id: competency.id}\r\n        }]);\r\n\r\n        requests[0].done(function(courses) {\r\n            var context = {\r\n                courses: courses\r\n            };\r\n            templates.render('tool_lp/linked_courses_summary', context).done(function(html) {\r\n                str.get_string('linkedcourses', 'tool_lp').done(function(linkedcourses) {\r\n                    new Dialogue(\r\n                        linkedcourses, // Title.\r\n                        html, // The linked courses.\r\n                        initMovePopup\r\n                    );\r\n                }).fail(notification.exception);\r\n            }).fail(notification.exception);\r\n        }).fail(notification.exception);\r\n    };\r\n\r\n    /**\r\n     * Open a competencies popup to relate competencies.\r\n     *\r\n     * @method relateCompetenciesHandler\r\n     */\r\n    var relateCompetenciesHandler = function() {\r\n        relatedTarget = $('[data-region=\"competencyactions\"]').data('competency');\r\n\r\n        if (!pickerInstance) {\r\n            pickerInstance = new Picker(pageContextId, relatedTarget.competencyframeworkid);\r\n            pickerInstance.on('save', function(e, data) {\r\n                var pendingPromise = new Pending();\r\n                var compIds = data.competencyIds;\r\n\r\n                var calls = [];\r\n                $.each(compIds, function(index, value) {\r\n                    calls.push({\r\n                        methodname: 'core_competency_add_related_competency',\r\n                        args: {competencyid: value, relatedcompetencyid: relatedTarget.id}\r\n                    });\r\n                });\r\n\r\n                calls.push({\r\n                    methodname: 'tool_lp_data_for_related_competencies_section',\r\n                    args: {competencyid: relatedTarget.id}\r\n                });\r\n\r\n                var promises = ajax.call(calls);\r\n\r\n                promises[calls.length - 1].then(function(context) {\r\n                    return templates.render('tool_lp/related_competencies', context);\r\n                }).then(function(html, js) {\r\n                    $('[data-region=\"relatedcompetencies\"]').replaceWith(html);\r\n                    templates.runTemplateJS(js);\r\n                    updatedRelatedCompetencies();\r\n                    return;\r\n                })\r\n                .then(pendingPromise.resolve)\r\n                .catch(notification.exception);\r\n            });\r\n        }\r\n\r\n        pickerInstance.setDisallowedCompetencyIDs([relatedTarget.id]);\r\n        pickerInstance.display();\r\n    };\r\n\r\n    var ruleConfigHandler = function(e) {\r\n        e.preventDefault();\r\n        relatedTarget = $('[data-region=\"competencyactions\"]').data('competency');\r\n        ruleConfigInstance.setTargetCompetencyId(relatedTarget.id);\r\n        ruleConfigInstance.display();\r\n    };\r\n\r\n    var ruleConfigSaveHandler = function(e, config) {\r\n        var update = {\r\n            id: relatedTarget.id,\r\n            shortname: relatedTarget.shortname,\r\n            idnumber: relatedTarget.idnumber,\r\n            description: relatedTarget.description,\r\n            descriptionformat: relatedTarget.descriptionformat,\r\n            ruletype: config.ruletype,\r\n            ruleoutcome: config.ruleoutcome,\r\n            ruleconfig: config.ruleconfig\r\n        };\r\n        var promise = ajax.call([{\r\n            methodname: 'core_competency_update_competency',\r\n            args: {competency: update}\r\n        }]);\r\n        promise[0].then(function(result) {\r\n            if (result) {\r\n                relatedTarget.ruletype = config.ruletype;\r\n                relatedTarget.ruleoutcome = config.ruleoutcome;\r\n                relatedTarget.ruleconfig = config.ruleconfig;\r\n                renderCompetencySummary(relatedTarget);\r\n            }\r\n            return;\r\n        }).catch(notification.exception);\r\n    };\r\n\r\n    /**\r\n     * Delete a competency.\r\n     * @method doDelete\r\n     */\r\n    var doDelete = function() {\r\n        // We are chaining ajax requests here.\r\n        var competency = $('[data-region=\"competencyactions\"]').data('competency');\r\n        var requests = ajax.call([{\r\n            methodname: 'core_competency_delete_competency',\r\n            args: {id: competency.id}\r\n        }, {\r\n            methodname: 'tool_lp_data_for_competencies_manage_page',\r\n            args: {competencyframeworkid: competency.competencyframeworkid,\r\n                    search: $('[data-region=\"filtercompetencies\"] input').val()}\r\n        }]);\r\n        requests[0].done(function(success) {\r\n            if (success === false) {\r\n                str.get_strings([\r\n                {key: 'competencycannotbedeleted', component: 'tool_lp', param: competency.shortname},\r\n                {key: 'cancel', component: 'moodle'}\r\n                ]).done(function(strings) {\r\n                    notification.alert(\r\n                        null,\r\n                        strings[0]\r\n                    );\r\n                }).fail(notification.exception);\r\n            }\r\n        }).fail(notification.exception);\r\n        requests[1].done(reloadPage).fail(notification.exception);\r\n    };\r\n\r\n    /**\r\n     * Show a confirm dialogue before deleting a competency.\r\n     * @method deleteCompetencyHandler\r\n     */\r\n    var deleteCompetencyHandler = function() {\r\n        var competency = $('[data-region=\"competencyactions\"]').data('competency'),\r\n            confirmMessage = 'deletecompetency';\r\n\r\n        if (treeModel.hasRule(competency.parentid)) {\r\n            confirmMessage = 'deletecompetencyparenthasrule';\r\n        }\r\n\r\n        str.get_strings([\r\n            {key: 'confirm', component: 'moodle'},\r\n            {key: confirmMessage, component: 'tool_lp', param: competency.shortname},\r\n            {key: 'delete', component: 'moodle'},\r\n            {key: 'cancel', component: 'moodle'}\r\n        ]).done(function(strings) {\r\n            notification.confirm(\r\n                strings[0], // Confirm.\r\n                strings[1], // Delete competency X?\r\n                strings[2], // Delete.\r\n                strings[3], // Cancel.\r\n                doDelete\r\n            );\r\n        }).fail(notification.exception);\r\n    };\r\n\r\n    /**\r\n     * HTML5 implementation of drag/drop (there is an accesible alternative in the menus).\r\n     * @method dragStart\r\n     * @param {Event} e\r\n     */\r\n    var dragStart = function(e) {\r\n        e.originalEvent.dataTransfer.setData('text', $(e.target).parent().data('id'));\r\n    };\r\n\r\n    /**\r\n     * HTML5 implementation of drag/drop (there is an accesible alternative in the menus).\r\n     * @method allowDrop\r\n     * @param {Event} e\r\n     */\r\n    var allowDrop = function(e) {\r\n        e.originalEvent.dataTransfer.dropEffect = 'move';\r\n        e.preventDefault();\r\n    };\r\n\r\n    /**\r\n     * HTML5 implementation of drag/drop (there is an accesible alternative in the menus).\r\n     * @method dragEnter\r\n     * @param {Event} e\r\n     */\r\n    var dragEnter = function(e) {\r\n        e.preventDefault();\r\n        $(this).addClass('currentdragtarget');\r\n    };\r\n\r\n    /**\r\n     * HTML5 implementation of drag/drop (there is an accesible alternative in the menus).\r\n     * @method dragLeave\r\n     * @param {Event} e\r\n     */\r\n    var dragLeave = function(e) {\r\n        e.preventDefault();\r\n        $(this).removeClass('currentdragtarget');\r\n    };\r\n\r\n    /**\r\n     * HTML5 implementation of drag/drop (there is an accesible alternative in the menus).\r\n     * @method dropOver\r\n     * @param {Event} e\r\n     */\r\n    var dropOver = function(e) {\r\n        e.preventDefault();\r\n        moveSource = e.originalEvent.dataTransfer.getData('text');\r\n        moveTarget = $(e.target).parent().data('id');\r\n        $(this).removeClass('currentdragtarget');\r\n\r\n        confirmMove();\r\n    };\r\n\r\n    /**\r\n     * Deletes a related competency without confirmation.\r\n     *\r\n     * @param {Event} e The event that triggered the action.\r\n     * @method deleteRelatedHandler\r\n     */\r\n    var deleteRelatedHandler = function(e) {\r\n        e.preventDefault();\r\n\r\n        var relatedid = this.id.substr(11);\r\n        var competency = $('[data-region=\"competencyactions\"]').data('competency');\r\n        var removeRelated = ajax.call([\r\n            {methodname: 'core_competency_remove_related_competency',\r\n              args: {relatedcompetencyid: relatedid, competencyid: competency.id}},\r\n            {methodname: 'tool_lp_data_for_related_competencies_section',\r\n              args: {competencyid: competency.id}}\r\n        ]);\r\n\r\n        removeRelated[1].done(function(context) {\r\n            templates.render('tool_lp/related_competencies', context).done(function(html) {\r\n                $('[data-region=\"relatedcompetencies\"]').replaceWith(html);\r\n                updatedRelatedCompetencies();\r\n            }).fail(notification.exception);\r\n        }).fail(notification.exception);\r\n    };\r\n\r\n    /**\r\n     * Updates the competencies list (with relations) and add listeners.\r\n     *\r\n     * @method updatedRelatedCompetencies\r\n     */\r\n    var updatedRelatedCompetencies = function() {\r\n\r\n        // Listeners to newly loaded related competencies.\r\n        $('[data-action=\"deleterelation\"]').on('click', deleteRelatedHandler);\r\n\r\n    };\r\n\r\n    /**\r\n     * Log the competency viewed event.\r\n     *\r\n     * @param  {Object} competency The competency.\r\n     * @method triggerCompetencyViewedEvent\r\n     */\r\n    var triggerCompetencyViewedEvent = function(competency) {\r\n        if (competency.id !== selectedCompetencyId) {\r\n            // Set the selected competency id.\r\n            selectedCompetencyId = competency.id;\r\n            ajax.call([{\r\n                    methodname: 'core_competency_competency_viewed',\r\n                    args: {id: competency.id}\r\n            }]);\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Return the taxonomy constant for a level.\r\n     *\r\n     * @param  {Number} level The level.\r\n     * @return {String}\r\n     * @function getTaxonomyAtLevel\r\n     */\r\n    var getTaxonomyAtLevel = function(level) {\r\n        var constant = taxonomiesConstants[level];\r\n        if (!constant) {\r\n            constant = 'competency';\r\n        }\r\n        return constant;\r\n    };\r\n\r\n    /**\r\n     * Render the competency summary.\r\n     *\r\n     * @param  {Object} competency The competency.\r\n     */\r\n    var renderCompetencySummary = function(competency) {\r\n        var promise = $.Deferred().resolve().promise(),\r\n            context = {};\r\n\r\n        context.competency = competency;\r\n        context.showdeleterelatedaction = true;\r\n        context.showrelatedcompetencies = true;\r\n        context.showrule = false;\r\n        context.pluginbaseurl = url.relativeUrl('/admin/tool/lp');\r\n\r\n        if (competency.ruleoutcome != Outcomes.NONE) {\r\n            // Get the outcome and rule name.\r\n            promise = Outcomes.getString(competency.ruleoutcome).then(function(str) {\r\n                var name;\r\n                $.each(rulesModules, function(index, modInfo) {\r\n                    if (modInfo.type == competency.ruletype) {\r\n                        name = modInfo.name;\r\n                    }\r\n                });\r\n                return [str, name];\r\n            });\r\n        }\r\n\r\n        promise.then(function(strs) {\r\n            if (typeof strs !== 'undefined') {\r\n                context.showrule = true;\r\n                context.rule = {\r\n                    outcome: strs[0],\r\n                    type: strs[1]\r\n                };\r\n            }\r\n            return context;\r\n        }).then(function(context) {\r\n            return templates.render('tool_lp/competency_summary', context);\r\n        }).then(function(html) {\r\n            $('[data-region=\"competencyinfo\"]').html(html);\r\n            $('[data-action=\"deleterelation\"]').on('click', deleteRelatedHandler);\r\n            return templates.render('tool_lp/loading', {});\r\n        }).then(function(html, js) {\r\n            templates.replaceNodeContents('[data-region=\"relatedcompetencies\"]', html, js);\r\n            return ajax.call([{\r\n                methodname: 'tool_lp_data_for_related_competencies_section',\r\n                args: {competencyid: competency.id}\r\n            }])[0];\r\n        }).then(function(context) {\r\n            return templates.render('tool_lp/related_competencies', context);\r\n        }).then(function(html, js) {\r\n            $('[data-region=\"relatedcompetencies\"]').replaceWith(html);\r\n            templates.runTemplateJS(js);\r\n            updatedRelatedCompetencies();\r\n            return;\r\n        }).catch(notification.exception);\r\n    };\r\n\r\n    /**\r\n     * Return the string \"Add <taxonomy>\".\r\n     *\r\n     * @param  {Number} level The level.\r\n     * @return {String}\r\n     * @function strAddTaxonomy\r\n     */\r\n    var strAddTaxonomy = function(level) {\r\n        return str.get_string('taxonomy_add_' + getTaxonomyAtLevel(level), 'tool_lp');\r\n    };\r\n\r\n    /**\r\n     * Return the string \"Selected <taxonomy>\".\r\n     *\r\n     * @param  {Number} level The level.\r\n     * @return {String}\r\n     * @function strSelectedTaxonomy\r\n     */\r\n    var strSelectedTaxonomy = function(level) {\r\n        return str.get_string('taxonomy_selected_' + getTaxonomyAtLevel(level), 'tool_lp');\r\n    };\r\n\r\n    /**\r\n     * Handler when a node in the aria tree is selected.\r\n     * @method selectionChanged\r\n     * @param {Event} evt The event that triggered the selection change.\r\n     * @param {Object} params The parameters for the event. Contains a list of selected nodes.\r\n     * @return {Boolean}\r\n     */\r\n    var selectionChanged = function(evt, params) {\r\n        var node = params.selected,\r\n            id = $(node).data('id'),\r\n            btn = $('[data-region=\"competencyactions\"] [data-action=\"add\"]'),\r\n            actionMenu = $('[data-region=\"competencyactionsmenu\"]'),\r\n            selectedTitle = $('[data-region=\"selected-competency\"]'),\r\n            level = 0,\r\n            sublevel = 1;\r\n\r\n        menubar.closeAll();\r\n\r\n        if (typeof id === \"undefined\") {\r\n            // Assume this is the root of the tree.\r\n            // Here we are only getting the text from the top of the tree, to do it we clone the tree,\r\n            // remove all children and then call text on the result.\r\n            $('[data-region=\"competencyinfo\"]').html(node.clone().children().remove().end().text());\r\n            $('[data-region=\"competencyactions\"]').data('competency', null);\r\n            actionMenu.hide();\r\n\r\n        } else {\r\n            var competency = treeModel.getCompetency(id);\r\n\r\n            level = treeModel.getCompetencyLevel(id);\r\n            sublevel = level + 1;\r\n\r\n            actionMenu.show();\r\n            $('[data-region=\"competencyactions\"]').data('competency', competency);\r\n            renderCompetencySummary(competency);\r\n            // Log Competency viewed event.\r\n            triggerCompetencyViewedEvent(competency);\r\n        }\r\n        strSelectedTaxonomy(level).then(function(str) {\r\n            selectedTitle.text(str);\r\n            return;\r\n        }).catch(notification.exception);\r\n\r\n        strAddTaxonomy(sublevel).then(function(str) {\r\n            btn.show()\r\n                .find('[data-region=\"term\"]')\r\n                .text(str);\r\n            return;\r\n        }).catch(notification.exception);\r\n\r\n        // We handled this event so consume it.\r\n        evt.preventDefault();\r\n        return false;\r\n    };\r\n\r\n    /**\r\n     * Return the string \"Selected <taxonomy>\".\r\n     *\r\n     * @function parseTaxonomies\r\n     * @param  {String} taxonomiesstr Comma separated list of taxonomies.\r\n     * @return {Array} of level => taxonomystr\r\n     */\r\n    var parseTaxonomies = function(taxonomiesstr) {\r\n        var all = taxonomiesstr.split(',');\r\n        all.unshift(\"\");\r\n        delete all[0];\r\n\r\n        // Note we don't need to fill holes, because other functions check for empty anyway.\r\n        return all;\r\n    };\r\n\r\n    return {\r\n        /**\r\n         * Initialise this page (attach event handlers etc).\r\n         *\r\n         * @method init\r\n         * @param {Object} model The tree model provides some useful functions for loading and searching competencies.\r\n         * @param {Number} pagectxid The page context ID.\r\n         * @param {Object} taxonomies Constants indexed by level.\r\n         * @param {Object} rulesMods The modules of the rules.\r\n         */\r\n        init: function(model, pagectxid, taxonomies, rulesMods) {\r\n            treeModel = model;\r\n            pageContextId = pagectxid;\r\n            taxonomiesConstants = parseTaxonomies(taxonomies);\r\n            rulesModules = rulesMods;\r\n\r\n            $('[data-region=\"competencyactions\"] [data-action=\"add\"]').on('click', addHandler);\r\n\r\n            menubar.enhance('.competencyactionsmenu', {\r\n                '[data-action=\"edit\"]': editHandler,\r\n                '[data-action=\"delete\"]': deleteCompetencyHandler,\r\n                '[data-action=\"move\"]': moveHandler,\r\n                '[data-action=\"moveup\"]': moveUpHandler,\r\n                '[data-action=\"movedown\"]': moveDownHandler,\r\n                '[data-action=\"linkedcourses\"]': seeCoursesHandler,\r\n                '[data-action=\"relatedcompetencies\"]': relateCompetenciesHandler.bind(this),\r\n                '[data-action=\"competencyrules\"]': ruleConfigHandler.bind(this)\r\n            });\r\n            $('[data-region=\"competencyactionsmenu\"]').hide();\r\n            $('[data-region=\"competencyactions\"] [data-action=\"add\"]').hide();\r\n\r\n            $('[data-region=\"filtercompetencies\"]').on('submit', updateSearchHandler);\r\n            // Simple html5 drag drop because we already added an accessible alternative.\r\n            var top = $('[data-region=\"managecompetencies\"] [data-enhance=\"tree\"]');\r\n            top.on('dragstart', 'li>span', dragStart)\r\n                .on('dragover', 'li>span', allowDrop)\r\n                .on('dragenter', 'li>span', dragEnter)\r\n                .on('dragleave', 'li>span', dragLeave)\r\n                .on('drop', 'li>span', dropOver);\r\n\r\n            model.on('selectionchanged', selectionChanged);\r\n\r\n            // Prepare the configuration tool.\r\n            ruleConfigInstance = new RuleConfig(treeModel, rulesModules);\r\n            ruleConfigInstance.on('save', ruleConfigSaveHandler.bind(this));\r\n        }\r\n    };\r\n});\r\n"],"names":["define","$","url","templates","notification","str","ajax","dragdrop","Ariatree","Dialogue","menubar","Picker","Outcomes","RuleConfig","Pending","pageContextId","pickerInstance","ruleConfigInstance","relatedTarget","taxonomiesConstants","rulesModules","treeModel","moveSource","moveTarget","selectedCompetencyId","addHandler","parent","data","params","competencyframeworkid","getCompetencyFrameworkId","pagecontextid","parentid","id","relocate","queryparams","param","window","location","relativeUrl","hasRule","get_strings","key","component","shortname","done","strings","confirm","fail","exception","doMove","frameworkid","call","methodname","args","competencyid","search","val","reloadPage","confirmMove","targetComp","getCompetency","sourceComp","confirmMessage","showConfirm","path","indexOf","initMovePopup","popup","body","getContent","treeRoot","find","on","evt","target","selected","show","close","addCompetencyChildren","competencies","i","length","haschildren","children","moveHandler","e","preventDefault","competency","requests","searchtext","when","apply","framework","competenciestree","onecompetency","context","render","tree","editHandler","newhtml","newjs","replaceWith","runTemplateJS","updateSearchHandler","moveUpHandler","moveDownHandler","seeCoursesHandler","courses","html","get_string","linkedcourses","relateCompetenciesHandler","pendingPromise","compIds","competencyIds","calls","each","index","value","push","relatedcompetencyid","then","js","updatedRelatedCompetencies","resolve","catch","setDisallowedCompetencyIDs","display","ruleConfigHandler","setTargetCompetencyId","ruleConfigSaveHandler","config","update","idnumber","description","descriptionformat","ruletype","ruleoutcome","ruleconfig","result","renderCompetencySummary","doDelete","success","alert","deleteCompetencyHandler","dragStart","originalEvent","dataTransfer","setData","allowDrop","dropEffect","dragEnter","this","addClass","dragLeave","removeClass","dropOver","getData","deleteRelatedHandler","relatedid","substr","getTaxonomyAtLevel","level","constant","promise","Deferred","showdeleterelatedaction","showrelatedcompetencies","showrule","pluginbaseurl","NONE","getString","name","modInfo","type","strs","rule","outcome","replaceNodeContents","selectionChanged","node","btn","actionMenu","selectedTitle","sublevel","closeAll","clone","remove","end","text","hide","getCompetencyLevel","triggerCompetencyViewedEvent","strSelectedTaxonomy","strAddTaxonomy","init","model","pagectxid","taxonomies","rulesMods","all","split","unshift","enhance","bind"],"mappings":";;;;;;;AAsBAA,mCAAO,CAAC,SACA,WACA,iBACA,oBACA,WACA,YACA,2BACA,eACA,mBACA,kBACA,2BACA,8BACA,+BACA,iBAED,SACKC,EAAGC,IAAKC,UAAWC,aAAcC,IAAKC,KAAMC,SAAUC,SAAUC,SAAUC,QAASC,OAAQC,SAAUC,WAAYC,aAWrHC,cAEAC,eAEAC,mBAEAC,cAEAC,oBAEAC,aAhBAC,UAAY,KAEZC,WAAa,KAEbC,WAAa,KAcbC,qBAAuB,KAMvBC,WAAa,eACTC,OAASzB,EAAE,qCAAqC0B,KAAK,cAErDC,OAAS,CACTC,sBAAuBR,UAAUS,2BACjCC,cAAehB,eAGJ,OAAXW,SAEAE,OAAOI,SAAWN,OAAOO,QAGzBC,SAAW,eACPC,YAAclC,EAAEmC,MAAMR,QAC1BS,OAAOC,SAAWpC,IAAIqC,YAAY,qCAAuCJ,cAG9D,OAAXT,QAAmBL,UAAUmB,QAAQd,OAAOO,IAC5C5B,IAAIoC,YAAY,CACZ,CAACC,IAAK,UAAWC,UAAW,UAC5B,CAACD,IAAK,sCAAuCC,UAAW,UAAWP,MAAOV,OAAOkB,WACjF,CAACF,IAAK,MAAOC,UAAW,QACxB,CAACD,IAAK,KAAMC,UAAW,UACxBE,MAAK,SAASC,SACb1C,aAAa2C,QACTD,QAAQ,GACRA,QAAQ,GACRA,QAAQ,GACRA,QAAQ,GACRZ,aAELc,KAAK5C,aAAa6C,WAErBf,YAQJgB,OAAS,eACLC,YAAclD,EAAE,sCAAsC0B,KAAK,eAChDrB,KAAK8C,KAAK,CAAC,CACtBC,WAAY,wCACZC,KAAM,CAACC,aAAcjC,WAAYU,SAAUT,aAC5C,CACC8B,WAAY,4CACZC,KAAM,CAACzB,sBAAuBsB,YACtBK,OAAQvD,EAAE,4CAA4CwD,UAEzD,GAAGZ,KAAKa,YAAYV,KAAK5C,aAAa6C,YAQ/CU,YAAc,eACdpC,gBAAmC,IAAfA,WAA6B,EAAIA,aACnCD,gBAKdsC,WAAavC,UAAUwC,cAActC,aAAe,GACpDuC,WAAazC,UAAUwC,cAAcvC,aAAe,GACpDyC,eAAiB,+BACjBC,aAAc,EAGdF,WAAW9B,UAAYT,aAKvBqC,WAAWK,MAAQL,WAAWK,KAAKC,QAAQ,IAAMJ,WAAW7B,GAAK,MAAQ,IACzE8B,eAAiB,4CAGjBC,YAAcA,aAAe3C,UAAUmB,QAAQsB,WAAW7B,MAI9D+B,YAAcA,aAAgB3C,UAAUmB,QAAQoB,WAAW3B,KAAOZ,UAAUmB,QAAQsB,WAAW9B,WAI3F3B,IAAIoC,YAAY,CACZ,CAACC,IAAK,UAAWC,UAAW,UAC5B,CAACD,IAAKqB,eAAgBpB,UAAW,WACjC,CAACD,IAAK,MAAOC,UAAW,UACxB,CAACD,IAAK,KAAMC,UAAW,YACxBE,MAAK,SAASC,SACb1C,aAAa2C,QACTD,QAAQ,GACRA,QAAQ,GACRA,QAAQ,GACRA,QAAQ,GACRI,WAELF,KAAK5C,aAAa6C,WAGrBC,YASJiB,cAAgB,SAASC,WACrBC,KAAOpE,EAAEmE,MAAME,cACfC,SAAWF,KAAKG,KAAK,2BACd,IAAIhE,SAAS+D,UAAU,GAC7BE,GAAG,oBAAoB,SAASC,IAAK9C,YAClC+C,OAAS/C,OAAOgD,SACpBrD,WAAatB,EAAE0E,QAAQhD,KAAK,SAEhC4C,SAASM,OAETR,KAAKI,GAAG,QAAS,wBAAwB,WACvCL,MAAMU,QACNnB,iBAEFU,KAAKI,GAAG,QAAS,0BAA0B,WACzCL,MAAMU,YAURC,sBAAwB,SAASrD,OAAQsD,kBACrCC,MAECA,EAAI,EAAGA,EAAID,aAAaE,OAAQD,IAC7BD,aAAaC,GAAGjD,UAAYN,OAAOO,KACnCP,OAAOyD,aAAc,EACrBH,aAAaC,GAAGG,SAAW,GAC3BJ,aAAaC,GAAGE,aAAc,EAC9BzD,OAAO0D,SAAS1D,OAAO0D,SAASF,QAAUF,aAAaC,GACvDF,sBAAsBC,aAAaC,GAAID,gBAU/CK,YAAc,SAASC,GACvBA,EAAEC,qBACEC,WAAavF,EAAE,qCAAqC0B,KAAK,cAG7DL,WAAakE,WAAWvD,OAGpBwD,SAAWnF,KAAK8C,KAAK,CACrB,CACIC,WAAY,sCACZC,KAAM,CACFzB,sBAAuB2D,WAAW3D,sBAClC6D,WAAY,KAEjB,CACCrC,WAAY,4CACZC,KAAM,CACFrB,GAAIuD,WAAW3D,0BAM3B5B,EAAE0F,KAAKC,MAAM,KAAMH,UAAU5C,MAAK,SAASmC,aAAca,eAGjDZ,EACAa,iBAAmB,OAClBb,EAAI,EAAGA,EAAID,aAAaE,OAAQD,IAAK,KAClCc,cAAgBf,aAAaC,GACH,KAA1Bc,cAAc/D,WACd+D,cAAcX,SAAW,GACzBW,cAAcZ,YAAc,EAC5BW,iBAAiBA,iBAAiBZ,QAAUa,cAC5ChB,sBAAsBgB,cAAef,eAI7C3E,IAAIoC,YAAY,CACZ,CAACC,IAAK,iBAAkBC,UAAW,UAAWP,MAAOoD,WAAW5C,WAChE,CAACF,IAAK,OAAQC,UAAW,WACzB,CAACD,IAAK,SAAUC,UAAW,YAC5BE,MAAK,SAASC,aAETkD,QAAU,CACVH,UAAWA,UACXb,aAAcc,kBAGlB3F,UAAU8F,OAAO,iCAAkCD,SAC/CnD,MAAK,SAASqD,UACPzF,SACAqC,QAAQ,GACRoD,KACA/B,kBAGLnB,KAAK5C,aAAa6C,cAE1BD,KAAK5C,aAAa6C,cAErBD,KAAK5C,aAAa6C,YAQrBkD,YAAc,eACVX,WAAavF,EAAE,qCAAqC0B,KAAK,cAEzDC,OAAS,CACTC,sBAAuBR,UAAUS,2BACjCG,GAAIuD,WAAWvD,GACfD,SAAUwD,WAAWxD,SACrBD,cAAehB,eAGfoB,YAAclC,EAAEmC,MAAMR,QAC1BS,OAAOC,SAAWpC,IAAIqC,YAAY,qCAAuCJ,cAQzEuB,WAAa,SAASsC,SACtB7F,UAAU8F,OAAO,mCAAoCD,SAChDnD,MAAK,SAASuD,QAASC,OACpBpG,EAAE,sCAAsCqG,YAAYF,SACpDjG,UAAUoG,cAAcF,UAE5BrD,KAAK5C,aAAa6C,YAQtBuD,oBAAsB,SAASlB,GAC/BA,EAAEC,qBAEEpC,YAAclD,EAAE,sCAAsC0B,KAAK,eAEhDrB,KAAK8C,KAAK,CAAC,CACtBC,WAAY,4CACZC,KAAM,CAACzB,sBAAuBsB,YACtBK,OAAQvD,EAAE,4CAA4CwD,UAEzD,GAAGZ,KAAKa,YAAYV,KAAK5C,aAAa6C,YAO/CwD,cAAgB,eAEZjB,WAAavF,EAAE,qCAAqC0B,KAAK,cAC9CrB,KAAK8C,KAAK,CAAC,CACtBC,WAAY,qCACZC,KAAM,CAACrB,GAAIuD,WAAWvD,KACvB,CACCoB,WAAY,4CACZC,KAAM,CAACzB,sBAAuB2D,WAAW3D,sBACjC2B,OAAQvD,EAAE,4CAA4CwD,UAEzD,GAAGZ,KAAKa,YAAYV,KAAK5C,aAAa6C,YAO/CyD,gBAAkB,eAEdlB,WAAavF,EAAE,qCAAqC0B,KAAK,cAC9CrB,KAAK8C,KAAK,CAAC,CACtBC,WAAY,uCACZC,KAAM,CAACrB,GAAIuD,WAAWvD,KACvB,CACCoB,WAAY,4CACZC,KAAM,CAACzB,sBAAuB2D,WAAW3D,sBACjC2B,OAAQvD,EAAE,4CAA4CwD,UAEzD,GAAGZ,KAAKa,YAAYV,KAAK5C,aAAa6C,YAO/C0D,kBAAoB,eAChBnB,WAAavF,EAAE,qCAAqC0B,KAAK,cAE9CrB,KAAK8C,KAAK,CAAC,CACtBC,WAAY,wCACZC,KAAM,CAACrB,GAAIuD,WAAWvD,OAGjB,GAAGY,MAAK,SAAS+D,aAClBZ,QAAU,CACVY,QAASA,SAEbzG,UAAU8F,OAAO,iCAAkCD,SAASnD,MAAK,SAASgE,MACtExG,IAAIyG,WAAW,gBAAiB,WAAWjE,MAAK,SAASkE,mBACjDtG,SACAsG,cACAF,KACA1C,kBAELnB,KAAK5C,aAAa6C,cACtBD,KAAK5C,aAAa6C,cACtBD,KAAK5C,aAAa6C,YAQrB+D,0BAA4B,WAC5B9F,cAAgBjB,EAAE,qCAAqC0B,KAAK,cAEvDX,iBACDA,eAAiB,IAAIL,OAAOI,cAAeG,cAAcW,wBAC1C4C,GAAG,QAAQ,SAASa,EAAG3D,UAC9BsF,eAAiB,IAAInG,QACrBoG,QAAUvF,KAAKwF,cAEfC,MAAQ,GACZnH,EAAEoH,KAAKH,SAAS,SAASI,MAAOC,OAC5BH,MAAMI,KAAK,CACPnE,WAAY,yCACZC,KAAM,CAACC,aAAcgE,MAAOE,oBAAqBvG,cAAce,SAIvEmF,MAAMI,KAAK,CACPnE,WAAY,gDACZC,KAAM,CAACC,aAAcrC,cAAce,MAGxB3B,KAAK8C,KAAKgE,OAEhBA,MAAMlC,OAAS,GAAGwC,MAAK,SAAS1B,gBAC9B7F,UAAU8F,OAAO,+BAAgCD,YACzD0B,MAAK,SAASb,KAAMc,IACnB1H,EAAE,uCAAuCqG,YAAYO,MACrD1G,UAAUoG,cAAcoB,IACxBC,gCAGHF,KAAKT,eAAeY,SACpBC,MAAM1H,aAAa6C,cAI5BjC,eAAe+G,2BAA2B,CAAC7G,cAAce,KACzDjB,eAAegH,WAGfC,kBAAoB,SAAS3C,GAC7BA,EAAEC,iBACFrE,cAAgBjB,EAAE,qCAAqC0B,KAAK,cAC5DV,mBAAmBiH,sBAAsBhH,cAAce,IACvDhB,mBAAmB+G,WAGnBG,sBAAwB,SAAS7C,EAAG8C,YAChCC,OAAS,CACTpG,GAAIf,cAAce,GAClBW,UAAW1B,cAAc0B,UACzB0F,SAAUpH,cAAcoH,SACxBC,YAAarH,cAAcqH,YAC3BC,kBAAmBtH,cAAcsH,kBACjCC,SAAUL,OAAOK,SACjBC,YAAaN,OAAOM,YACpBC,WAAYP,OAAOO,YAETrI,KAAK8C,KAAK,CAAC,CACrBC,WAAY,oCACZC,KAAM,CAACkC,WAAY6C,WAEf,GAAGX,MAAK,SAASkB,QACjBA,SACA1H,cAAcuH,SAAWL,OAAOK,SAChCvH,cAAcwH,YAAcN,OAAOM,YACnCxH,cAAcyH,WAAaP,OAAOO,WAClCE,wBAAwB3H,mBAG7B4G,MAAM1H,aAAa6C,YAOtB6F,SAAW,eAEPtD,WAAavF,EAAE,qCAAqC0B,KAAK,cACzD8D,SAAWnF,KAAK8C,KAAK,CAAC,CACtBC,WAAY,oCACZC,KAAM,CAACrB,GAAIuD,WAAWvD,KACvB,CACCoB,WAAY,4CACZC,KAAM,CAACzB,sBAAuB2D,WAAW3D,sBACjC2B,OAAQvD,EAAE,4CAA4CwD,UAElEgC,SAAS,GAAG5C,MAAK,SAASkG,UACN,IAAZA,SACA1I,IAAIoC,YAAY,CAChB,CAACC,IAAK,4BAA6BC,UAAW,UAAWP,MAAOoD,WAAW5C,WAC3E,CAACF,IAAK,SAAUC,UAAW,YACxBE,MAAK,SAASC,SACb1C,aAAa4I,MACT,KACAlG,QAAQ,OAEbE,KAAK5C,aAAa6C,cAE1BD,KAAK5C,aAAa6C,WACrBwC,SAAS,GAAG5C,KAAKa,YAAYV,KAAK5C,aAAa6C,YAO/CgG,wBAA0B,eACtBzD,WAAavF,EAAE,qCAAqC0B,KAAK,cACzDoC,eAAiB,mBAEjB1C,UAAUmB,QAAQgD,WAAWxD,YAC7B+B,eAAiB,iCAGrB1D,IAAIoC,YAAY,CACZ,CAACC,IAAK,UAAWC,UAAW,UAC5B,CAACD,IAAKqB,eAAgBpB,UAAW,UAAWP,MAAOoD,WAAW5C,WAC9D,CAACF,IAAK,SAAUC,UAAW,UAC3B,CAACD,IAAK,SAAUC,UAAW,YAC5BE,MAAK,SAASC,SACb1C,aAAa2C,QACTD,QAAQ,GACRA,QAAQ,GACRA,QAAQ,GACRA,QAAQ,GACRgG,aAEL9F,KAAK5C,aAAa6C,YAQrBiG,UAAY,SAAS5D,GACrBA,EAAE6D,cAAcC,aAAaC,QAAQ,OAAQpJ,EAAEqF,EAAEX,QAAQjD,SAASC,KAAK,QAQvE2H,UAAY,SAAShE,GACrBA,EAAE6D,cAAcC,aAAaG,WAAa,OAC1CjE,EAAEC,kBAQFiE,UAAY,SAASlE,GACrBA,EAAEC,iBACFtF,EAAEwJ,MAAMC,SAAS,sBAQjBC,UAAY,SAASrE,GACrBA,EAAEC,iBACFtF,EAAEwJ,MAAMG,YAAY,sBAQpBC,SAAW,SAASvE,GACpBA,EAAEC,iBACFjE,WAAagE,EAAE6D,cAAcC,aAAaU,QAAQ,QAClDvI,WAAatB,EAAEqF,EAAEX,QAAQjD,SAASC,KAAK,MACvC1B,EAAEwJ,MAAMG,YAAY,qBAEpBjG,eASAoG,qBAAuB,SAASzE,GAChCA,EAAEC,qBAEEyE,UAAYP,KAAKxH,GAAGgI,OAAO,IAC3BzE,WAAavF,EAAE,qCAAqC0B,KAAK,cACzCrB,KAAK8C,KAAK,CAC1B,CAACC,WAAY,4CACXC,KAAM,CAACmE,oBAAqBuC,UAAWzG,aAAciC,WAAWvD,KAClE,CAACoB,WAAY,gDACXC,KAAM,CAACC,aAAciC,WAAWvD,OAGxB,GAAGY,MAAK,SAASmD,SAC3B7F,UAAU8F,OAAO,+BAAgCD,SAASnD,MAAK,SAASgE,MACpE5G,EAAE,uCAAuCqG,YAAYO,MACrDe,gCACD5E,KAAK5C,aAAa6C,cACtBD,KAAK5C,aAAa6C,YAQrB2E,2BAA6B,WAG7B3H,EAAE,kCAAkCwE,GAAG,QAASsF,uBA4BhDG,mBAAqB,SAASC,WAC1BC,SAAWjJ,oBAAoBgJ,cAC9BC,WACDA,SAAW,cAERA,UAQPvB,wBAA0B,SAASrD,gBAC/B6E,QAAUpK,EAAEqK,WAAWzC,UAAUwC,UACjCrE,QAAU,GAEdA,QAAQR,WAAaA,WACrBQ,QAAQuE,yBAA0B,EAClCvE,QAAQwE,yBAA0B,EAClCxE,QAAQyE,UAAW,EACnBzE,QAAQ0E,cAAgBxK,IAAIqC,YAAY,kBAEpCiD,WAAWkD,aAAe9H,SAAS+J,OAEnCN,QAAUzJ,SAASgK,UAAUpF,WAAWkD,aAAahB,MAAK,SAASrH,SAC3DwK,YACJ5K,EAAEoH,KAAKjG,cAAc,SAASkG,MAAOwD,SAC7BA,QAAQC,MAAQvF,WAAWiD,WAC3BoC,KAAOC,QAAQD,SAGhB,CAACxK,IAAKwK,UAIrBR,QAAQ3C,MAAK,SAASsD,kBACE,IAATA,OACPhF,QAAQyE,UAAW,EACnBzE,QAAQiF,KAAO,CACXC,QAASF,KAAK,GACdD,KAAMC,KAAK,KAGZhF,WACR0B,MAAK,SAAS1B,gBACN7F,UAAU8F,OAAO,6BAA8BD,YACvD0B,MAAK,SAASb,aACb5G,EAAE,kCAAkC4G,KAAKA,MACzC5G,EAAE,kCAAkCwE,GAAG,QAASsF,sBACzC5J,UAAU8F,OAAO,kBAAmB,OAC5CyB,MAAK,SAASb,KAAMc,WACnBxH,UAAUgL,oBAAoB,sCAAuCtE,KAAMc,IACpErH,KAAK8C,KAAK,CAAC,CACdC,WAAY,gDACZC,KAAM,CAACC,aAAciC,WAAWvD,OAChC,MACLyF,MAAK,SAAS1B,gBACN7F,UAAU8F,OAAO,+BAAgCD,YACzD0B,MAAK,SAASb,KAAMc,IACnB1H,EAAE,uCAAuCqG,YAAYO,MACrD1G,UAAUoG,cAAcoB,IACxBC,gCAEDE,MAAM1H,aAAa6C,YAgCtBmI,iBAAmB,SAAS1G,IAAK9C,YAC7ByJ,KAAOzJ,OAAOgD,SACd3C,GAAKhC,EAAEoL,MAAM1J,KAAK,MAClB2J,IAAMrL,EAAE,yDACRsL,WAAatL,EAAE,yCACfuL,cAAgBvL,EAAE,uCAClBkK,MAAQ,EACRsB,SAAW,KAEf/K,QAAQgL,gBAEU,IAAPzJ,GAIPhC,EAAE,kCAAkC4G,KAAKwE,KAAKM,QAAQvG,WAAWwG,SAASC,MAAMC,QAChF7L,EAAE,qCAAqC0B,KAAK,aAAc,MAC1D4J,WAAWQ,WAER,KACCvG,WAAanE,UAAUwC,cAAc5B,IAGzCwJ,UADAtB,MAAQ9I,UAAU2K,mBAAmB/J,KAClB,EAEnBsJ,WAAW1G,OACX5E,EAAE,qCAAqC0B,KAAK,aAAc6D,YAC1DqD,wBAAwBrD,YA7IG,SAASA,YACpCA,WAAWvD,KAAOT,uBAElBA,qBAAuBgE,WAAWvD,GAClC3B,KAAK8C,KAAK,CAAC,CACHC,WAAY,oCACZC,KAAM,CAACrB,GAAIuD,WAAWvD,QAyI9BgK,CAA6BzG,mBAxCX,SAAS2E,cACxB9J,IAAIyG,WAAW,qBAAuBoD,mBAAmBC,OAAQ,WAyCxE+B,CAAoB/B,OAAOzC,MAAK,SAASrH,KACrCmL,cAAcM,KAAKzL,QAEpByH,MAAM1H,aAAa6C,WAxDL,SAASkH,cACnB9J,IAAIyG,WAAW,gBAAkBoD,mBAAmBC,OAAQ,WAyDnEgC,CAAeV,UAAU/D,MAAK,SAASrH,KACnCiL,IAAIzG,OACCL,KAAK,wBACLsH,KAAKzL,QAEXyH,MAAM1H,aAAa6C,WAGtByB,IAAIa,kBACG,SAmBJ,CAUH6G,KAAM,SAASC,MAAOC,UAAWC,WAAYC,WAnB3B,IACdC,IAmBApL,UAAYgL,MACZtL,cAAgBuL,WApBhBG,IAqBsCF,WArBlBG,MAAM,MAC1BC,QAAQ,WACLF,IAAI,GAmBPtL,oBAhBGsL,IAiBHrL,aAAeoL,UAEfvM,EAAE,yDAAyDwE,GAAG,QAAShD,YAEvEf,QAAQkM,QAAQ,yBAA0B,wBACdzG,qCACE8C,+CACF5D,qCACEoB,yCACEC,gDACKC,wDACMK,0BAA0B6F,KAAKpD,wCACnCxB,kBAAkB4E,KAAKpD,QAE9DxJ,EAAE,yCAAyC8L,OAC3C9L,EAAE,yDAAyD8L,OAE3D9L,EAAE,sCAAsCwE,GAAG,SAAU+B,qBAE3CvG,EAAE,4DACRwE,GAAG,YAAa,UAAWyE,WAC1BzE,GAAG,WAAY,UAAW6E,WAC1B7E,GAAG,YAAa,UAAW+E,WAC3B/E,GAAG,YAAa,UAAWkF,WAC3BlF,GAAG,OAAQ,UAAWoF,UAE3BwC,MAAM5H,GAAG,mBAAoB2G,mBAG7BnK,mBAAqB,IAAIJ,WAAWQ,UAAWD,eAC5BqD,GAAG,OAAQ0D,sBAAsB0E,KAAKpD"}