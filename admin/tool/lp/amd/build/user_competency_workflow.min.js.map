{"version":3,"file":"user_competency_workflow.min.js","sources":["../src/user_competency_workflow.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * User competency workflow.\r\n *\r\n * @module     tool_lp/user_competency_workflow\r\n * @copyright  2015 Frédéric Massart - FMCorz.net\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\ndefine(['jquery',\r\n        'core/templates',\r\n        'core/ajax',\r\n        'core/notification',\r\n        'core/str',\r\n        'tool_lp/menubar',\r\n        'tool_lp/event_base'],\r\n        function($, Templates, Ajax, Notification, Str, Menubar, EventBase) {\r\n\r\n    /**\r\n     * UserCompetencyWorkflow class.\r\n     */\r\n    var UserCompetencyWorkflow = function() {\r\n        EventBase.prototype.constructor.apply(this, []);\r\n    };\r\n    UserCompetencyWorkflow.prototype = Object.create(EventBase.prototype);\r\n\r\n    /** @property {String} The selector to find the user competency data. */\r\n    UserCompetencyWorkflow.prototype._nodeSelector = '[data-node=\"user-competency\"]';\r\n\r\n    /**\r\n     * Cancel a review request and refresh the view.\r\n     *\r\n     * @param  {Object} data The user competency data.\r\n     * @method _cancelReviewRequest\r\n     */\r\n    UserCompetencyWorkflow.prototype._cancelReviewRequest = function(data) {\r\n        var call = {\r\n            methodname: 'core_competency_user_competency_cancel_review_request',\r\n            args: {\r\n                userid: data.userid,\r\n                competencyid: data.competencyid\r\n            }\r\n        };\r\n\r\n        Ajax.call([call])[0].then(function() {\r\n            this._trigger('review-request-cancelled', data);\r\n            this._trigger('status-changed', data);\r\n        }.bind(this)).catch(function() {\r\n            this._trigger('error-occured', data);\r\n        }.bind(this));\r\n    };\r\n\r\n    /**\r\n     * Cancel a review request an refresh the view.\r\n     *\r\n     * @param  {Object} data The user competency data.\r\n     * @method cancelReviewRequest\r\n     */\r\n    UserCompetencyWorkflow.prototype.cancelReviewRequest = function(data) {\r\n        this._cancelReviewRequest(data);\r\n    };\r\n\r\n    /**\r\n     * Cancel a review request handler.\r\n     *\r\n     * @param  {Event} e The event.\r\n     * @method _cancelReviewRequestHandler\r\n     */\r\n    UserCompetencyWorkflow.prototype._cancelReviewRequestHandler = function(e) {\r\n        e.preventDefault();\r\n        var data = this._findUserCompetencyData($(e.target));\r\n        this.cancelReviewRequest(data);\r\n    };\r\n\r\n    /**\r\n     * Request a review and refresh the view.\r\n     *\r\n     * @param  {Object} data The user competency data.\r\n     * @method _requestReview\r\n     */\r\n    UserCompetencyWorkflow.prototype._requestReview = function(data) {\r\n        var call = {\r\n            methodname: 'core_competency_user_competency_request_review',\r\n            args: {\r\n                userid: data.userid,\r\n                competencyid: data.competencyid\r\n            }\r\n        };\r\n\r\n        Ajax.call([call])[0].then(function() {\r\n            this._trigger('review-requested', data);\r\n            this._trigger('status-changed', data);\r\n        }.bind(this)).catch(function() {\r\n            this._trigger('error-occured', data);\r\n        }.bind(this));\r\n    };\r\n\r\n    /**\r\n     * Request a review.\r\n     *\r\n     * @param  {Object} data The user competency data.\r\n     * @method requestReview\r\n     */\r\n    UserCompetencyWorkflow.prototype.requestReview = function(data) {\r\n        this._requestReview(data);\r\n    };\r\n\r\n    /**\r\n     * Request a review handler.\r\n     *\r\n     * @param  {Event} e The event.\r\n     * @method _requestReviewHandler\r\n     */\r\n    UserCompetencyWorkflow.prototype._requestReviewHandler = function(e) {\r\n        e.preventDefault();\r\n        var data = this._findUserCompetencyData($(e.target));\r\n        this.requestReview(data);\r\n    };\r\n\r\n    /**\r\n     * Start a review and refresh the view.\r\n     *\r\n     * @param  {Object} data The user competency data.\r\n     * @method _startReview\r\n     */\r\n    UserCompetencyWorkflow.prototype._startReview = function(data) {\r\n        var call = {\r\n            methodname: 'core_competency_user_competency_start_review',\r\n            args: {\r\n                userid: data.userid,\r\n                competencyid: data.competencyid\r\n            }\r\n        };\r\n        Ajax.call([call])[0].then(function() {\r\n            this._trigger('review-started', data);\r\n            this._trigger('status-changed', data);\r\n        }.bind(this)).catch(function() {\r\n            this._trigger('error-occured', data);\r\n        }.bind(this));\r\n    };\r\n\r\n    /**\r\n     * Start a review.\r\n     *\r\n     * @param  {Object} data The user competency data.\r\n     * @method startReview\r\n     */\r\n    UserCompetencyWorkflow.prototype.startReview = function(data) {\r\n        this._startReview(data);\r\n    };\r\n\r\n    /**\r\n     * Start a review handler.\r\n     *\r\n     * @param  {Event} e The event.\r\n     * @method _startReviewHandler\r\n     */\r\n    UserCompetencyWorkflow.prototype._startReviewHandler = function(e) {\r\n        e.preventDefault();\r\n        var data = this._findUserCompetencyData($(e.target));\r\n        this.startReview(data);\r\n    };\r\n\r\n    /**\r\n     * Stop a review and refresh the view.\r\n     *\r\n     * @param  {Object} data The user competency data.\r\n     * @method _stopReview\r\n     */\r\n    UserCompetencyWorkflow.prototype._stopReview = function(data) {\r\n        var call = {\r\n            methodname: 'core_competency_user_competency_stop_review',\r\n            args: {\r\n                userid: data.userid,\r\n                competencyid: data.competencyid\r\n            }\r\n        };\r\n\r\n        Ajax.call([call])[0].then(function() {\r\n            this._trigger('review-stopped', data);\r\n            this._trigger('status-changed', data);\r\n        }.bind(this)).catch(function() {\r\n            this._trigger('error-occured', data);\r\n        }.bind(this));\r\n    };\r\n\r\n    /**\r\n     * Stop a review.\r\n     *\r\n     * @param  {Object} data The user competency data.\r\n     * @method stopReview\r\n     */\r\n    UserCompetencyWorkflow.prototype.stopReview = function(data) {\r\n        this._stopReview(data);\r\n    };\r\n\r\n    /**\r\n     * Stop a review handler.\r\n     *\r\n     * @param  {Event} e The event.\r\n     * @method _stopReviewHandler\r\n     */\r\n    UserCompetencyWorkflow.prototype._stopReviewHandler = function(e) {\r\n        e.preventDefault();\r\n        var data = this._findUserCompetencyData($(e.target));\r\n        this.stopReview(data);\r\n    };\r\n\r\n    /**\r\n     * Enhance a menu bar.\r\n     *\r\n     * @param  {String} selector Menubar selector.\r\n     */\r\n    UserCompetencyWorkflow.prototype.enhanceMenubar = function(selector) {\r\n        Menubar.enhance(selector, {\r\n            '[data-action=\"request-review\"]': this._requestReviewHandler.bind(this),\r\n            '[data-action=\"cancel-review-request\"]': this._cancelReviewRequestHandler.bind(this),\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Find the user competency data from a node.\r\n     *\r\n     * @param  {Node} node The node to search from.\r\n     * @return {Object} User competency data.\r\n     */\r\n    UserCompetencyWorkflow.prototype._findUserCompetencyData = function(node) {\r\n        var parent = node.parents(this._nodeSelector),\r\n            data;\r\n\r\n        if (parent.length != 1) {\r\n            throw new Error('The evidence node was not located.');\r\n        }\r\n\r\n        data = parent.data();\r\n        if (typeof data === 'undefined' || typeof data.userid === 'undefined' || typeof data.competencyid === 'undefined') {\r\n            throw new Error('User competency data could not be found.');\r\n        }\r\n\r\n        return data;\r\n    };\r\n\r\n    /**\r\n     * Enhance a menu bar.\r\n     *\r\n     * @param  {String} selector Menubar selector.\r\n     */\r\n    UserCompetencyWorkflow.prototype.enhanceMenubar = function(selector) {\r\n        Menubar.enhance(selector, {\r\n            '[data-action=\"request-review\"]': this._requestReviewHandler.bind(this),\r\n            '[data-action=\"cancel-review-request\"]': this._cancelReviewRequestHandler.bind(this),\r\n            '[data-action=\"start-review\"]': this._startReviewHandler.bind(this),\r\n            '[data-action=\"stop-review\"]': this._stopReviewHandler.bind(this),\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Register the events in the region.\r\n     *\r\n     * @param {String} selector The base selector to search nodes in and attach events.\r\n     */\r\n    UserCompetencyWorkflow.prototype.registerEvents = function(selector) {\r\n        var wrapper = $(selector);\r\n\r\n        wrapper.find('[data-action=\"request-review\"]').click(this._requestReviewHandler.bind(this));\r\n        wrapper.find('[data-action=\"cancel-review-request\"]').click(this._cancelReviewRequestHandler.bind(this));\r\n        wrapper.find('[data-action=\"start-review\"]').click(this._startReviewHandler.bind(this));\r\n        wrapper.find('[data-action=\"stop-review\"]').click(this._stopReviewHandler.bind(this));\r\n    };\r\n\r\n    return /** @alias module:tool_lp/user_competency_actions */ UserCompetencyWorkflow;\r\n});\r\n"],"names":["define","$","Templates","Ajax","Notification","Str","Menubar","EventBase","UserCompetencyWorkflow","prototype","constructor","apply","this","Object","create","_nodeSelector","_cancelReviewRequest","data","call","methodname","args","userid","competencyid","then","_trigger","bind","catch","cancelReviewRequest","_cancelReviewRequestHandler","e","preventDefault","_findUserCompetencyData","target","_requestReview","requestReview","_requestReviewHandler","_startReview","startReview","_startReviewHandler","_stopReview","stopReview","_stopReviewHandler","enhanceMenubar","selector","enhance","node","parent","parents","length","Error","registerEvents","wrapper","find","click"],"mappings":";;;;;;;AAsBAA,0CAAO,CAAC,SACA,iBACA,YACA,oBACA,WACA,kBACA,uBACA,SAASC,EAAGC,UAAWC,KAAMC,aAAcC,IAAKC,QAASC,eAKzDC,uBAAyB,WACzBD,UAAUE,UAAUC,YAAYC,MAAMC,KAAM,YAEhDJ,uBAAuBC,UAAYI,OAAOC,OAAOP,UAAUE,YAG1BM,cAAgB,gCAQjDP,uBAAuBC,UAAUO,qBAAuB,SAASC,UACzDC,KAAO,CACPC,WAAY,wDACZC,KAAM,CACFC,OAAQJ,KAAKI,OACbC,aAAcL,KAAKK,eAI3BnB,KAAKe,KAAK,CAACA,OAAO,GAAGK,KAAK,gBACjBC,SAAS,2BAA4BP,WACrCO,SAAS,iBAAkBP,OAClCQ,KAAKb,OAAOc,MAAM,gBACXF,SAAS,gBAAiBP,OACjCQ,KAAKb,QASXJ,uBAAuBC,UAAUkB,oBAAsB,SAASV,WACvDD,qBAAqBC,OAS9BT,uBAAuBC,UAAUmB,4BAA8B,SAASC,GACpEA,EAAEC,qBACEb,KAAOL,KAAKmB,wBAAwB9B,EAAE4B,EAAEG,cACvCL,oBAAoBV,OAS7BT,uBAAuBC,UAAUwB,eAAiB,SAAShB,UACnDC,KAAO,CACPC,WAAY,iDACZC,KAAM,CACFC,OAAQJ,KAAKI,OACbC,aAAcL,KAAKK,eAI3BnB,KAAKe,KAAK,CAACA,OAAO,GAAGK,KAAK,gBACjBC,SAAS,mBAAoBP,WAC7BO,SAAS,iBAAkBP,OAClCQ,KAAKb,OAAOc,MAAM,gBACXF,SAAS,gBAAiBP,OACjCQ,KAAKb,QASXJ,uBAAuBC,UAAUyB,cAAgB,SAASjB,WACjDgB,eAAehB,OASxBT,uBAAuBC,UAAU0B,sBAAwB,SAASN,GAC9DA,EAAEC,qBACEb,KAAOL,KAAKmB,wBAAwB9B,EAAE4B,EAAEG,cACvCE,cAAcjB,OASvBT,uBAAuBC,UAAU2B,aAAe,SAASnB,UACjDC,KAAO,CACPC,WAAY,+CACZC,KAAM,CACFC,OAAQJ,KAAKI,OACbC,aAAcL,KAAKK,eAG3BnB,KAAKe,KAAK,CAACA,OAAO,GAAGK,KAAK,gBACjBC,SAAS,iBAAkBP,WAC3BO,SAAS,iBAAkBP,OAClCQ,KAAKb,OAAOc,MAAM,gBACXF,SAAS,gBAAiBP,OACjCQ,KAAKb,QASXJ,uBAAuBC,UAAU4B,YAAc,SAASpB,WAC/CmB,aAAanB,OAStBT,uBAAuBC,UAAU6B,oBAAsB,SAAST,GAC5DA,EAAEC,qBACEb,KAAOL,KAAKmB,wBAAwB9B,EAAE4B,EAAEG,cACvCK,YAAYpB,OASrBT,uBAAuBC,UAAU8B,YAAc,SAAStB,UAChDC,KAAO,CACPC,WAAY,8CACZC,KAAM,CACFC,OAAQJ,KAAKI,OACbC,aAAcL,KAAKK,eAI3BnB,KAAKe,KAAK,CAACA,OAAO,GAAGK,KAAK,gBACjBC,SAAS,iBAAkBP,WAC3BO,SAAS,iBAAkBP,OAClCQ,KAAKb,OAAOc,MAAM,gBACXF,SAAS,gBAAiBP,OACjCQ,KAAKb,QASXJ,uBAAuBC,UAAU+B,WAAa,SAASvB,WAC9CsB,YAAYtB,OASrBT,uBAAuBC,UAAUgC,mBAAqB,SAASZ,GAC3DA,EAAEC,qBACEb,KAAOL,KAAKmB,wBAAwB9B,EAAE4B,EAAEG,cACvCQ,WAAWvB,OAQpBT,uBAAuBC,UAAUiC,eAAiB,SAASC,UACvDrC,QAAQsC,QAAQD,SAAU,kCACY/B,KAAKuB,sBAAsBV,KAAKb,8CACzBA,KAAKgB,4BAA4BH,KAAKb,SAUvFJ,uBAAuBC,UAAUsB,wBAA0B,SAASc,UAE5D5B,KADA6B,OAASD,KAAKE,QAAQnC,KAAKG,kBAGV,GAAjB+B,OAAOE,aACD,IAAIC,MAAM,8CAIA,KADpBhC,KAAO6B,OAAO7B,cAC4C,IAAhBA,KAAKI,aAAuD,IAAtBJ,KAAKK,mBAC3E,IAAI2B,MAAM,mDAGbhC,MAQXT,uBAAuBC,UAAUiC,eAAiB,SAASC,UACvDrC,QAAQsC,QAAQD,SAAU,kCACY/B,KAAKuB,sBAAsBV,KAAKb,8CACzBA,KAAKgB,4BAA4BH,KAAKb,qCAC/CA,KAAK0B,oBAAoBb,KAAKb,oCAC/BA,KAAK6B,mBAAmBhB,KAAKb,SASpEJ,uBAAuBC,UAAUyC,eAAiB,SAASP,cACnDQ,QAAUlD,EAAE0C,UAEhBQ,QAAQC,KAAK,kCAAkCC,MAAMzC,KAAKuB,sBAAsBV,KAAKb,OACrFuC,QAAQC,KAAK,yCAAyCC,MAAMzC,KAAKgB,4BAA4BH,KAAKb,OAClGuC,QAAQC,KAAK,gCAAgCC,MAAMzC,KAAK0B,oBAAoBb,KAAKb,OACjFuC,QAAQC,KAAK,+BAA+BC,MAAMzC,KAAK6B,mBAAmBhB,KAAKb,QAGvBJ"}