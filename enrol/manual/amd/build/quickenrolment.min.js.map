{"version":3,"file":"quickenrolment.min.js","sources":["../src/quickenrolment.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Quick enrolment AMD module.\r\n *\r\n * @module     enrol_manual/quickenrolment\r\n * @copyright  2016 Damyon Wiese <damyon@moodle.com>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\nimport * as DynamicTable from 'core_table/dynamic';\r\nimport * as Str from 'core/str';\r\nimport * as Toast from 'core/toast';\r\nimport Config from 'core/config';\r\nimport Fragment from 'core/fragment';\r\nimport ModalEvents from 'core/modal_events';\r\nimport ModalFactory from 'core/modal_factory';\r\nimport Notification from 'core/notification';\r\nimport jQuery from 'jquery';\r\nimport Pending from 'core/pending';\r\nimport Prefetch from 'core/prefetch';\r\n\r\nconst Selectors = {\r\n    cohortSelector: \"#id_cohortlist\",\r\n    triggerButtons: \".enrolusersbutton.enrol_manual_plugin [type='submit']\",\r\n    unwantedHiddenFields: \"input[value='_qf__force_multiselect_submission']\",\r\n    buttonWrapper: '[data-region=\"wrapper\"]',\r\n};\r\n\r\n/**\r\n * Get the content of the body for the specified context.\r\n *\r\n * @param {Number} contextId\r\n * @returns {Promise}\r\n */\r\nconst getBodyForContext = contextId => {\r\n    return Fragment.loadFragment('enrol_manual', 'enrol_users_form', contextId, {});\r\n};\r\n\r\n/**\r\n * Get the dynamic table for the button.\r\n *\r\n * @param {HTMLElement} element\r\n * @returns {HTMLElement}\r\n */\r\nconst getDynamicTableForElement = element => {\r\n    const wrapper = element.closest(Selectors.buttonWrapper);\r\n\r\n    return DynamicTable.getTableFromId(wrapper.dataset.tableUniqueid);\r\n};\r\n\r\n/**\r\n * Register the event listeners for this contextid.\r\n *\r\n * @param {Number} contextId\r\n */\r\nconst registerEventListeners = contextId => {\r\n    document.addEventListener('click', e => {\r\n        if (e.target.closest(Selectors.triggerButtons)) {\r\n            e.preventDefault();\r\n\r\n            showModal(getDynamicTableForElement(e.target), contextId);\r\n\r\n            return;\r\n        }\r\n    });\r\n};\r\n\r\n/**\r\n * Display the modal for this contextId.\r\n *\r\n * @param {HTMLElement} dynamicTable The table to beb refreshed when changes are made\r\n * @param {Number} contextId\r\n * @returns {Promise}\r\n */\r\nconst showModal = (dynamicTable, contextId) => {\r\n    const pendingPromise = new Pending('enrol_manual/quickenrolment:showModal');\r\n\r\n    return ModalFactory.create({\r\n        type: ModalFactory.types.SAVE_CANCEL,\r\n        large: true,\r\n        title: Str.get_string('enrolusers', 'enrol_manual'),\r\n        body: getBodyForContext(contextId),\r\n        buttons: {\r\n            save: Str.get_string('enrolusers', 'enrol_manual'),\r\n        }\r\n    })\r\n    .then(modal => {\r\n        modal.getRoot().on(ModalEvents.save, e => {\r\n            // Trigger a form submission, so that any mform elements can do final tricks before the form submission\r\n            // is processed.\r\n            // The actual submit even tis captured in the next handler.\r\n\r\n            e.preventDefault();\r\n            modal.getRoot().find('form').submit();\r\n        });\r\n\r\n        modal.getRoot().on('submit', 'form', e => {\r\n            e.preventDefault();\r\n\r\n            submitFormAjax(dynamicTable, modal);\r\n        });\r\n\r\n        modal.getRoot().on(ModalEvents.hidden, () => {\r\n            modal.destroy();\r\n        });\r\n\r\n        modal.show();\r\n\r\n        return modal;\r\n    })\r\n    .then(modal => Promise.all([modal, modal.getBodyPromise()]))\r\n    .then(([modal, body]) => {\r\n        if (body.get(0).querySelector(Selectors.cohortSelector)) {\r\n            return modal.setSaveButtonText(Str.get_string('enroluserscohorts', 'enrol_manual')).then(() => modal);\r\n        }\r\n\r\n        return modal;\r\n    })\r\n    .then(modal => {\r\n        pendingPromise.resolve();\r\n\r\n        return modal;\r\n    })\r\n    .catch(Notification.exception);\r\n};\r\n\r\n/**\r\n * Submit the form via ajax.\r\n *\r\n * @param {HTMLElement} dynamicTable\r\n * @param {Object} modal\r\n */\r\nconst submitFormAjax = (dynamicTable, modal) => {\r\n    // Note: We use a jQuery object here so that we can use its serialize functionality.\r\n    const form = modal.getRoot().find('form');\r\n\r\n    // Before send the data through AJAX, we need to parse and remove some unwanted hidden fields.\r\n    // This hidden fields are added automatically by mforms and when it reaches the AJAX we get an error.\r\n    form.get(0).querySelectorAll(Selectors.unwantedHiddenFields).forEach(hiddenField => hiddenField.remove());\r\n\r\n    modal.hide();\r\n    modal.destroy();\r\n\r\n    jQuery.ajax(\r\n        `${Config.wwwroot}/enrol/manual/ajax.php?${form.serialize()}`,\r\n        {\r\n            type: 'GET',\r\n            processData: false,\r\n            contentType: \"application/json\",\r\n        }\r\n    )\r\n    .then(response => {\r\n        if (response.error) {\r\n            throw new Error(response.error);\r\n        }\r\n\r\n        return response.count;\r\n    })\r\n    .then(count => {\r\n        return Promise.all([\r\n            Str.get_string('totalenrolledusers', 'enrol', count),\r\n            DynamicTable.refreshTableContent(dynamicTable),\r\n        ]);\r\n    })\r\n    .then(([notificationBody]) => notificationBody)\r\n    .then(notificationBody => Toast.add(notificationBody))\r\n    .catch(error => {\r\n        Notification.addNotification({\r\n            message: error.message,\r\n            type: 'error',\r\n        });\r\n    });\r\n};\r\n\r\n/**\r\n * Set up quick enrolment for the manual enrolment plugin.\r\n *\r\n * @param {Number} contextid The context id to setup for\r\n */\r\nexport const init = ({contextid}) => {\r\n    registerEventListeners(contextid);\r\n\r\n    Prefetch.prefetchStrings('enrol_manual', [\r\n        'enrolusers',\r\n        'enroluserscohorts',\r\n    ]);\r\n\r\n    Prefetch.prefetchString('enrol', 'totalenrolledusers');\r\n};\r\n"],"names":["Selectors","getBodyForContext","contextId","Fragment","loadFragment","registerEventListeners","document","addEventListener","e","target","closest","preventDefault","showModal","element","wrapper","DynamicTable","getTableFromId","dataset","tableUniqueid","getDynamicTableForElement","dynamicTable","pendingPromise","Pending","ModalFactory","create","type","types","SAVE_CANCEL","large","title","Str","get_string","body","buttons","save","then","modal","getRoot","on","ModalEvents","find","submit","submitFormAjax","hidden","destroy","show","Promise","all","getBodyPromise","_ref","get","querySelector","setSaveButtonText","resolve","catch","Notification","exception","form","querySelectorAll","forEach","hiddenField","remove","hide","ajax","Config","wwwroot","serialize","processData","contentType","response","error","Error","count","refreshTableContent","_ref2","notificationBody","Toast","add","addNotification","message","_ref3","contextid","prefetchStrings","prefetchString"],"mappings":";;;;;;;ikBAkCMA,yBACc,iBADdA,yBAEc,wDAFdA,+BAGoB,mDAHpBA,wBAIa,0BASbC,kBAAoBC,WACfC,kBAASC,aAAa,eAAgB,mBAAoBF,UAAW,IAoB1EG,uBAAyBH,YAC3BI,SAASC,iBAAiB,SAASC,OAC3BA,EAAEC,OAAOC,QAAQV,iCACjBQ,EAAEG,sBAEFC,UAhBsBC,CAAAA,gBACxBC,QAAUD,QAAQH,QAAQV,gCAEzBe,aAAaC,eAAeF,QAAQG,QAAQC,gBAajCC,CAA0BX,EAAEC,QAASP,eAcrDU,UAAY,CAACQ,aAAclB,mBACvBmB,eAAiB,IAAIC,iBAAQ,gDAE5BC,uBAAaC,OAAO,CACvBC,KAAMF,uBAAaG,MAAMC,YACzBC,OAAO,EACPC,MAAOC,IAAIC,WAAW,aAAc,gBACpCC,KAAM/B,kBAAkBC,WACxB+B,QAAS,CACLC,KAAMJ,IAAIC,WAAW,aAAc,mBAG1CI,MAAKC,QACFA,MAAMC,UAAUC,GAAGC,sBAAYL,MAAM1B,IAKjCA,EAAEG,iBACFyB,MAAMC,UAAUG,KAAK,QAAQC,YAGjCL,MAAMC,UAAUC,GAAG,SAAU,QAAQ9B,IACjCA,EAAEG,iBAEF+B,eAAetB,aAAcgB,UAGjCA,MAAMC,UAAUC,GAAGC,sBAAYI,QAAQ,KACnCP,MAAMQ,aAGVR,MAAMS,OAECT,SAEVD,MAAKC,OAASU,QAAQC,IAAI,CAACX,MAAOA,MAAMY,qBACxCb,MAAKc,WAAEb,MAAOJ,kBACPA,KAAKkB,IAAI,GAAGC,cAAcnD,0BACnBoC,MAAMgB,kBAAkBtB,IAAIC,WAAW,oBAAqB,iBAAiBI,MAAK,IAAMC,QAG5FA,SAEVD,MAAKC,QACFf,eAAegC,UAERjB,SAEVkB,MAAMC,sBAAaC,YASlBd,eAAiB,CAACtB,aAAcgB,eAE5BqB,KAAOrB,MAAMC,UAAUG,KAAK,QAIlCiB,KAAKP,IAAI,GAAGQ,iBAAiB1D,gCAAgC2D,SAAQC,aAAeA,YAAYC,WAEhGzB,MAAM0B,OACN1B,MAAMQ,0BAECmB,eACAC,gBAAOC,0CAAiCR,KAAKS,aAChD,CACIzC,KAAM,MACN0C,aAAa,EACbC,YAAa,qBAGpBjC,MAAKkC,cACEA,SAASC,YACH,IAAIC,MAAMF,SAASC,cAGtBD,SAASG,SAEnBrC,MAAKqC,OACK1B,QAAQC,IAAI,CACfjB,IAAIC,WAAW,qBAAsB,QAASyC,OAC9CzD,aAAa0D,oBAAoBrD,kBAGxCe,MAAKuC,YAAEC,+BAAsBA,oBAC7BxC,MAAKwC,kBAAoBC,MAAMC,IAAIF,oBACnCrB,OAAMgB,8BACUQ,gBAAgB,CACzBC,QAAST,MAAMS,QACftD,KAAM,4BAUEuD,YAACC,UAACA,iBAClB5E,uBAAuB4E,6BAEdC,gBAAgB,eAAgB,CACrC,aACA,wCAGKC,eAAe,QAAS"}