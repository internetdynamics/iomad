{"version":3,"file":"message_drawer_view_contacts_section_requests.min.js","sources":["../src/message_drawer_view_contacts_section_requests.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Controls the requests section of the contacts page.\r\n *\r\n * @module     core_message/message_drawer_view_contacts_section_requests\r\n * @copyright  2018 Ryan Wyllie <ryan@moodle.com>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\ndefine(\r\n[\r\n    'jquery',\r\n    'core/notification',\r\n    'core/pubsub',\r\n    'core/templates',\r\n    'core_message/message_repository',\r\n    'core_message/message_drawer_events',\r\n    'core_message/message_drawer_lazy_load_list'\r\n],\r\nfunction(\r\n    $,\r\n    Notification,\r\n    PubSub,\r\n    Templates,\r\n    MessageRepository,\r\n    MessageDrawerEvents,\r\n    LazyLoadList\r\n) {\r\n\r\n    var SELECTORS = {\r\n        CONTACT_REQUEST: '[data-region=\"contact-request\"]'\r\n    };\r\n\r\n    var TEMPLATES = {\r\n        REQUESTS_LIST: 'core_message/message_drawer_view_contacts_body_section_requests_list'\r\n    };\r\n\r\n    /**\r\n     * Render the requests in the content container.\r\n     *\r\n     * @param {Object} contentContainer List container element.\r\n     * @param {Array} requests List of requests.\r\n     * @return {Object} jQuery promise\r\n     */\r\n    var render = function(contentContainer, requests) {\r\n        var formattedRequests = requests.map(function(request) {\r\n            return {\r\n                // This is actually the user id.\r\n                id: request.id,\r\n                profileimageurl: request.profileimageurl,\r\n                fullname: request.fullname\r\n            };\r\n        });\r\n        return Templates.render(TEMPLATES.REQUESTS_LIST, {requests: formattedRequests})\r\n            .then(function(html) {\r\n                contentContainer.append(html);\r\n                return html;\r\n            })\r\n            .catch(Notification.exception);\r\n    };\r\n\r\n    /**\r\n     * Load the user contacts and call the renderer.\r\n     *\r\n     * @param {Object} listRoot The lazy loaded list root element\r\n     * @param {Integer} userId The logged in user id.\r\n     * @return {Object} jQuery promise\r\n     */\r\n    var load = function(listRoot, userId) {\r\n        return MessageRepository.getContactRequests(userId)\r\n            .then(function(requests) {\r\n                LazyLoadList.setLoadedAll(listRoot, true);\r\n                return requests;\r\n            })\r\n            .catch(Notification.exception);\r\n    };\r\n\r\n    /**\r\n     * Handle when a contact request is accepted or declined by removing the contact\r\n     * list from the page.\r\n     *\r\n     * @param {Object} root The section root element\r\n     * @return {Function} The event handler function\r\n     */\r\n    var handleContactRequestProcessed = function(root) {\r\n        return function(request) {\r\n            root.find('[data-request-id=\"' + request.userid + '\"]').remove();\r\n            var contactRequests = root.find(SELECTORS.CONTACT_REQUEST);\r\n\r\n            if (!contactRequests.length) {\r\n                LazyLoadList.showEmptyMessage(root);\r\n                LazyLoadList.hideContent(root);\r\n            }\r\n        };\r\n    };\r\n\r\n    /**\r\n     * Listen for any events that might affect the requests section.\r\n     *\r\n     * @param {Object} root The section root element\r\n     */\r\n    var registerEventListeners = function(root) {\r\n        PubSub.subscribe(MessageDrawerEvents.CONTACT_REQUEST_ACCEPTED, handleContactRequestProcessed(root));\r\n        PubSub.subscribe(MessageDrawerEvents.CONTACT_REQUEST_DECLINED, handleContactRequestProcessed(root));\r\n    };\r\n\r\n    /**\r\n     * Setup the requests section.\r\n     *\r\n     * @param {Object} root Requests section container.\r\n     */\r\n    var show = function(root) {\r\n        if (!root.attr('data-contacts-init')) {\r\n            registerEventListeners(root);\r\n            root.attr('data-contacts-init', true);\r\n        }\r\n\r\n        // The root element is already the lazy loaded list root.\r\n        LazyLoadList.show(root, load, render);\r\n    };\r\n\r\n    return {\r\n        show: show,\r\n    };\r\n});\r\n"],"names":["define","$","Notification","PubSub","Templates","MessageRepository","MessageDrawerEvents","LazyLoadList","SELECTORS","TEMPLATES","render","contentContainer","requests","formattedRequests","map","request","id","profileimageurl","fullname","then","html","append","catch","exception","load","listRoot","userId","getContactRequests","setLoadedAll","handleContactRequestProcessed","root","find","userid","remove","length","showEmptyMessage","hideContent","show","attr","subscribe","CONTACT_REQUEST_ACCEPTED","CONTACT_REQUEST_DECLINED","registerEventListeners"],"mappings":";;;;;;;AAsBAA,oEACA,CACI,SACA,oBACA,cACA,iBACA,kCACA,qCACA,+CAEJ,SACIC,EACAC,aACAC,OACAC,UACAC,kBACAC,oBACAC,kBAGIC,0BACiB,kCAGjBC,wBACe,uEAUfC,OAAS,SAASC,iBAAkBC,cAChCC,kBAAoBD,SAASE,KAAI,SAASC,eACnC,CAEHC,GAAID,QAAQC,GACZC,gBAAiBF,QAAQE,gBACzBC,SAAUH,QAAQG,oBAGnBd,UAAUM,OAAOD,wBAAyB,CAACG,SAAUC,oBACvDM,MAAK,SAASC,aACXT,iBAAiBU,OAAOD,MACjBA,QAEVE,MAAMpB,aAAaqB,YAUxBC,KAAO,SAASC,SAAUC,eACnBrB,kBAAkBsB,mBAAmBD,QACvCP,MAAK,SAASP,iBACXL,aAAaqB,aAAaH,UAAU,GAC7Bb,YAEVU,MAAMpB,aAAaqB,YAUxBM,8BAAgC,SAASC,aAClC,SAASf,SACZe,KAAKC,KAAK,qBAAuBhB,QAAQiB,OAAS,MAAMC,SAClCH,KAAKC,KAAKvB,2BAEX0B,SACjB3B,aAAa4B,iBAAiBL,MAC9BvB,aAAa6B,YAAYN,eA8B9B,CACHO,KAXO,SAASP,MACXA,KAAKQ,KAAK,yBAXU,SAASR,MAClC3B,OAAOoC,UAAUjC,oBAAoBkC,yBAA0BX,8BAA8BC,OAC7F3B,OAAOoC,UAAUjC,oBAAoBmC,yBAA0BZ,8BAA8BC,OAUzFY,CAAuBZ,MACvBA,KAAKQ,KAAK,sBAAsB,IAIpC/B,aAAa8B,KAAKP,KAAMN,KAAMd"}