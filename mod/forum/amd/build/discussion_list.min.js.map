{"version":3,"file":"discussion_list.min.js","sources":["../src/discussion_list.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Module for the list of discussions on when viewing a forum.\r\n *\r\n * @module     mod_forum/discussion_list\r\n * @copyright  2019 Andrew Nicols <andrew@nicols.co.uk>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\ndefine([\r\n    'jquery',\r\n    'core/templates',\r\n    'core/str',\r\n    'core/notification',\r\n    'mod_forum/subscription_toggle',\r\n    'mod_forum/selectors',\r\n    'mod_forum/repository',\r\n    'core/pubsub',\r\n    'mod_forum/forum_events',\r\n], function(\r\n    $,\r\n    Templates,\r\n    Str,\r\n    Notification,\r\n    SubscriptionToggle,\r\n    Selectors,\r\n    Repository,\r\n    PubSub,\r\n    ForumEvents\r\n) {\r\n    var registerEventListeners = function(root) {\r\n        PubSub.subscribe(ForumEvents.SUBSCRIPTION_TOGGLED, function(data) {\r\n            var discussionId = data.discussionId;\r\n            var subscribed = data.subscriptionState;\r\n            var discussionListItem = root.find(Selectors.discussion.item + '[data-discussionid= ' + discussionId + ']');\r\n            var subscribedLabel = discussionListItem.find(Selectors.discussion.subscribedLabel);\r\n            if (subscribed) {\r\n                discussionListItem.addClass('subscribed');\r\n                subscribedLabel.removeAttr('hidden');\r\n            } else {\r\n                discussionListItem.removeClass('subscribed');\r\n                subscribedLabel.attr('hidden', true);\r\n            }\r\n        });\r\n\r\n        root.on('click', Selectors.favourite.toggle, function(e) {\r\n            e.preventDefault();\r\n\r\n            var toggleElement = $(this);\r\n            var forumId = toggleElement.data('forumid');\r\n            var discussionId = toggleElement.data('discussionid');\r\n            var subscriptionState = toggleElement.data('targetstate');\r\n            Repository.setFavouriteDiscussionState(forumId, discussionId, subscriptionState)\r\n                .then(function() {\r\n                    return location.reload();\r\n                })\r\n                .catch(Notification.exception);\r\n        });\r\n\r\n        root.on('click', Selectors.pin.toggle, function(e) {\r\n            e.preventDefault();\r\n            var toggleElement = $(this);\r\n            var forumId = toggleElement.data('forumid');\r\n            var discussionId = toggleElement.data('discussionid');\r\n            var state = toggleElement.data('targetstate');\r\n            Repository.setPinDiscussionState(forumId, discussionId, state)\r\n                .then(function() {\r\n                    return location.reload();\r\n                })\r\n                .catch(Notification.exception);\r\n        });\r\n\r\n        root.on('click', Selectors.lock.toggle, function(e) {\r\n            var toggleElement = $(this);\r\n            var forumId = toggleElement.data('forumid');\r\n            var discussionId = toggleElement.data('discussionid');\r\n            var state = toggleElement.data('state');\r\n\r\n            Repository.setDiscussionLockState(forumId, discussionId, state)\r\n                .then(function(context) {\r\n                    var icon = toggleElement.parents(Selectors.summary.actions).find(Selectors.lock.icon);\r\n                    var lockedLabel = toggleElement.parents(Selectors.discussion.item).find(Selectors.discussion.lockedLabel);\r\n                    if (context.locked) {\r\n                        icon.removeClass('hidden');\r\n                        lockedLabel.removeAttr('hidden');\r\n                    } else {\r\n                        icon.addClass('hidden');\r\n                        lockedLabel.attr('hidden', true);\r\n                    }\r\n                    return context;\r\n                })\r\n                .then(function(context) {\r\n                    context.forumid = forumId;\r\n                    return Templates.render('mod_forum/discussion_lock_toggle', context);\r\n                })\r\n                .then(function(html, js) {\r\n                    return Templates.replaceNode(toggleElement, html, js);\r\n                })\r\n                .then(function() {\r\n                    return Str.get_string('lockupdated', 'forum')\r\n                        .done(function(s) {\r\n                            return Notification.addNotification({\r\n                                message: s,\r\n                                type: \"info\"\r\n                            });\r\n                        });\r\n                })\r\n                .catch(Notification.exception);\r\n\r\n            e.preventDefault();\r\n        });\r\n    };\r\n\r\n    return {\r\n        init: function(root) {\r\n            SubscriptionToggle.init(root, false, function(toggleElement, context) {\r\n                var toggleId = toggleElement.attr('id');\r\n                var newTargetState = context.userstate.subscribed ? 0 : 1;\r\n                toggleElement.data('targetstate', newTargetState);\r\n\r\n                var stringKey = context.userstate.subscribed ? 'unsubscribediscussion' : 'subscribediscussion';\r\n                return Str.get_string(stringKey, 'mod_forum')\r\n                    .then(function(string) {\r\n                        toggleElement.closest('td').find('label[for=\"' + toggleId + '\"]').find('span').text(string);\r\n                        return string;\r\n                    });\r\n            });\r\n            registerEventListeners(root);\r\n        }\r\n    };\r\n});\r\n"],"names":["define","$","Templates","Str","Notification","SubscriptionToggle","Selectors","Repository","PubSub","ForumEvents","init","root","toggleElement","context","toggleId","attr","newTargetState","userstate","subscribed","data","stringKey","get_string","then","string","closest","find","text","subscribe","SUBSCRIPTION_TOGGLED","discussionId","subscriptionState","discussionListItem","discussion","item","subscribedLabel","addClass","removeAttr","removeClass","on","favourite","toggle","e","preventDefault","this","forumId","setFavouriteDiscussionState","location","reload","catch","exception","pin","state","setPinDiscussionState","lock","setDiscussionLockState","icon","parents","summary","actions","lockedLabel","locked","forumid","render","html","js","replaceNode","done","s","addNotification","message","type","registerEventListeners"],"mappings":";;;;;;;AAsBAA,mCAAO,CACH,SACA,iBACA,WACA,oBACA,gCACA,sBACA,uBACA,cACA,2BACD,SACCC,EACAC,UACAC,IACAC,aACAC,mBACAC,UACAC,WACAC,OACAC,mBAqFO,CACHC,KAAM,SAASC,MACXN,mBAAmBK,KAAKC,MAAM,GAAO,SAASC,cAAeC,aACrDC,SAAWF,cAAcG,KAAK,MAC9BC,eAAiBH,QAAQI,UAAUC,WAAa,EAAI,EACxDN,cAAcO,KAAK,cAAeH,oBAE9BI,UAAYP,QAAQI,UAAUC,WAAa,wBAA0B,6BAClEf,IAAIkB,WAAWD,UAAW,aAC5BE,MAAK,SAASC,eACXX,cAAcY,QAAQ,MAAMC,KAAK,cAAgBX,SAAW,MAAMW,KAAK,QAAQC,KAAKH,QAC7EA,aA9FE,SAASZ,MAClCH,OAAOmB,UAAUlB,YAAYmB,sBAAsB,SAAST,UACpDU,aAAeV,KAAKU,aACpBX,WAAaC,KAAKW,kBAClBC,mBAAqBpB,KAAKc,KAAKnB,UAAU0B,WAAWC,KAAO,uBAAyBJ,aAAe,KACnGK,gBAAkBH,mBAAmBN,KAAKnB,UAAU0B,WAAWE,iBAC/DhB,YACAa,mBAAmBI,SAAS,cAC5BD,gBAAgBE,WAAW,YAE3BL,mBAAmBM,YAAY,cAC/BH,gBAAgBnB,KAAK,UAAU,OAIvCJ,KAAK2B,GAAG,QAAShC,UAAUiC,UAAUC,QAAQ,SAASC,GAClDA,EAAEC,qBAEE9B,cAAgBX,EAAE0C,MAClBC,QAAUhC,cAAcO,KAAK,WAC7BU,aAAejB,cAAcO,KAAK,gBAClCW,kBAAoBlB,cAAcO,KAAK,eAC3CZ,WAAWsC,4BAA4BD,QAASf,aAAcC,mBACzDR,MAAK,kBACKwB,SAASC,YAEnBC,MAAM5C,aAAa6C,cAG5BtC,KAAK2B,GAAG,QAAShC,UAAU4C,IAAIV,QAAQ,SAASC,GAC5CA,EAAEC,qBACE9B,cAAgBX,EAAE0C,MAClBC,QAAUhC,cAAcO,KAAK,WAC7BU,aAAejB,cAAcO,KAAK,gBAClCgC,MAAQvC,cAAcO,KAAK,eAC/BZ,WAAW6C,sBAAsBR,QAASf,aAAcsB,OACnD7B,MAAK,kBACKwB,SAASC,YAEnBC,MAAM5C,aAAa6C,cAG5BtC,KAAK2B,GAAG,QAAShC,UAAU+C,KAAKb,QAAQ,SAASC,OACzC7B,cAAgBX,EAAE0C,MAClBC,QAAUhC,cAAcO,KAAK,WAC7BU,aAAejB,cAAcO,KAAK,gBAClCgC,MAAQvC,cAAcO,KAAK,SAE/BZ,WAAW+C,uBAAuBV,QAASf,aAAcsB,OACpD7B,MAAK,SAAST,aACP0C,KAAO3C,cAAc4C,QAAQlD,UAAUmD,QAAQC,SAASjC,KAAKnB,UAAU+C,KAAKE,MAC5EI,YAAc/C,cAAc4C,QAAQlD,UAAU0B,WAAWC,MAAMR,KAAKnB,UAAU0B,WAAW2B,oBACzF9C,QAAQ+C,QACRL,KAAKlB,YAAY,UACjBsB,YAAYvB,WAAW,YAEvBmB,KAAKpB,SAAS,UACdwB,YAAY5C,KAAK,UAAU,IAExBF,WAEVS,MAAK,SAAST,gBACXA,QAAQgD,QAAUjB,QACX1C,UAAU4D,OAAO,mCAAoCjD,YAE/DS,MAAK,SAASyC,KAAMC,WACV9D,UAAU+D,YAAYrD,cAAemD,KAAMC,OAErD1C,MAAK,kBACKnB,IAAIkB,WAAW,cAAe,SAChC6C,MAAK,SAASC,UACJ/D,aAAagE,gBAAgB,CAChCC,QAASF,EACTG,KAAM,eAIrBtB,MAAM5C,aAAa6C,WAExBR,EAAEC,oBAkBF6B,CAAuB5D"}