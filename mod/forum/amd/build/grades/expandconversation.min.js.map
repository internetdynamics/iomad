{"version":3,"file":"expandconversation.min.js","sources":["../../src/grades/expandconversation.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * This module handles the creation of a Modal that shows the user's post in context of the entire discussion.\r\n *\r\n * @module     mod_forum/grades/expandconversation\r\n * @copyright  2019 Mathew May <mathew.solutions>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\nimport * as ForumSelectors from './grader/selectors';\r\nimport Repository from 'mod_forum/repository';\r\nimport {exception as showException} from \"core/notification\";\r\nimport Templates from 'core/templates';\r\nimport * as Modal from 'core/modal_factory';\r\nimport * as ModalEvents from 'core/modal_events';\r\n\r\n/**\r\n * Find the Node containing the gradable details from the provided node by searching up the tree.\r\n *\r\n * @param {HTMLElement} node\r\n * @returns {HTMLElement}\r\n */\r\nconst findGradableNode = node => node.closest(ForumSelectors.expandConversation);\r\n\r\n/**\r\n * Show the post in context in a modal.\r\n *\r\n * @param {HTMLElement} rootNode The button that has been clicked\r\n * @param {object} param\r\n * @param {bool} [param.focusOnClose=null]\r\n */\r\nconst showPostInContext = async(rootNode, {\r\n    focusOnClose = null,\r\n} = {}) => {\r\n    const postId = rootNode.dataset.postid;\r\n    const discussionId = rootNode.dataset.discussionid;\r\n    const discussionName = rootNode.dataset.name;\r\n    const experimentalDisplayMode = rootNode.dataset.experimentalDisplayMode == \"1\";\r\n\r\n    const [\r\n        allPosts,\r\n        modal,\r\n    ] = await Promise.all([\r\n        Repository.getDiscussionPosts(parseInt(discussionId)),\r\n        Modal.create({\r\n            title: discussionName,\r\n            large: true,\r\n            type: Modal.types.CANCEL\r\n        }),\r\n    ]);\r\n\r\n    const postsById = new Map(allPosts.posts.map(post => {\r\n        post.readonly = true;\r\n        post.hasreplies = false;\r\n        post.replies = [];\r\n        return [post.id, post];\r\n    }));\r\n\r\n    let posts = [];\r\n    allPosts.posts.forEach(post => {\r\n        if (post.parentid) {\r\n            const parent = postsById.get(post.parentid);\r\n            if (parent) {\r\n                post.parentauthorname = parent.author.fullname;\r\n                parent.hasreplies = true;\r\n                parent.replies.push(post);\r\n            } else {\r\n                posts.push(post);\r\n            }\r\n        } else {\r\n            posts.push(post);\r\n        }\r\n    });\r\n\r\n    // Handle hidden event.\r\n    modal.getRoot().on(ModalEvents.hidden, function() {\r\n        // Destroy when hidden.\r\n        modal.destroy();\r\n        try {\r\n            focusOnClose.focus();\r\n        } catch (e) {\r\n            // eslint-disable-line\r\n        }\r\n    });\r\n\r\n    modal.getRoot().on(ModalEvents.bodyRendered, () => {\r\n        const relevantPost = modal.getRoot()[0].querySelector(`#p${postId}`);\r\n        if (relevantPost) {\r\n            relevantPost.scrollIntoView({behavior: \"smooth\"});\r\n        }\r\n    });\r\n\r\n    modal.show();\r\n\r\n    // Note: We do not use await here because it messes with the Modal transitions.\r\n    const templatePromise = Templates.render('mod_forum/grades/grader/discussion/post_modal', {\r\n        posts,\r\n        experimentaldisplaymode: experimentalDisplayMode\r\n    });\r\n    modal.setBody(templatePromise);\r\n};\r\n\r\n/**\r\n * Register event listeners for the expand conversations button.\r\n *\r\n * @param {HTMLElement} rootNode The root to listen to.\r\n */\r\nexport const registerEventListeners = (rootNode) => {\r\n    rootNode.addEventListener('click', (e) => {\r\n        const rootNode = findGradableNode(e.target);\r\n\r\n        if (rootNode) {\r\n            e.preventDefault();\r\n\r\n            try {\r\n                showPostInContext(rootNode, {\r\n                    focusOnClose: e.target,\r\n                });\r\n            } catch (err) {\r\n                showException(err);\r\n            }\r\n        }\r\n    });\r\n};\r\n"],"names":["rootNode","addEventListener","e","target","closest","ForumSelectors","expandConversation","preventDefault","async","focusOnClose","postId","dataset","postid","discussionId","discussionid","discussionName","name","experimentalDisplayMode","allPosts","modal","Promise","all","Repository","getDiscussionPosts","parseInt","Modal","create","title","large","type","types","CANCEL","postsById","Map","posts","map","post","readonly","hasreplies","replies","id","forEach","parentid","parent","get","parentauthorname","author","fullname","push","getRoot","on","ModalEvents","hidden","destroy","focus","bodyRendered","relevantPost","querySelector","scrollIntoView","behavior","show","templatePromise","Templates","render","experimentaldisplaymode","setBody","showPostInContext","err"],"mappings":";;;;;;;+WAwHuCA,WACnCA,SAASC,iBAAiB,SAAUC,UAC1BF,SAA4BE,EAAEC,OAvFNC,QAAQC,eAAeC,uBAyFjDN,SAAU,CACVE,EAAEK,sBAjFYC,eAAMR,cAAUS,aACtCA,aAAe,6DACf,SACMC,OAASV,SAASW,QAAQC,OAC1BC,aAAeb,SAASW,QAAQG,aAChCC,eAAiBf,SAASW,QAAQK,KAClCC,wBAAsE,KAA5CjB,SAASW,QAAQM,yBAG7CC,SACAC,aACMC,QAAQC,IAAI,CAClBC,oBAAWC,mBAAmBC,SAASX,eACvCY,MAAMC,OAAO,CACTC,MAAOZ,eACPa,OAAO,EACPC,KAAMJ,MAAMK,MAAMC,WAIpBC,UAAY,IAAIC,IAAIf,SAASgB,MAAMC,KAAIC,OACzCA,KAAKC,UAAW,EAChBD,KAAKE,YAAa,EAClBF,KAAKG,QAAU,GACR,CAACH,KAAKI,GAAIJ,cAGjBF,MAAQ,GACZhB,SAASgB,MAAMO,SAAQL,UACfA,KAAKM,SAAU,OACTC,OAASX,UAAUY,IAAIR,KAAKM,UAC9BC,QACAP,KAAKS,iBAAmBF,OAAOG,OAAOC,SACtCJ,OAAOL,YAAa,EACpBK,OAAOJ,QAAQS,KAAKZ,OAEpBF,MAAMc,KAAKZ,WAGfF,MAAMc,KAAKZ,SAKnBjB,MAAM8B,UAAUC,GAAGC,YAAYC,QAAQ,WAEnCjC,MAAMkC,cAEF5C,aAAa6C,QACf,MAAOpD,QAKbiB,MAAM8B,UAAUC,GAAGC,YAAYI,cAAc,WACnCC,aAAerC,MAAM8B,UAAU,GAAGQ,0BAAmB/C,SACvD8C,cACAA,aAAaE,eAAe,CAACC,SAAU,cAI/CxC,MAAMyC,aAGAC,gBAAkBC,mBAAUC,OAAO,gDAAiD,CACtF7B,MAAAA,MACA8B,wBAAyB/C,0BAE7BE,MAAM8C,QAAQJ,iBAgBFK,CAAkBlE,SAAU,CACxBS,aAAcP,EAAEC,SAEtB,MAAOgE,iCACSA"}