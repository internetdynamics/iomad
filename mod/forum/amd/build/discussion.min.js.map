{"version":3,"file":"discussion.min.js","sources":["../src/discussion.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Module for viewing a discussion.\r\n *\r\n * @module     mod_forum/discussion\r\n * @copyright  2019 Ryan Wyllie <ryan@moodle.com>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\ndefine(\r\n[\r\n    'jquery',\r\n    'core/custom_interaction_events',\r\n    'mod_forum/selectors',\r\n    'core/pubsub',\r\n    'mod_forum/forum_events',\r\n    'core/str',\r\n    'core/notification',\r\n],\r\nfunction(\r\n    $,\r\n    CustomEvents,\r\n    Selectors,\r\n    PubSub,\r\n    ForumEvents,\r\n    String,\r\n    Notification\r\n) {\r\n\r\n    /**\r\n     * Set the focus on the previous post in the list. Previous post is calculated\r\n     * based on position in list as viewed top to bottom.\r\n     *\r\n     * @param {Object} currentPost The post that currently has focus\r\n     */\r\n    var focusPreviousPost = function(currentPost) {\r\n        // See if there is a previous sibling post.\r\n        var prevPost = currentPost.prev(Selectors.post.post);\r\n\r\n        if (prevPost.length) {\r\n            // The previous post might have replies that appear visually between\r\n            // it and the current post (see nested view) so if that's the case\r\n            // then the last reply will be the previous post in the list.\r\n            var replyPost = prevPost.find(Selectors.post.post).last();\r\n\r\n            if (replyPost.length) {\r\n                // Focus the last reply.\r\n                replyPost.focus();\r\n            } else {\r\n                // No replies so we can focus straight on the sibling.\r\n                prevPost.focus();\r\n            }\r\n        } else {\r\n            // If there are no siblings then jump up the tree to the parent\r\n            // post and focus the first parent post we find.\r\n            currentPost.parents(Selectors.post.post).first().focus();\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Set the focus on the next post in the list. Previous post is calculated\r\n     * based on position in list as viewed top to bottom.\r\n     *\r\n     * @param {Object} currentPost The post that currently has focus\r\n     */\r\n    var focusNextPost = function(currentPost) {\r\n        // The next post in the visual list would be the first reply to this one\r\n        // so let's see if we have one.\r\n        var replyPost = currentPost.find(Selectors.post.post).first();\r\n\r\n        if (replyPost.length) {\r\n            // Got a reply.\r\n            replyPost.focus();\r\n        } else {\r\n            // If we don't have a reply then the next post in the visual list would\r\n            // be a sibling post (replying to the same parent).\r\n            var siblingPost = currentPost.next(Selectors.post.post);\r\n\r\n            if (siblingPost.length) {\r\n                siblingPost.focus();\r\n            } else {\r\n                // No siblings either. That means we're the lowest level reply in a thread\r\n                // so we need to walk back up the tree of posts and find an ancestor post that\r\n                // has a sibling post we can focus.\r\n                var parentPosts = currentPost.parents(Selectors.post.post).toArray();\r\n\r\n                for (var i = 0; i < parentPosts.length; i++) {\r\n                    var ancestorSiblingPost = $(parentPosts[i]).next(Selectors.post.post);\r\n\r\n                    if (ancestorSiblingPost.length) {\r\n                        ancestorSiblingPost.focus();\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Check if the element is inside the in page reply section.\r\n     *\r\n     * @param {Object} element The element to check\r\n     * @return {Boolean}\r\n     */\r\n    var isElementInInPageReplySection = function(element) {\r\n        var inPageReply = $(element).closest(Selectors.post.inpageReplyContent);\r\n        return inPageReply.length ? true : false;\r\n    };\r\n\r\n    /**\r\n     * Initialise the keyboard accessibility controls for the discussion.\r\n     *\r\n     * @param {Object} root The discussion root element\r\n     */\r\n    var initAccessibilityKeyboardNav = function(root) {\r\n        var posts = root.find(Selectors.post.post);\r\n\r\n        // Take each post action out of the tab index.\r\n        posts.each(function(index, post) {\r\n            var actions = $(post).find(Selectors.post.action);\r\n            var firstAction = actions.first();\r\n            actions.attr('tabindex', '-1');\r\n            firstAction.attr('tabindex', 0);\r\n        });\r\n\r\n        CustomEvents.define(root, [\r\n            CustomEvents.events.up,\r\n            CustomEvents.events.down,\r\n            CustomEvents.events.next,\r\n            CustomEvents.events.previous,\r\n            CustomEvents.events.home,\r\n            CustomEvents.events.end,\r\n        ]);\r\n\r\n        root.on(CustomEvents.events.up, function(e, data) {\r\n            var activeElement = document.activeElement;\r\n\r\n            if (isElementInInPageReplySection(activeElement)) {\r\n                // Focus is currently inside the in page reply section so don't move focus\r\n                // to another post.\r\n                return;\r\n            }\r\n\r\n            var focusPost = $(activeElement).closest(Selectors.post.post);\r\n\r\n            if (focusPost.length) {\r\n                focusPreviousPost(focusPost);\r\n            } else {\r\n                root.find(Selectors.post.post).first().focus();\r\n            }\r\n\r\n            data.originalEvent.preventDefault();\r\n        });\r\n\r\n        root.on(CustomEvents.events.down, function(e, data) {\r\n            var activeElement = document.activeElement;\r\n\r\n            if (isElementInInPageReplySection(activeElement)) {\r\n                // Focus is currently inside the in page reply section so don't move focus\r\n                // to another post.\r\n                return;\r\n            }\r\n\r\n            var focusPost = $(activeElement).closest(Selectors.post.post);\r\n\r\n            if (focusPost.length) {\r\n                focusNextPost(focusPost);\r\n            } else {\r\n                root.find(Selectors.post.post).first().focus();\r\n            }\r\n\r\n            data.originalEvent.preventDefault();\r\n        });\r\n\r\n        root.on(CustomEvents.events.home, function(e, data) {\r\n            if (isElementInInPageReplySection(document.activeElement)) {\r\n                // Focus is currently inside the in page reply section so don't move focus\r\n                // to another post.\r\n                return;\r\n            }\r\n            root.find(Selectors.post.post).first().focus();\r\n            data.originalEvent.preventDefault();\r\n        });\r\n\r\n        root.on(CustomEvents.events.end, function(e, data) {\r\n            if (isElementInInPageReplySection(document.activeElement)) {\r\n                // Focus is currently inside the in page reply section so don't move focus\r\n                // to another post.\r\n                return;\r\n            }\r\n            root.find(Selectors.post.post).last().focus();\r\n            data.originalEvent.preventDefault();\r\n        });\r\n\r\n        root.on(CustomEvents.events.next, Selectors.post.action, function(e, data) {\r\n            var currentAction = $(e.target);\r\n            var container = currentAction.closest(Selectors.post.actionsContainer);\r\n            var actions = container.find(Selectors.post.action);\r\n            var nextAction = currentAction.next(Selectors.post.action);\r\n\r\n            actions.attr('tabindex', '-1');\r\n\r\n            if (!nextAction.length) {\r\n                nextAction = actions.first();\r\n            }\r\n\r\n            nextAction.attr('tabindex', 0);\r\n            nextAction.focus();\r\n\r\n            data.originalEvent.preventDefault();\r\n        });\r\n\r\n        root.on(CustomEvents.events.previous, Selectors.post.action, function(e, data) {\r\n            var currentAction = $(e.target);\r\n            var container = currentAction.closest(Selectors.post.actionsContainer);\r\n            var actions = container.find(Selectors.post.action);\r\n            var nextAction = currentAction.prev(Selectors.post.action);\r\n\r\n            actions.attr('tabindex', '-1');\r\n\r\n            if (!nextAction.length) {\r\n                nextAction = actions.last();\r\n            }\r\n\r\n            nextAction.attr('tabindex', 0);\r\n            nextAction.focus();\r\n\r\n            data.originalEvent.preventDefault();\r\n        });\r\n\r\n        root.on(CustomEvents.events.home, Selectors.post.action, function(e, data) {\r\n            var currentAction = $(e.target);\r\n            var container = currentAction.closest(Selectors.post.actionsContainer);\r\n            var actions = container.find(Selectors.post.action);\r\n            var firstAction = actions.first();\r\n\r\n            actions.attr('tabindex', '-1');\r\n            firstAction.attr('tabindex', 0);\r\n            firstAction.focus();\r\n\r\n            e.stopPropagation();\r\n            data.originalEvent.preventDefault();\r\n        });\r\n\r\n        root.on(CustomEvents.events.end, Selectors.post.action, function(e, data) {\r\n            var currentAction = $(e.target);\r\n            var container = currentAction.closest(Selectors.post.actionsContainer);\r\n            var actions = container.find(Selectors.post.action);\r\n            var lastAction = actions.last();\r\n\r\n            actions.attr('tabindex', '-1');\r\n            lastAction.attr('tabindex', 0);\r\n            lastAction.focus();\r\n\r\n            e.stopPropagation();\r\n            data.originalEvent.preventDefault();\r\n        });\r\n\r\n        PubSub.subscribe(ForumEvents.SUBSCRIPTION_TOGGLED, function(data) {\r\n            var subscribed = data.subscriptionState;\r\n            var updateMessage = subscribed ? 'discussionsubscribed' : 'discussionunsubscribed';\r\n            String.get_string(updateMessage, \"forum\")\r\n                .then(function(s) {\r\n                    return Notification.addNotification({\r\n                        message: s,\r\n                        type: \"info\"\r\n                    });\r\n                })\r\n                .catch(Notification.exception);\r\n        });\r\n    };\r\n\r\n    return {\r\n        init: function(root) {\r\n            initAccessibilityKeyboardNav(root);\r\n        }\r\n    };\r\n});\r\n"],"names":["define","$","CustomEvents","Selectors","PubSub","ForumEvents","String","Notification","isElementInInPageReplySection","element","closest","post","inpageReplyContent","length","initAccessibilityKeyboardNav","root","find","each","index","actions","action","firstAction","first","attr","events","up","down","next","previous","home","end","on","e","data","activeElement","document","focusPost","currentPost","prevPost","prev","replyPost","last","focus","parents","focusPreviousPost","originalEvent","preventDefault","siblingPost","parentPosts","toArray","i","ancestorSiblingPost","focusNextPost","currentAction","target","actionsContainer","nextAction","stopPropagation","lastAction","subscribe","SUBSCRIPTION_TOGGLED","updateMessage","subscriptionState","get_string","then","s","addNotification","message","type","catch","exception","init"],"mappings":"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"}