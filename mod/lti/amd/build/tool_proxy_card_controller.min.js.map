{"version":3,"file":"tool_proxy_card_controller.min.js","sources":["../src/tool_proxy_card_controller.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Controls all of the behaviour and interaction with a tool type card. These are\r\n * listed on the LTI tool type management page.\r\n *\r\n * See template: mod_lti/tool_proxy_card\r\n *\r\n * @module     mod_lti/tool_proxy_card_controller\r\n * @copyright  2016 John Okely <john@moodle.com>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n * @since      3.1\r\n */\r\ndefine(['jquery', 'core/ajax', 'core/notification', 'core/templates', 'mod_lti/tool_proxy', 'mod_lti/events', 'mod_lti/keys',\r\n        'core/str'],\r\n        function($, ajax, notification, templates, toolProxy, ltiEvents, KEYS, str) {\r\n\r\n    var SELECTORS = {\r\n        DELETE_BUTTON: '.delete',\r\n        CAPABILITIES_CONTAINER: '.capabilities-container',\r\n        ACTIVATE_BUTTON: '.tool-card-footer a.activate',\r\n    };\r\n\r\n    // Timeout in seconds.\r\n    var ANNOUNCEMENT_TIMEOUT = 2000;\r\n\r\n    /**\r\n     * Return the delete button element.\r\n     *\r\n     * @method getDeleteButton\r\n     * @private\r\n     * @param {JQuery} element jQuery object representing the tool card.\r\n     * @return {JQuery} jQuery object\r\n     */\r\n    var getDeleteButton = function(element) {\r\n        return element.find(SELECTORS.DELETE_BUTTON);\r\n    };\r\n\r\n    /**\r\n     * Return the activate button for the type.\r\n     *\r\n     * @method getActivateButton\r\n     * @private\r\n     * @param {JQuery} element jQuery object representing the tool card.\r\n     * @return {JQuery}  jQuery object\r\n     */\r\n    var getActivateButton = function(element) {\r\n        return element.find(SELECTORS.ACTIVATE_BUTTON);\r\n    };\r\n\r\n    /**\r\n     * Get the type id.\r\n     *\r\n     * @method getTypeId\r\n     * @private\r\n     * @param {JQuery} element jQuery object representing the tool card.\r\n     * @return {String} Type ID\r\n     */\r\n    var getTypeId = function(element) {\r\n        return element.attr('data-proxy-id');\r\n    };\r\n\r\n    /**\r\n     * Stop any announcement currently visible on the card.\r\n     *\r\n     * @method clearAllAnnouncements\r\n     * @private\r\n     * @param {JQuery} element jQuery object representing the tool card.\r\n     */\r\n    var clearAllAnnouncements = function(element) {\r\n        element.removeClass('announcement loading success fail capabilities');\r\n    };\r\n\r\n    /**\r\n     * Show the loading announcement.\r\n     *\r\n     * @method startLoading\r\n     * @private\r\n     * @param {JQuery} element jQuery object representing the tool card.\r\n     */\r\n    var startLoading = function(element) {\r\n        clearAllAnnouncements(element);\r\n        element.addClass('announcement loading');\r\n    };\r\n\r\n    /**\r\n     * Hide the loading announcement.\r\n     *\r\n     * @method stopLoading\r\n     * @private\r\n     * @param {JQuery} element jQuery object representing the tool card.\r\n     */\r\n    var stopLoading = function(element) {\r\n        element.removeClass('announcement loading');\r\n    };\r\n\r\n    /**\r\n     * Show the success announcement. The announcement is only\r\n     * visible for 2 seconds.\r\n     *\r\n     * @method announceSuccess\r\n     * @private\r\n     * @param {JQuery} element jQuery object representing the tool card.\r\n     * @return {Promise} jQuery Deferred object\r\n     */\r\n    var announceSuccess = function(element) {\r\n        var promise = $.Deferred();\r\n\r\n        clearAllAnnouncements(element);\r\n        element.addClass('announcement success');\r\n        setTimeout(function() {\r\n            element.removeClass('announcement success');\r\n            promise.resolve();\r\n        }, ANNOUNCEMENT_TIMEOUT);\r\n\r\n        return promise;\r\n    };\r\n\r\n    /**\r\n     * Show the failure announcement. The announcement is only\r\n     * visible for 2 seconds.\r\n     *\r\n     * @method announceFailure\r\n     * @private\r\n     * @param {JQuery} element jQuery object representing the tool card.\r\n     * @return {Promise} jQuery Deferred object\r\n     */\r\n    var announceFailure = function(element) {\r\n        var promise = $.Deferred();\r\n\r\n        clearAllAnnouncements(element);\r\n        element.addClass('announcement fail');\r\n        setTimeout(function() {\r\n                element.removeClass('announcement fail');\r\n                promise.resolve();\r\n            }, ANNOUNCEMENT_TIMEOUT);\r\n\r\n        return promise;\r\n    };\r\n\r\n    /**\r\n     * Delete the tool type from the Moodle server. Triggers a success\r\n     * or failure announcement depending on the result.\r\n     *\r\n     * @method deleteType\r\n     * @private\r\n     * @param {JQuery} element jQuery object representing the tool card.\r\n     * @return {Promise} jQuery Deferred object\r\n     */\r\n    var deleteType = function(element) {\r\n        var promise = $.Deferred();\r\n        var typeId = getTypeId(element);\r\n        startLoading(element);\r\n\r\n        if (typeId === \"\") {\r\n            return $.Deferred().resolve();\r\n        }\r\n\r\n        str.get_strings([\r\n                {\r\n                    key: 'delete',\r\n                    component: 'mod_lti'\r\n                },\r\n                {\r\n                    key: 'delete_confirmation',\r\n                    component: 'mod_lti'\r\n                },\r\n                {\r\n                    key: 'delete',\r\n                    component: 'mod_lti'\r\n                },\r\n                {\r\n                    key: 'cancel',\r\n                    component: 'core'\r\n                },\r\n            ])\r\n            .done(function(strs) {\r\n                    notification.confirm(strs[0], strs[1], strs[2], strs[3], function() {\r\n                            toolProxy.delete(typeId)\r\n                                .done(function() {\r\n                                        stopLoading(element);\r\n                                        announceSuccess(element)\r\n                                            .done(function() {\r\n                                                    element.remove();\r\n                                                    promise.resolve();\r\n                                                })\r\n                                            .fail(notification.exception);\r\n                                    })\r\n                                .fail(function(error) {\r\n                                        announceFailure(element);\r\n                                        promise.reject(error);\r\n                                    });\r\n                    }, function() {\r\n                            stopLoading(element);\r\n                            promise.resolve();\r\n                        });\r\n                })\r\n            .fail(function(error) {\r\n                    stopLoading(element);\r\n                    notification.exception(error);\r\n                    promise.reject(error);\r\n                });\r\n\r\n        return promise;\r\n    };\r\n\r\n    /**\r\n     * The user wishes to activate this tool so show them the capabilities that\r\n     * they need to agree to or if there are none then set the tool type's state\r\n     * to active.\r\n     *\r\n     * @method activateToolType\r\n     * @private\r\n     * @param {JQuery} element jQuery object representing the tool card.\r\n     */\r\n    var activateToolType = function(element) {\r\n        var data = {proxyid: getTypeId(element)};\r\n        $(document).trigger(ltiEvents.START_EXTERNAL_REGISTRATION, data);\r\n    };\r\n\r\n    /**\r\n     * Sets up the listeners for user interaction on this tool type card.\r\n     *\r\n     * @method registerEventListeners\r\n     * @private\r\n     * @param {JQuery} element jQuery object representing the tool card.\r\n     */\r\n    var registerEventListeners = function(element) {\r\n        var deleteButton = getDeleteButton(element);\r\n        deleteButton.click(function(e) {\r\n                e.preventDefault();\r\n                deleteType(element);\r\n            });\r\n        deleteButton.keypress(function(e) {\r\n                if (!e.metaKey && !e.shiftKey && !e.altKey && !e.ctrlKey) {\r\n                    if (e.keyCode == KEYS.ENTER || e.keyCode == KEYS.SPACE) {\r\n                        e.preventDefault();\r\n                        deleteButton.click();\r\n                    }\r\n                }\r\n            });\r\n\r\n        var activateButton = getActivateButton(element);\r\n        activateButton.click(function(e) {\r\n                e.preventDefault();\r\n                activateToolType(element);\r\n            });\r\n        activateButton.keypress(function(e) {\r\n                if (!e.metaKey && !e.shiftKey && !e.altKey && !e.ctrlKey) {\r\n                    if (e.keyCode == KEYS.ENTER || e.keyCode == KEYS.SPACE) {\r\n                        e.preventDefault();\r\n                        activateButton.click();\r\n                    }\r\n                }\r\n            });\r\n    };\r\n\r\n    return /** @alias module:mod_lti/tool_card_controller */ {\r\n\r\n        /**\r\n         * Initialise this module.\r\n         *\r\n         * @param {JQuery} element jQuery object representing the tool card.\r\n         */\r\n        init: function(element) {\r\n            registerEventListeners(element);\r\n        }\r\n    };\r\n});\r\n"],"names":["define","$","ajax","notification","templates","toolProxy","ltiEvents","KEYS","str","SELECTORS","getTypeId","element","attr","clearAllAnnouncements","removeClass","stopLoading","deleteType","promise","Deferred","typeId","addClass","startLoading","resolve","get_strings","key","component","done","strs","confirm","delete","setTimeout","announceSuccess","remove","fail","exception","error","announceFailure","reject","registerEventListeners","deleteButton","find","getDeleteButton","click","e","preventDefault","keypress","metaKey","shiftKey","altKey","ctrlKey","keyCode","ENTER","SPACE","activateButton","getActivateButton","data","proxyid","document","trigger","START_EXTERNAL_REGISTRATION","activateToolType","init"],"mappings":";;;;;;;;;;;AA0BAA,4CAAO,CAAC,SAAU,YAAa,oBAAqB,iBAAkB,qBAAsB,iBAAkB,eACtG,aACA,SAASC,EAAGC,KAAMC,aAAcC,UAAWC,UAAWC,UAAWC,KAAMC,SAEvEC,wBACe,UADfA,0BAGiB,+BAsCjBC,UAAY,SAASC,gBACdA,QAAQC,KAAK,kBAUpBC,sBAAwB,SAASF,SACjCA,QAAQG,YAAY,mDAsBpBC,YAAc,SAASJ,SACvBA,QAAQG,YAAY,yBAwDpBE,WAAa,SAASL,aAClBM,QAAUhB,EAAEiB,WACZC,OAAST,UAAUC,gBAvER,SAASA,SACxBE,sBAAsBF,SACtBA,QAAQS,SAAS,wBAsEjBC,CAAaV,SAEE,KAAXQ,OACOlB,EAAEiB,WAAWI,WAGxBd,IAAIe,YAAY,CACR,CACIC,IAAK,SACLC,UAAW,WAEf,CACID,IAAK,sBACLC,UAAW,WAEf,CACID,IAAK,SACLC,UAAW,WAEf,CACID,IAAK,SACLC,UAAW,UAGlBC,MAAK,SAASC,MACPxB,aAAayB,QAAQD,KAAK,GAAIA,KAAK,GAAIA,KAAK,GAAIA,KAAK,IAAI,WACjDtB,UAAUwB,OAAOV,QACZO,MAAK,WACEX,YAAYJ,SA3E1B,SAASA,aACvBM,QAAUhB,EAAEiB,kBAEhBL,sBAAsBF,SACtBA,QAAQS,SAAS,wBACjBU,YAAW,WACPnB,QAAQG,YAAY,wBACpBG,QAAQK,YAxFW,KA2FhBL,QAkEyBc,CAAgBpB,SACXe,MAAK,WACEf,QAAQqB,SACRf,QAAQK,aAEfW,KAAK9B,aAAa+B,cAE9BD,MAAK,SAASE,QA7DrB,SAASxB,aACvBM,QAAUhB,EAAEiB,WAEhBL,sBAAsBF,SACtBA,QAAQS,SAAS,qBACjBU,YAAW,WACHnB,QAAQG,YAAY,qBACpBG,QAAQK,YA9GO,KAqKSc,CAAgBzB,SAChBM,QAAQoB,OAAOF,aAEhC,WACKpB,YAAYJ,SACZM,QAAQK,gBAGvBW,MAAK,SAASE,OACPpB,YAAYJ,SACZR,aAAa+B,UAAUC,OACvBlB,QAAQoB,OAAOF,UAGpBlB,UAwBPqB,uBAAyB,SAAS3B,aAC9B4B,aAlMc,SAAS5B,gBACpBA,QAAQ6B,KAAK/B,yBAiMDgC,CAAgB9B,SACnC4B,aAAaG,OAAM,SAASC,GACpBA,EAAEC,iBACF5B,WAAWL,YAEnB4B,aAAaM,UAAS,SAASF,GAClBA,EAAEG,SAAYH,EAAEI,UAAaJ,EAAEK,QAAWL,EAAEM,SACzCN,EAAEO,SAAW3C,KAAK4C,OAASR,EAAEO,SAAW3C,KAAK6C,QAC7CT,EAAEC,iBACFL,aAAaG,gBAKzBW,eApMgB,SAAS1C,gBACtBA,QAAQ6B,KAAK/B,2BAmMC6C,CAAkB3C,SACvC0C,eAAeX,OAAM,SAASC,GACtBA,EAAEC,iBA7BS,SAASjC,aACxB4C,KAAO,CAACC,QAAS9C,UAAUC,UAC/BV,EAAEwD,UAAUC,QAAQpD,UAAUqD,4BAA6BJ,MA4BnDK,CAAiBjD,YAEzB0C,eAAeR,UAAS,SAASF,GACpBA,EAAEG,SAAYH,EAAEI,UAAaJ,EAAEK,QAAWL,EAAEM,SACzCN,EAAEO,SAAW3C,KAAK4C,OAASR,EAAEO,SAAW3C,KAAK6C,QAC7CT,EAAEC,iBACFS,eAAeX,mBAMsB,CAOrDmB,KAAM,SAASlD,SACX2B,uBAAuB3B"}