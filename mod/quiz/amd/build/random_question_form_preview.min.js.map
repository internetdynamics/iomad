{"version":3,"file":"random_question_form_preview.min.js","sources":["../src/random_question_form_preview.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * JavaScript for the random_question_form_preview of the\r\n * add_random_form class.\r\n *\r\n * @module    mod_quiz/random_question_form_preview\r\n * @copyright 2018 Ryan Wyllie <ryan@moodle.com>\r\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\ndefine(\r\n    [\r\n        'jquery',\r\n        'core/ajax',\r\n        'core/str',\r\n        'core/notification',\r\n        'core/templates',\r\n        'core/paged_content_factory'\r\n    ],\r\n    function(\r\n        $,\r\n        Ajax,\r\n        Str,\r\n        Notification,\r\n        Templates,\r\n        PagedContentFactory\r\n    ) {\r\n\r\n    var ITEMS_PER_PAGE = 5;\r\n    var TEMPLATE_NAME = 'mod_quiz/random_question_form_preview_question_list';\r\n    var SELECTORS = {\r\n        LOADING_ICON_CONTAINER: '[data-region=\"overlay-icon-container\"]',\r\n        QUESTION_COUNT_CONTAINER: '[data-region=\"question-count-container\"]',\r\n        QUESTION_LIST_CONTAINER: '[data-region=\"question-list-container\"]'\r\n    };\r\n\r\n    /**\r\n     * Show the loading spinner over the preview section.\r\n     *\r\n     * @param  {jquery} root The root element.\r\n     */\r\n    var showLoadingIcon = function(root) {\r\n        root.find(SELECTORS.LOADING_ICON_CONTAINER).removeClass('hidden');\r\n    };\r\n\r\n    /**\r\n     * Hide the loading spinner.\r\n     *\r\n     * @param  {jquery} root The root element.\r\n     */\r\n    var hideLoadingIcon = function(root) {\r\n        root.find(SELECTORS.LOADING_ICON_CONTAINER).addClass('hidden');\r\n    };\r\n\r\n    /**\r\n     * Render the section of text to show the question count.\r\n     *\r\n     * @param  {jquery} root The root element.\r\n     * @param  {int} questionCount The number of questions.\r\n     */\r\n    var renderQuestionCount = function(root, questionCount) {\r\n        Str.get_string('questionsmatchingfilter', 'mod_quiz', questionCount)\r\n            .then(function(string) {\r\n                root.find(SELECTORS.QUESTION_COUNT_CONTAINER).html(string);\r\n                return;\r\n            })\r\n            .fail(Notification.exception);\r\n    };\r\n\r\n    /**\r\n     * Send a request to the server for more questions.\r\n     *\r\n     * @param  {int} categoryId A question category id.\r\n     * @param  {bool} includeSubcategories If the results should include subcategory questions\r\n     * @param  {int[]} tagIds The list of tag ids that each question must have.\r\n     * @param  {int} contextId The context where the questions will be added.\r\n     * @param  {int} limit How many questions to retrieve.\r\n     * @param  {int} offset How many questions to skip from the start of the result set.\r\n     * @return {promise} Resolved when the preview section has rendered.\r\n     */\r\n    var requestQuestions = function(\r\n        categoryId,\r\n        includeSubcategories,\r\n        tagIds,\r\n        contextId,\r\n        limit,\r\n        offset\r\n    ) {\r\n        var request = {\r\n            methodname: 'core_question_get_random_question_summaries',\r\n            args: {\r\n                categoryid: categoryId,\r\n                includesubcategories: includeSubcategories,\r\n                tagids: tagIds,\r\n                contextid: contextId,\r\n                limit: limit,\r\n                offset: offset\r\n            }\r\n        };\r\n\r\n        return Ajax.call([request])[0];\r\n    };\r\n\r\n    /**\r\n     * Build a paged content widget for questions with the given criteria. The\r\n     * criteria is used to fetch more questions from the server as the user\r\n     * requests new pages.\r\n     *\r\n     * @param  {int} categoryId A question category id.\r\n     * @param  {bool} includeSubcategories If the results should include subcategory questions\r\n     * @param  {int[]} tagIds The list of tag ids that each question must have.\r\n     * @param  {int} contextId The context where the questions will be added.\r\n     * @param  {int} totalQuestionCount How many questions match the criteria above.\r\n     * @param  {object[]} firstPageQuestions List of questions for the first page.\r\n     * @return {promise} A promise resolved with the HTML and JS for the paged content.\r\n     */\r\n    var renderQuestionsAsPagedContent = function(\r\n        categoryId,\r\n        includeSubcategories,\r\n        tagIds,\r\n        contextId,\r\n        totalQuestionCount,\r\n        firstPageQuestions\r\n    ) {\r\n        // Provide a callback, renderQuestionsPages,\r\n        // to control how the questions on each page are rendered.\r\n        return PagedContentFactory.createFromAjax(\r\n            totalQuestionCount,\r\n            ITEMS_PER_PAGE,\r\n            // Callback function to render the requested pages.\r\n            function(pagesData) {\r\n                return pagesData.map(function(pageData) {\r\n                    var limit = pageData.limit;\r\n                    var offset = pageData.offset;\r\n\r\n                    if (offset == 0) {\r\n                        // The first page is being requested and we've already got\r\n                        // that data so we can just render it immediately.\r\n                        return Templates.render(TEMPLATE_NAME, {questions: firstPageQuestions});\r\n                    } else {\r\n                        // Otherwise we need to ask the server for the data.\r\n                        return requestQuestions(\r\n                            categoryId,\r\n                            includeSubcategories,\r\n                            tagIds,\r\n                            contextId,\r\n                            limit,\r\n                            offset\r\n                        )\r\n                        .then(function(response) {\r\n                            var questions = response.questions;\r\n                            return Templates.render(TEMPLATE_NAME, {questions: questions});\r\n                        })\r\n                        .fail(Notification.exception);\r\n                    }\r\n                });\r\n            }\r\n        );\r\n    };\r\n\r\n    /**\r\n     * Re-render the preview section based on the provided filter criteria.\r\n     *\r\n     * @param  {jquery} root The root element.\r\n     * @param  {int} categoryId A question category id.\r\n     * @param  {bool} includeSubcategories If the results should include subcategory questions\r\n     * @param  {int[]} tagIds The list of tag ids that each question must have.\r\n     * @param  {int} contextId The context where the questions will be added.\r\n     * @return {promise} Resolved when the preview section has rendered.\r\n     */\r\n    var reload = function(root, categoryId, includeSubcategories, tagIds, contextId) {\r\n        // Show the loading spinner to tell the user that something is happening.\r\n        showLoadingIcon(root);\r\n        // Load the first set of questions.\r\n        return requestQuestions(categoryId, includeSubcategories, tagIds, contextId, ITEMS_PER_PAGE, 0)\r\n            .then(function(response) {\r\n                var totalCount = response.totalcount;\r\n                // Show the help message for the user to indicate how many questions\r\n                // match their filter criteria.\r\n                renderQuestionCount(root, totalCount);\r\n                return response;\r\n            })\r\n            .then(function(response) {\r\n                var totalQuestionCount = response.totalcount;\r\n                var questions = response.questions;\r\n\r\n                if (questions.length) {\r\n                    // We received some questions so render them as paged content\r\n                    // with a paging bar.\r\n                    return renderQuestionsAsPagedContent(\r\n                        categoryId,\r\n                        includeSubcategories,\r\n                        tagIds,\r\n                        contextId,\r\n                        totalQuestionCount,\r\n                        questions\r\n                    );\r\n                } else {\r\n                    // If we didn't receive any questions then we can return empty\r\n                    // HTML and JS to clear the preview section.\r\n                    return $.Deferred().resolve('', '');\r\n                }\r\n            })\r\n            .then(function(html, js) {\r\n                // Show the user the question set.\r\n                var container = root.find(SELECTORS.QUESTION_LIST_CONTAINER);\r\n                Templates.replaceNodeContents(container, html, js);\r\n                return;\r\n            })\r\n            .always(function() {\r\n                hideLoadingIcon(root);\r\n            })\r\n            .fail(Notification.exception);\r\n    };\r\n\r\n    return {\r\n        reload: reload,\r\n        showLoadingIcon: showLoadingIcon,\r\n        hideLoadingIcon: hideLoadingIcon\r\n    };\r\n});\r\n"],"names":["define","$","Ajax","Str","Notification","Templates","PagedContentFactory","TEMPLATE_NAME","SELECTORS","showLoadingIcon","root","find","removeClass","hideLoadingIcon","addClass","requestQuestions","categoryId","includeSubcategories","tagIds","contextId","limit","offset","request","methodname","args","categoryid","includesubcategories","tagids","contextid","call","reload","then","response","totalCount","totalcount","questionCount","get_string","string","html","fail","exception","renderQuestionCount","totalQuestionCount","questions","length","firstPageQuestions","createFromAjax","pagesData","map","pageData","render","renderQuestionsAsPagedContent","Deferred","resolve","js","container","replaceNodeContents","always"],"mappings":";;;;;;;;AAuBAA,+CACI,CACI,SACA,YACA,WACA,oBACA,iBACA,+BAEJ,SACIC,EACAC,KACAC,IACAC,aACAC,UACAC,yBAIAC,cAAgB,sDAChBC,iCACwB,yCADxBA,mCAE0B,2CAF1BA,kCAGyB,0CAQzBC,gBAAkB,SAASC,MAC3BA,KAAKC,KAAKH,kCAAkCI,YAAY,WAQxDC,gBAAkB,SAASH,MAC3BA,KAAKC,KAAKH,kCAAkCM,SAAS,WA6BrDC,iBAAmB,SACnBC,WACAC,qBACAC,OACAC,UACAC,MACAC,YAEIC,QAAU,CACVC,WAAY,8CACZC,KAAM,CACFC,WAAYT,WACZU,qBAAsBT,qBACtBU,OAAQT,OACRU,UAAWT,UACXC,MAAOA,MACPC,OAAQA,gBAITnB,KAAK2B,KAAK,CAACP,UAAU,UAmHzB,CACHQ,OA9CS,SAASpB,KAAMM,WAAYC,qBAAsBC,OAAQC,kBAElEV,gBAAgBC,MAETK,iBAAiBC,WAAYC,qBAAsBC,OAAQC,UAlJjD,EAkJ4E,GACxFY,MAAK,SAASC,cACPC,WAAaD,SAASE,kBApHZ,SAASxB,KAAMyB,eACrChC,IAAIiC,WAAW,0BAA2B,WAAYD,eACjDJ,MAAK,SAASM,QACX3B,KAAKC,KAAKH,oCAAoC8B,KAAKD,WAGtDE,KAAKnC,aAAaoC,WAiHfC,CAAoB/B,KAAMuB,YACnBD,YAEVD,MAAK,SAASC,cACPU,mBAAqBV,SAASE,WAC9BS,UAAYX,SAASW,iBAErBA,UAAUC,OAtEU,SAChC5B,WACAC,qBACAC,OACAC,UACAuB,mBACAG,2BAIOvC,oBAAoBwC,eACvBJ,mBAnGa,GAsGb,SAASK,kBACEA,UAAUC,KAAI,SAASC,cACtB7B,MAAQ6B,SAAS7B,MACjBC,OAAS4B,SAAS5B,cAER,GAAVA,OAGOhB,UAAU6C,OAAO3C,cAAe,CAACoC,UAAWE,qBAG5C9B,iBACHC,WACAC,qBACAC,OACAC,UACAC,MACAC,QAEHU,MAAK,SAASC,cACPW,UAAYX,SAASW,iBAClBtC,UAAU6C,OAAO3C,cAAe,CAACoC,UAAWA,eAEtDJ,KAAKnC,aAAaoC,iBAoChBW,CACHnC,WACAC,qBACAC,OACAC,UACAuB,mBACAC,WAKG1C,EAAEmD,WAAWC,QAAQ,GAAI,OAGvCtB,MAAK,SAASO,KAAMgB,QAEbC,UAAY7C,KAAKC,KAAKH,mCAC1BH,UAAUmD,oBAAoBD,UAAWjB,KAAMgB,OAGlDG,QAAO,WACJ5C,gBAAgBH,SAEnB6B,KAAKnC,aAAaoC,YAKvB/B,gBAAiBA,gBACjBI,gBAAiBA"}