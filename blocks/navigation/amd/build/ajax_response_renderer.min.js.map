{"version":3,"file":"ajax_response_renderer.min.js","sources":["../src/ajax_response_renderer.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Parse the response from the navblock ajax page and render the correct DOM\r\n * structure for the tree from it.\r\n *\r\n * @module     block_navigation/ajax_response_renderer\r\n * @copyright  2015 John Okely <john@moodle.com>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\ndefine([\r\n    'jquery',\r\n    'core/templates',\r\n    'core/notification',\r\n    'core/url',\r\n    'core/aria',\r\n], function(\r\n    $,\r\n    Templates,\r\n    Notification,\r\n    Url,\r\n    Aria\r\n) {\r\n\r\n    // Mappings for the different types of nodes coming from the navigation.\r\n    // Copied from lib/navigationlib.php navigation_node constants.\r\n    var NODETYPE = {\r\n        // @type int Activity (course module) = 40.\r\n        ACTIVITY: 40,\r\n        // @type int Resource (course module = 50.\r\n        RESOURCE: 50,\r\n    };\r\n\r\n    /**\r\n     * Build DOM.\r\n     *\r\n     * @method buildDOM\r\n     * @param {Object} rootElement the root element of DOM.\r\n     * @param {object} nodes jquery object representing the nodes to be build.\r\n     */\r\n    function buildDOM(rootElement, nodes) {\r\n        var ul = $('<ul></ul>');\r\n        ul.attr('role', 'group');\r\n        Aria.hide(ul);\r\n\r\n        $.each(nodes, function(index, node) {\r\n            if (typeof node !== 'object') {\r\n                return;\r\n            }\r\n\r\n            var li = $('<li></li>');\r\n            var p = $('<p></p>');\r\n            var id = node.id || node.key + '_tree_item';\r\n            var icon = null;\r\n            var isBranch = (node.expandable || node.haschildren) ? true : false;\r\n\r\n            li.attr('role', 'treeitem');\r\n            p.addClass('tree_item');\r\n            p.attr('id', id);\r\n            // Negative tab index to allow it to receive focus.\r\n            p.attr('tabindex', '-1');\r\n\r\n            if (node.requiresajaxloading) {\r\n                li.attr('data-requires-ajax', true);\r\n                li.attr('data-node-id', node.id);\r\n                li.attr('data-node-key', node.key);\r\n                li.attr('data-node-type', node.type);\r\n            }\r\n\r\n            if (isBranch) {\r\n                li.addClass('collapsed contains_branch');\r\n                li.attr('aria-expanded', false);\r\n                p.addClass('branch');\r\n            }\r\n\r\n            var eleToAddIcon = null;\r\n            if (node.link) {\r\n                var link = $('<a title=\"' + node.title + '\" href=\"' + node.link + '\"></a>');\r\n\r\n                eleToAddIcon = link;\r\n                link.append('<span class=\"item-content-wrap\">' + node.name + '</span>');\r\n\r\n                if (node.hidden) {\r\n                    link.addClass('dimmed');\r\n                }\r\n\r\n                p.append(link);\r\n            } else {\r\n                var span = $('<span></span>');\r\n\r\n                eleToAddIcon = span;\r\n                span.append('<span class=\"item-content-wrap\">' + node.name + '</span>');\r\n\r\n                if (node.hidden) {\r\n                    span.addClass('dimmed');\r\n                }\r\n\r\n                p.append(span);\r\n            }\r\n\r\n            if (node.icon && (!isBranch || node.type === NODETYPE.ACTIVITY || node.type === NODETYPE.RESOURCE)) {\r\n                li.addClass('item_with_icon');\r\n                p.addClass('hasicon');\r\n\r\n                if (node.type === NODETYPE.ACTIVITY || node.type === NODETYPE.RESOURCE) {\r\n                    icon = $('<img/>');\r\n                    icon.attr('alt', node.icon.alt);\r\n                    icon.attr('title', node.icon.title);\r\n                    icon.attr('src', Url.imageUrl(node.icon.pix, node.icon.component));\r\n                    $.each(node.icon.classes, function(index, className) {\r\n                        icon.addClass(className);\r\n                    });\r\n                    eleToAddIcon.prepend(icon);\r\n                } else {\r\n                    if (node.icon.component == 'moodle') {\r\n                        node.icon.component = 'core';\r\n                    }\r\n                    Templates.renderPix(node.icon.pix, node.icon.component, node.icon.title).then(function(html) {\r\n                        // Prepend.\r\n                        eleToAddIcon.prepend(html);\r\n                        return;\r\n                    }).catch(Notification.exception);\r\n                }\r\n            }\r\n\r\n            li.append(p);\r\n            ul.append(li);\r\n\r\n            if (node.children && node.children.length) {\r\n                buildDOM(li, node.children);\r\n            } else if (isBranch && !node.requiresajaxloading) {\r\n                li.removeClass('contains_branch');\r\n                p.addClass('emptybranch');\r\n            }\r\n        });\r\n\r\n        rootElement.append(ul);\r\n        var id = rootElement.attr('id') + '_group';\r\n        ul.attr('id', id);\r\n        rootElement.attr('aria-owns', id);\r\n        rootElement.attr('role', 'treeitem');\r\n    }\r\n\r\n    return {\r\n        render: function(element, nodes) {\r\n            // The first element of the response is the existing node so we start with processing the children.\r\n            if (nodes.children && nodes.children.length) {\r\n                buildDOM(element, nodes.children);\r\n\r\n                var item = element.children(\"[role='treeitem']\").first();\r\n                var group = element.find('#' + item.attr('aria-owns'));\r\n\r\n                item.attr('aria-expanded', true);\r\n                Aria.unhide(group);\r\n            } else {\r\n                if (element.hasClass('contains_branch')) {\r\n                    element.removeClass('contains_branch');\r\n                    element.addClass('emptybranch');\r\n                }\r\n            }\r\n        }\r\n    };\r\n});\r\n"],"names":["define","$","Templates","Notification","Url","Aria","NODETYPE","buildDOM","rootElement","nodes","ul","attr","hide","each","index","node","li","p","id","key","icon","isBranch","expandable","haschildren","addClass","requiresajaxloading","type","eleToAddIcon","link","title","append","name","hidden","span","alt","imageUrl","pix","component","classes","className","prepend","renderPix","then","html","catch","exception","children","length","removeClass","render","element","item","first","group","find","unhide","hasClass"],"mappings":"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"}