{"version":3,"file":"month_view_drag_drop.min.js","sources":["../src/month_view_drag_drop.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * A javascript module to handle calendar drag and drop in the calendar\r\n * month view.\r\n *\r\n * @module     core_calendar/month_view_drag_drop\r\n * @copyright  2017 Ryan Wyllie <ryan@moodle.com>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\ndefine([\r\n            'jquery',\r\n            'core/notification',\r\n            'core/str',\r\n            'core_calendar/events',\r\n            'core_calendar/drag_drop_data_store'\r\n        ],\r\n        function(\r\n            $,\r\n            Notification,\r\n            Str,\r\n            CalendarEvents,\r\n            DataStore\r\n        ) {\r\n\r\n    var SELECTORS = {\r\n        ROOT: \"[data-region='calendar']\",\r\n        DRAGGABLE: '[draggable=\"true\"][data-region=\"event-item\"]',\r\n        DROP_ZONE: '[data-drop-zone=\"month-view-day\"]',\r\n        WEEK: '[data-region=\"month-view-week\"]',\r\n    };\r\n    var INVALID_DROP_ZONE_CLASS = 'bg-faded';\r\n    var INVALID_HOVER_CLASS = 'bg-danger text-white';\r\n    var VALID_HOVER_CLASS = 'bg-primary text-white';\r\n    var ALL_CLASSES = INVALID_DROP_ZONE_CLASS + ' ' + INVALID_HOVER_CLASS + ' ' + VALID_HOVER_CLASS;\r\n    /* @var {bool} registered If the event listeners have been added */\r\n    var registered = false;\r\n\r\n    /**\r\n     * Get the correct drop zone element from the given javascript\r\n     * event.\r\n     *\r\n     * @param {event} e The javascript event\r\n     * @return {object|null}\r\n     */\r\n    var getDropZoneFromEvent = function(e) {\r\n        var dropZone = $(e.target).closest(SELECTORS.DROP_ZONE);\r\n        return (dropZone.length) ? dropZone : null;\r\n    };\r\n\r\n    /**\r\n     * Determine if the given dropzone element is within the acceptable\r\n     * time range.\r\n     *\r\n     * The drop zone timestamp is midnight on that day so we should check\r\n     * that the event's acceptable timestart value\r\n     *\r\n     * @param {object} dropZone The drop zone day from the calendar\r\n     * @return {bool}\r\n     */\r\n    var isValidDropZone = function(dropZone) {\r\n        var dropTimestamp = dropZone.attr('data-day-timestamp');\r\n        var minTimestart = DataStore.getMinTimestart();\r\n        var maxTimestart = DataStore.getMaxTimestart();\r\n\r\n        if (minTimestart && minTimestart > dropTimestamp) {\r\n            return false;\r\n        }\r\n\r\n        if (maxTimestart && maxTimestart < dropTimestamp) {\r\n            return false;\r\n        }\r\n\r\n        return true;\r\n    };\r\n\r\n    /**\r\n     * Get the error string to display for a given drop zone element\r\n     * if it is invalid.\r\n     *\r\n     * @param {object} dropZone The drop zone day from the calendar\r\n     * @return {string}\r\n     */\r\n    var getDropZoneError = function(dropZone) {\r\n        var dropTimestamp = dropZone.attr('data-day-timestamp');\r\n        var minTimestart = DataStore.getMinTimestart();\r\n        var maxTimestart = DataStore.getMaxTimestart();\r\n\r\n        if (minTimestart && minTimestart > dropTimestamp) {\r\n            return DataStore.getMinError();\r\n        }\r\n\r\n        if (maxTimestart && maxTimestart < dropTimestamp) {\r\n            return DataStore.getMaxError();\r\n        }\r\n\r\n        return null;\r\n    };\r\n\r\n    /**\r\n     * Remove all of the styling from each of the drop zones in the calendar.\r\n     */\r\n    var clearAllDropZonesState = function() {\r\n        $(SELECTORS.ROOT).find(SELECTORS.DROP_ZONE).each(function(index, dropZone) {\r\n            dropZone = $(dropZone);\r\n            dropZone.removeClass(ALL_CLASSES);\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Update the hover state for the event in the calendar to reflect\r\n     * which days the event will be moved to.\r\n     *\r\n     * If the drop zone is not being hovered then it will apply some\r\n     * styling to reflect whether the drop zone is a valid or invalid\r\n     * drop place for the current dragging event.\r\n     *\r\n     * This funciton supports events spanning multiple days and will\r\n     * recurse to highlight (or remove highlight) each of the days\r\n     * that the event will be moved to.\r\n     *\r\n     * For example: An event with a duration of 3 days will have\r\n     * 3 days highlighted when it's dragged elsewhere in the calendar.\r\n     * The current drag target and the 2 days following it (including\r\n     * wrapping to the next week if necessary).\r\n     *\r\n     * @param {string|object} dropZone The drag target element\r\n     * @param {bool} hovered If the target is hovered or not\r\n     * @param {Number} count How many days to highlight (default to duration)\r\n     */\r\n    var updateHoverState = function(dropZone, hovered, count) {\r\n        if (typeof count === 'undefined') {\r\n            // This is how many days we need to highlight.\r\n            count = DataStore.getDurationDays();\r\n        }\r\n\r\n        var valid = isValidDropZone(dropZone);\r\n        dropZone.removeClass(ALL_CLASSES);\r\n\r\n        if (hovered) {\r\n\r\n            if (valid) {\r\n                dropZone.addClass(VALID_HOVER_CLASS);\r\n            } else {\r\n                dropZone.addClass(INVALID_HOVER_CLASS);\r\n            }\r\n        } else {\r\n            dropZone.removeClass(VALID_HOVER_CLASS + ' ' + INVALID_HOVER_CLASS);\r\n\r\n            if (!valid) {\r\n                dropZone.addClass(INVALID_DROP_ZONE_CLASS);\r\n            }\r\n        }\r\n\r\n        count--;\r\n\r\n        // If we've still got days to highlight then we should\r\n        // find the next day.\r\n        if (count > 0) {\r\n            var nextDropZone = dropZone.next();\r\n\r\n            // If there are no more days in this week then we\r\n            // need to move down to the next week in the calendar.\r\n            if (!nextDropZone.length) {\r\n                var nextWeek = dropZone.closest(SELECTORS.WEEK).next();\r\n\r\n                if (nextWeek.length) {\r\n                    nextDropZone = nextWeek.children(SELECTORS.DROP_ZONE).first();\r\n                }\r\n            }\r\n\r\n            // If we found another day then let's recursively\r\n            // update it's hover state.\r\n            if (nextDropZone.length) {\r\n                updateHoverState(nextDropZone, hovered, count);\r\n            }\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Find all of the calendar event drop zones in the calendar and update the display\r\n     * for the user to indicate which zones are valid and invalid.\r\n     */\r\n    var updateAllDropZonesState = function() {\r\n        $(SELECTORS.ROOT).find(SELECTORS.DROP_ZONE).each(function(index, dropZone) {\r\n            dropZone = $(dropZone);\r\n\r\n            if (!isValidDropZone(dropZone)) {\r\n                updateHoverState(dropZone, false);\r\n            }\r\n        });\r\n    };\r\n\r\n\r\n    /**\r\n     * Set up the module level variables to track which event is being\r\n     * dragged and how many days it spans.\r\n     *\r\n     * @param {event} e The dragstart event\r\n     */\r\n    var dragstartHandler = function(e) {\r\n        var target = $(e.target);\r\n        var draggableElement = target.closest(SELECTORS.DRAGGABLE);\r\n\r\n        if (!draggableElement.length) {\r\n            return;\r\n        }\r\n\r\n        var eventElement = draggableElement.find('[data-event-id]');\r\n        var eventId = eventElement.attr('data-event-id');\r\n        var minTimestart = draggableElement.attr('data-min-day-timestamp');\r\n        var maxTimestart = draggableElement.attr('data-max-day-timestamp');\r\n        var minError = draggableElement.attr('data-min-day-error');\r\n        var maxError = draggableElement.attr('data-max-day-error');\r\n        var eventsSelector = SELECTORS.ROOT + ' [data-event-id=\"' + eventId + '\"]';\r\n        var duration = $(eventsSelector).length;\r\n\r\n        DataStore.setEventId(eventId);\r\n        DataStore.setDurationDays(duration);\r\n\r\n        if (minTimestart) {\r\n            DataStore.setMinTimestart(minTimestart);\r\n        }\r\n\r\n        if (maxTimestart) {\r\n            DataStore.setMaxTimestart(maxTimestart);\r\n        }\r\n\r\n        if (minError) {\r\n            DataStore.setMinError(minError);\r\n        }\r\n\r\n        if (maxError) {\r\n            DataStore.setMaxError(maxError);\r\n        }\r\n\r\n        e.dataTransfer.effectAllowed = \"move\";\r\n        e.dataTransfer.dropEffect = \"move\";\r\n        // Firefox requires a value to be set here or the drag won't\r\n        // work and the dragover handler won't fire.\r\n        e.dataTransfer.setData('text/plain', eventId);\r\n        e.dropEffect = \"move\";\r\n\r\n        updateAllDropZonesState();\r\n    };\r\n\r\n    /**\r\n     * Update the hover state of the target day element when\r\n     * the user is dragging an event over it.\r\n     *\r\n     * This will add a visual indicator to the calendar UI to\r\n     * indicate which day(s) the event will be moved to.\r\n     *\r\n     * @param {event} e The dragstart event\r\n     */\r\n    var dragoverHandler = function(e) {\r\n        // Ignore dragging of non calendar events.\r\n        if (!DataStore.hasEventId()) {\r\n            return;\r\n        }\r\n\r\n        e.preventDefault();\r\n\r\n        var dropZone = getDropZoneFromEvent(e);\r\n\r\n        if (!dropZone) {\r\n            return;\r\n        }\r\n\r\n        updateHoverState(dropZone, true);\r\n    };\r\n\r\n    /**\r\n     * Update the hover state of the target day element that was\r\n     * previously dragged over but has is no longer a drag target.\r\n     *\r\n     * This will remove the visual indicator from the calendar UI\r\n     * that was added by the dragoverHandler.\r\n     *\r\n     * @param {event} e The dragstart event\r\n     */\r\n    var dragleaveHandler = function(e) {\r\n        // Ignore dragging of non calendar events.\r\n        if (!DataStore.hasEventId()) {\r\n            return;\r\n        }\r\n\r\n        var dropZone = getDropZoneFromEvent(e);\r\n\r\n        if (!dropZone) {\r\n            return;\r\n        }\r\n\r\n        updateHoverState(dropZone, false);\r\n        e.preventDefault();\r\n    };\r\n\r\n    /**\r\n     * Determines the event element, origin day, and destination day\r\n     * once the user drops the calendar event. These three bits of data\r\n     * are provided as the payload to the \"moveEvent\" calendar javascript\r\n     * event that is fired.\r\n     *\r\n     * This will remove the visual indicator from the calendar UI\r\n     * that was added by the dragoverHandler.\r\n     *\r\n     * @param {event} e The dragstart event\r\n     */\r\n    var dropHandler = function(e) {\r\n        // Ignore dragging of non calendar events.\r\n        if (!DataStore.hasEventId()) {\r\n            return;\r\n        }\r\n\r\n        var dropZone = getDropZoneFromEvent(e);\r\n\r\n        if (!dropZone) {\r\n            DataStore.clearAll();\r\n            clearAllDropZonesState();\r\n            return;\r\n        }\r\n\r\n        if (isValidDropZone(dropZone)) {\r\n            var eventId = DataStore.getEventId();\r\n            var eventElementSelector = SELECTORS.ROOT + ' [data-event-id=\"' + eventId + '\"]';\r\n            var eventElement = $(eventElementSelector);\r\n            var origin = null;\r\n\r\n            if (eventElement.length) {\r\n                origin = eventElement.closest(SELECTORS.DROP_ZONE);\r\n            }\r\n\r\n            $('body').trigger(CalendarEvents.moveEvent, [eventId, origin, dropZone]);\r\n        } else {\r\n            // If the drop zone is not valid then there is not need for us to\r\n            // try to process it. Instead we can just show an error to the user.\r\n            var message = getDropZoneError(dropZone);\r\n            Str.get_string('errorinvaliddate', 'calendar').then(function(string) {\r\n                Notification.exception({\r\n                    name: string,\r\n                    message: message || string\r\n                });\r\n            });\r\n        }\r\n\r\n        DataStore.clearAll();\r\n        clearAllDropZonesState();\r\n\r\n        e.preventDefault();\r\n    };\r\n\r\n    /**\r\n     * Clear the data store and remove the drag indicators from the UI\r\n     * when the drag event has finished.\r\n     */\r\n    var dragendHandler = function() {\r\n        DataStore.clearAll();\r\n        clearAllDropZonesState();\r\n    };\r\n\r\n    /**\r\n     * Re-render the drop zones in the new month to highlight\r\n     * which areas are or aren't acceptable to drop the calendar\r\n     * event.\r\n     */\r\n    var calendarMonthChangedHandler = function() {\r\n        updateAllDropZonesState();\r\n    };\r\n\r\n    return {\r\n        /**\r\n         * Initialise the event handlers for the drag events.\r\n         */\r\n        init: function() {\r\n            if (!registered) {\r\n                // These handlers are only added the first time the module\r\n                // is loaded because we don't want to have a new listener\r\n                // added each time the \"init\" function is called otherwise we'll\r\n                // end up with lots of stale handlers.\r\n                document.addEventListener('dragstart', dragstartHandler, false);\r\n                document.addEventListener('dragover', dragoverHandler, false);\r\n                document.addEventListener('dragleave', dragleaveHandler, false);\r\n                document.addEventListener('drop', dropHandler, false);\r\n                document.addEventListener('dragend', dragendHandler, false);\r\n                $('body').on(CalendarEvents.monthChanged, calendarMonthChangedHandler);\r\n                registered = true;\r\n            }\r\n        },\r\n    };\r\n});\r\n"],"names":["define","$","Notification","Str","CalendarEvents","DataStore","SELECTORS","ALL_CLASSES","INVALID_DROP_ZONE_CLASS","registered","getDropZoneFromEvent","e","dropZone","target","closest","length","isValidDropZone","dropTimestamp","attr","minTimestart","getMinTimestart","maxTimestart","getMaxTimestart","clearAllDropZonesState","find","each","index","removeClass","updateHoverState","hovered","count","getDurationDays","valid","addClass","VALID_HOVER_CLASS","nextDropZone","next","nextWeek","children","first","updateAllDropZonesState","dragstartHandler","draggableElement","eventId","minError","maxError","duration","setEventId","setDurationDays","setMinTimestart","setMaxTimestart","setMinError","setMaxError","dataTransfer","effectAllowed","dropEffect","setData","dragoverHandler","hasEventId","preventDefault","dragleaveHandler","dropHandler","clearAll","getEventId","eventElement","origin","trigger","moveEvent","message","getMinError","getMaxError","getDropZoneError","get_string","then","string","exception","name","dragendHandler","calendarMonthChangedHandler","init","document","addEventListener","on","monthChanged"],"mappings":"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"}