{"version":3,"file":"downloadcontent.min.js","sources":["../src/downloadcontent.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Functions related to downloading course content.\r\n *\r\n * @module     core_course/downloadcontent\r\n * @copyright  2020 Michael Hawkins <michaelh@moodle.com>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport Config from 'core/config';\r\nimport CustomEvents from 'core/custom_interaction_events';\r\nimport * as ModalFactory from 'core/modal_factory';\r\nimport jQuery from 'jquery';\r\nimport Pending from 'core/pending';\r\nimport {enter, space} from 'core/key_codes';\r\n\r\n/**\r\n * Set up listener to trigger the download course content modal.\r\n *\r\n * @return {void}\r\n */\r\nexport const init = () => {\r\n    const pendingPromise = new Pending();\r\n\r\n    // Add event listeners for click and enter/space keys.\r\n    jQuery('[data-downloadcourse]').on('click keydown', (e) => {\r\n        if (e.type === 'click' || e.which === enter || e.which === space) {\r\n            e.preventDefault();\r\n            displayDownloadConfirmation(e.currentTarget);\r\n        }\r\n    });\r\n\r\n    pendingPromise.resolve();\r\n};\r\n\r\n/**\r\n * Display the download course content modal.\r\n *\r\n * @method displayDownloadConfirmation\r\n * @param {Object} downloadModalTrigger The DOM element that triggered the download modal.\r\n * @return {void}\r\n */\r\nconst displayDownloadConfirmation = (downloadModalTrigger) => {\r\n    ModalFactory.create({\r\n        title: downloadModalTrigger.dataset.downloadTitle,\r\n        type: ModalFactory.types.SAVE_CANCEL,\r\n        body: `<p>${downloadModalTrigger.dataset.downloadBody}</p>`,\r\n        buttons: {\r\n            save: downloadModalTrigger.dataset.downloadButtonText\r\n        },\r\n        templateContext: {\r\n            classes: 'downloadcoursecontentmodal'\r\n        }\r\n    })\r\n    .then(modal => {\r\n        // Display the modal.\r\n        modal.show();\r\n\r\n        const saveButton = document.querySelector('.modal .downloadcoursecontentmodal [data-action=\"save\"]');\r\n        const cancelButton = document.querySelector('.modal .downloadcoursecontentmodal [data-action=\"cancel\"]');\r\n        const modalContainer = document.querySelector('.modal[data-region=\"modal-container\"]');\r\n\r\n        // Create listener to trigger the download when the \"Download\" button is pressed.\r\n        jQuery(saveButton).on(CustomEvents.events.activate, (e) => downloadContent(e, downloadModalTrigger, modal));\r\n\r\n        // Create listener to destroy the modal when closing modal by cancelling.\r\n        jQuery(cancelButton).on(CustomEvents.events.activate, () => {\r\n            modal.destroy();\r\n        });\r\n\r\n        // Create listener to destroy the modal when closing modal by clicking outside of it.\r\n        if (modalContainer.querySelector('.downloadcoursecontentmodal')) {\r\n            jQuery(modalContainer).on(CustomEvents.events.activate, () => {\r\n                modal.destroy();\r\n            });\r\n        }\r\n    });\r\n};\r\n\r\n/**\r\n * Trigger downloading of course content.\r\n *\r\n * @method downloadContent\r\n * @param {Event} e The event triggering the download.\r\n * @param {Object} downloadModalTrigger The DOM element that triggered the download modal.\r\n * @param {Object} modal The modal object.\r\n * @return {void}\r\n */\r\nconst downloadContent = (e, downloadModalTrigger, modal) => {\r\n    e.preventDefault();\r\n\r\n    // Create a form to submit the file download request, so we can avoid sending sesskey over GET.\r\n    const downloadForm = document.createElement('form');\r\n    downloadForm.action = downloadModalTrigger.dataset.downloadLink;\r\n    downloadForm.method = 'POST';\r\n    // Open download in a new tab, so current course view is not disrupted.\r\n    downloadForm.target = '_blank';\r\n    const downloadSesskey = document.createElement('input');\r\n    downloadSesskey.name = 'sesskey';\r\n    downloadSesskey.value = Config.sesskey;\r\n    downloadForm.appendChild(downloadSesskey);\r\n    downloadForm.style.display = 'none';\r\n\r\n    document.body.appendChild(downloadForm);\r\n    downloadForm.submit();\r\n    document.body.removeChild(downloadForm);\r\n\r\n    // Destroy the modal to prevent duplicates if reopened later.\r\n    modal.destroy();\r\n};\r\n"],"names":["pendingPromise","Pending","on","e","type","which","enter","space","preventDefault","displayDownloadConfirmation","currentTarget","resolve","downloadModalTrigger","ModalFactory","create","title","dataset","downloadTitle","types","SAVE_CANCEL","body","downloadBody","buttons","save","downloadButtonText","templateContext","classes","then","modal","show","saveButton","document","querySelector","cancelButton","modalContainer","CustomEvents","events","activate","downloadContent","destroy","downloadForm","createElement","action","downloadLink","method","target","downloadSesskey","name","value","Config","sesskey","appendChild","style","display","submit","removeChild"],"mappings":";;;;;;;g9BAmCoB,WACVA,eAAiB,IAAIC,qCAGpB,yBAAyBC,GAAG,iBAAkBC,IAClC,UAAXA,EAAEC,MAAoBD,EAAEE,QAAUC,kBAASH,EAAEE,QAAUE,mBACvDJ,EAAEK,iBACFC,4BAA4BN,EAAEO,mBAItCV,eAAeW,iBAUbF,4BAA+BG,uBACjCC,aAAaC,OAAO,CAChBC,MAAOH,qBAAqBI,QAAQC,cACpCb,KAAMS,aAAaK,MAAMC,YACzBC,kBAAYR,qBAAqBI,QAAQK,qBACzCC,QAAS,CACLC,KAAMX,qBAAqBI,QAAQQ,oBAEvCC,gBAAiB,CACbC,QAAS,gCAGhBC,MAAKC,QAEFA,MAAMC,aAEAC,WAAaC,SAASC,cAAc,2DACpCC,aAAeF,SAASC,cAAc,6DACtCE,eAAiBH,SAASC,cAAc,6DAGvCF,YAAY5B,GAAGiC,mCAAaC,OAAOC,UAAWlC,GAAMmC,gBAAgBnC,EAAGS,qBAAsBgB,6BAG7FK,cAAc/B,GAAGiC,mCAAaC,OAAOC,UAAU,KAClDT,MAAMW,aAINL,eAAeF,cAAc,oDACtBE,gBAAgBhC,GAAGiC,mCAAaC,OAAOC,UAAU,KACpDT,MAAMW,iBAehBD,gBAAkB,CAACnC,EAAGS,qBAAsBgB,SAC9CzB,EAAEK,uBAGIgC,aAAeT,SAASU,cAAc,QAC5CD,aAAaE,OAAS9B,qBAAqBI,QAAQ2B,aACnDH,aAAaI,OAAS,OAEtBJ,aAAaK,OAAS,eAChBC,gBAAkBf,SAASU,cAAc,SAC/CK,gBAAgBC,KAAO,UACvBD,gBAAgBE,MAAQC,gBAAOC,QAC/BV,aAAaW,YAAYL,iBACzBN,aAAaY,MAAMC,QAAU,OAE7BtB,SAASX,KAAK+B,YAAYX,cAC1BA,aAAac,SACbvB,SAASX,KAAKmC,YAAYf,cAG1BZ,MAAMW"}