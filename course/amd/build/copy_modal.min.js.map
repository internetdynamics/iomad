{"version":3,"file":"copy_modal.min.js","sources":["../src/copy_modal.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * This module provides the course copy modal from the course and\r\n * category management screen.\r\n *\r\n * @module     core_course/copy_modal\r\n * @copyright  2020 onward The Moodle Users Association <https://moodleassociation.org/>\r\n * @author     Matt Porritt <mattp@catalyst-au.net>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n * @since      3.9\r\n */\r\n\r\ndefine(['jquery', 'core/str', 'core/modal_factory', 'core/modal_events',\r\n        'core/ajax', 'core/fragment', 'core/notification', 'core/config'],\r\n        function($, Str, ModalFactory, ModalEvents, ajax, Fragment, Notification, Config) {\r\n\r\n    /**\r\n     * Module level variables.\r\n     */\r\n    var CopyModal = {};\r\n    var contextid;\r\n    var course;\r\n    var modalObj;\r\n    var spinner = '<p class=\"text-center\">'\r\n        + '<i class=\"fa fa-spinner fa-pulse fa-2x fa-fw\"></i>'\r\n        + '</p>';\r\n\r\n    /**\r\n     * Creates the modal for the course copy form\r\n     *\r\n     * @private\r\n     */\r\n    function createModal() {\r\n        // Get the Title String.\r\n        Str.get_string('loading').then(function(title) {\r\n            // Create the Modal.\r\n            ModalFactory.create({\r\n                type: ModalFactory.types.DEFAULT,\r\n                title: title,\r\n                body: spinner,\r\n                large: true\r\n            })\r\n            .done(function(modal) {\r\n                modalObj = modal;\r\n                // Explicitly handle form click events.\r\n                modalObj.getRoot().on('click', '#id_submitreturn', processModalForm);\r\n                modalObj.getRoot().on('click', '#id_submitdisplay', function(e) {\r\n                    e.formredirect = true;\r\n                    processModalForm(e);\r\n\r\n                });\r\n                modalObj.getRoot().on('click', '#id_cancel', function(e) {\r\n                    e.preventDefault();\r\n                    modalObj.setBody(spinner);\r\n                    modalObj.hide();\r\n                });\r\n            });\r\n            return;\r\n        }).catch(function() {\r\n            Notification.exception(new Error('Failed to load string: loading'));\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Updates the body of the modal window.\r\n     *\r\n     * @param {Object} formdata\r\n     * @private\r\n     */\r\n    function updateModalBody(formdata) {\r\n        if (typeof formdata === \"undefined\") {\r\n            formdata = {};\r\n        }\r\n\r\n        var params = {\r\n                'jsonformdata': JSON.stringify(formdata),\r\n                'courseid': course.id\r\n        };\r\n\r\n        modalObj.setBody(spinner);\r\n        Str.get_string('copycoursetitle', 'backup', course.shortname).then(function(title) {\r\n            modalObj.setTitle(title);\r\n            modalObj.setBody(Fragment.loadFragment('course', 'new_base_form', contextid, params));\r\n            return;\r\n        }).catch(function() {\r\n            Notification.exception(new Error('Failed to load string: copycoursetitle'));\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Updates Moodle form with selected information.\r\n     *\r\n     * @param {Object} e\r\n     * @private\r\n     */\r\n    function processModalForm(e) {\r\n        e.preventDefault(); // Stop modal from closing.\r\n\r\n        // Form data.\r\n        var copyform = modalObj.getRoot().find('form').serialize();\r\n        var formjson = JSON.stringify(copyform);\r\n\r\n        // Handle invalid form fields for better UX.\r\n        var invalid = $.merge(\r\n                modalObj.getRoot().find('[aria-invalid=\"true\"]'),\r\n                modalObj.getRoot().find('.error')\r\n        );\r\n\r\n        if (invalid.length) {\r\n            invalid.first().focus();\r\n            return;\r\n        }\r\n\r\n        // Submit form via ajax.\r\n        ajax.call([{\r\n            methodname: 'core_backup_submit_copy_form',\r\n            args: {\r\n                jsonformdata: formjson\r\n            },\r\n        }])[0].done(function() {\r\n            // For submission succeeded.\r\n            modalObj.setBody(spinner);\r\n            modalObj.hide();\r\n\r\n            if (e.formredirect == true) {\r\n                // We are redirecting to copy progress display.\r\n                let redirect = Config.wwwroot + \"/backup/copyprogress.php?id=\" + course.id;\r\n                window.location.assign(redirect);\r\n            }\r\n\r\n        }).fail(function() {\r\n            // Form submission failed server side, redisplay with errors.\r\n            updateModalBody(copyform);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Initialise the class.\r\n     *\r\n     * @method\r\n     * @param {Object} context\r\n     * @public\r\n     */\r\n    CopyModal.init = function(context) {\r\n        contextid = context;\r\n        // Setup the initial Modal.\r\n        createModal();\r\n\r\n        // Setup the click handlers on the copy buttons.\r\n        $('.action-copy').on('click', function(e) {\r\n            e.preventDefault(); // Stop. Hammer time.\r\n            let url = new URL(this.getAttribute('href'));\r\n            let params = new URLSearchParams(url.search);\r\n            let courseid = params.get('id');\r\n\r\n            ajax.call([{ // Get the course information.\r\n                methodname: 'core_course_get_courses',\r\n                args: {\r\n                    'options': {'ids': [courseid]},\r\n                },\r\n            }])[0].done(function(response) {\r\n                // We have the course info get the modal content.\r\n                course = response[0];\r\n                updateModalBody();\r\n\r\n            }).fail(function() {\r\n                Notification.exception(new Error('Failed to load course'));\r\n            });\r\n\r\n            modalObj.show();\r\n        });\r\n\r\n    };\r\n\r\n    return CopyModal;\r\n});\r\n"],"names":["define","$","Str","ModalFactory","ModalEvents","ajax","Fragment","Notification","Config","contextid","course","modalObj","CopyModal","spinner","updateModalBody","formdata","params","JSON","stringify","id","setBody","get_string","shortname","then","title","setTitle","loadFragment","catch","exception","Error","processModalForm","e","preventDefault","copyform","getRoot","find","serialize","formjson","invalid","merge","length","first","focus","call","methodname","args","jsonformdata","done","hide","formredirect","redirect","wwwroot","window","location","assign","fail","init","context","create","type","types","DEFAULT","body","large","modal","on","url","URL","this","getAttribute","courseid","URLSearchParams","search","get","response","show"],"mappings":";;;;;;;;;;AA0BAA,gCAAO,CAAC,SAAU,WAAY,qBAAsB,oBAC5C,YAAa,gBAAiB,oBAAqB,gBACnD,SAASC,EAAGC,IAAKC,aAAcC,YAAaC,KAAMC,SAAUC,aAAcC,YAM1EC,UACAC,OACAC,SAHAC,UAAY,GAIZC,QAAU,yFA8CLC,gBAAgBC,eACG,IAAbA,WACPA,SAAW,QAGXC,OAAS,cACWC,KAAKC,UAAUH,mBACnBL,OAAOS,IAG3BR,SAASS,QAAQP,SACjBX,IAAImB,WAAW,kBAAmB,SAAUX,OAAOY,WAAWC,MAAK,SAASC,OACxEb,SAASc,SAASD,OAClBb,SAASS,QAAQd,SAASoB,aAAa,SAAU,gBAAiBjB,UAAWO,YAE9EW,OAAM,WACLpB,aAAaqB,UAAU,IAAIC,MAAM,uDAUhCC,iBAAiBC,GACtBA,EAAEC,qBAGEC,SAAWtB,SAASuB,UAAUC,KAAK,QAAQC,YAC3CC,SAAWpB,KAAKC,UAAUe,UAG1BK,QAAUrC,EAAEsC,MACR5B,SAASuB,UAAUC,KAAK,yBACxBxB,SAASuB,UAAUC,KAAK,WAG5BG,QAAQE,OACRF,QAAQG,QAAQC,QAKpBrC,KAAKsC,KAAK,CAAC,CACPC,WAAY,+BACZC,KAAM,CACFC,aAAcT,aAElB,GAAGU,MAAK,cAERpC,SAASS,QAAQP,SACjBF,SAASqC,OAEa,GAAlBjB,EAAEkB,aAAsB,KAEpBC,SAAW1C,OAAO2C,QAAU,+BAAiCzC,OAAOS,GACxEiC,OAAOC,SAASC,OAAOJ,cAG5BK,MAAK,WAEJzC,gBAAgBmB,oBAWxBrB,UAAU4C,KAAO,SAASC,SACtBhD,UAAYgD,QA9GZvD,IAAImB,WAAW,WAAWE,MAAK,SAASC,OAEpCrB,aAAauD,OAAO,CAChBC,KAAMxD,aAAayD,MAAMC,QACzBrC,MAAOA,MACPsC,KAAMjD,QACNkD,OAAO,IAEVhB,MAAK,SAASiB,QACXrD,SAAWqD,OAEF9B,UAAU+B,GAAG,QAAS,mBAAoBnC,kBACnDnB,SAASuB,UAAU+B,GAAG,QAAS,qBAAqB,SAASlC,GACzDA,EAAEkB,cAAe,EACjBnB,iBAAiBC,MAGrBpB,SAASuB,UAAU+B,GAAG,QAAS,cAAc,SAASlC,GAClDA,EAAEC,iBACFrB,SAASS,QAAQP,SACjBF,SAASqC,gBAIlBrB,OAAM,WACLpB,aAAaqB,UAAU,IAAIC,MAAM,sCA0FrC5B,EAAE,gBAAgBgE,GAAG,SAAS,SAASlC,GACnCA,EAAEC,qBACEkC,IAAM,IAAIC,IAAIC,KAAKC,aAAa,SAEhCC,SADS,IAAIC,gBAAgBL,IAAIM,QACfC,IAAI,MAE1BpE,KAAKsC,KAAK,CAAC,CACPC,WAAY,0BACZC,KAAM,SACS,KAAQ,CAACyB,eAExB,GAAGvB,MAAK,SAAS2B,UAEjBhE,OAASgE,SAAS,GAClB5D,qBAEDyC,MAAK,WACJhD,aAAaqB,UAAU,IAAIC,MAAM,6BAGrClB,SAASgE,WAKV/D"}