{"version":3,"file":"header.min.js","sources":["../../../../src/local/content/section/header.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Course section header component.\r\n *\r\n * This component is used to control specific course section interactions like drag and drop.\r\n *\r\n * @module     core_courseformat/local/content/section/header\r\n * @class      core_courseformat/local/content/section/header\r\n * @copyright  2021 Ferran Recio <ferran@moodle.com>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport DndSectionItem from 'core_courseformat/local/courseeditor/dndsectionitem';\r\n\r\nexport default class extends DndSectionItem {\r\n\r\n    /**\r\n     * Constructor hook.\r\n     *\r\n     * @param {Object} descriptor\r\n     */\r\n    create(descriptor) {\r\n        // Optional component name for debugging.\r\n        this.name = 'content_section_header';\r\n        // Default query selectors.\r\n        this.selectors = {\r\n            ACTIONSMENU: `.section_action_menu`,\r\n            BULKSELECT: `[data-for='sectionBulkSelect']`,\r\n            BULKCHECKBOX: `[data-bulkcheckbox]`,\r\n            CHEVRON: `[data-for='sectiontoggler']`,\r\n        };\r\n        this.classes = {\r\n            HIDE: 'd-none',\r\n            SELECTED: 'selected',\r\n        };\r\n        // Get main info from the descriptor.\r\n        this.id = descriptor.id;\r\n        this.section = descriptor.section;\r\n        this.course = descriptor.course;\r\n        this.fullregion = descriptor.fullregion;\r\n    }\r\n\r\n    /**\r\n     * Initial state ready method.\r\n     *\r\n     * @param {Object} state the initial state\r\n     */\r\n    stateReady(state) {\r\n        this.configDragDrop(this.id, state, this.fullregion);\r\n        this._refreshBulk({state});\r\n    }\r\n\r\n    /**\r\n     * Component watchers.\r\n     *\r\n     * @returns {Array} of watchers\r\n     */\r\n    getWatchers() {\r\n        return [\r\n            {watch: `bulk:updated`, handler: this._refreshBulk},\r\n            {watch: `section[${this.id}].title:updated`, handler: this._refreshSectionTitle},\r\n        ];\r\n    }\r\n\r\n    /**\r\n     * Update the section when the section name changes.\r\n     *\r\n     * The section header have several HTML that uses the section name\r\n     * for accessibility and behat tests. This method updates them all.\r\n     *\r\n     * @param {object} param\r\n     * @param {Object} param.element the section info\r\n     */\r\n    _refreshSectionTitle(param) {\r\n        const element = param.element;\r\n        this.getElement(this.selectors.CHEVRON)?.setAttribute(\"aria-label\", element.title);\r\n        this._refreshSectionBulkSelector(param);\r\n    }\r\n\r\n    /**\r\n     * Update the bulk checkbox when the section name changes.\r\n     *\r\n     * @param {object} param\r\n     * @param {Object} param.element the section info\r\n     */\r\n    async _refreshSectionBulkSelector({element}) {\r\n        const checkbox = this.getElement(this.selectors.BULKCHECKBOX);\r\n        if (!checkbox) {\r\n            return;\r\n        }\r\n        const newLabel = await this.reactive.getFormatString('selectsection', element.title);\r\n        checkbox.title = newLabel;\r\n        const label = this.getElement(`label[for='${checkbox.id}']`);\r\n        if (label) {\r\n            label.innerText = newLabel;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Update a bulk options.\r\n     *\r\n     * @param {object} param\r\n     * @param {Object} param.state the state data\r\n     */\r\n    _refreshBulk({state}) {\r\n        const bulk = state.bulk;\r\n        if (!this._isSectionBulkEditable()) {\r\n            return;\r\n        }\r\n        // For now, dragging elements in bulk is not possible.\r\n        this.setDraggable(!bulk.enabled);\r\n        this.getElement(this.selectors.BULKSELECT)?.classList.toggle(this.classes.HIDE, !bulk.enabled);\r\n\r\n        const disabled = !this._isSectionBulkEnabled(bulk);\r\n        const selected = this._isSelected(bulk);\r\n        this.element.classList.toggle(this.classes.SELECTED, selected);\r\n        this._setCheckboxValue(selected, disabled);\r\n    }\r\n\r\n    /**\r\n     * Modify the checkbox element.\r\n     * @param {Boolean} checked the new checked value\r\n     * @param {Boolean} disabled the new disabled value\r\n     */\r\n    _setCheckboxValue(checked, disabled) {\r\n        const checkbox = this.getElement(this.selectors.BULKCHECKBOX);\r\n        if (!checkbox) {\r\n            return;\r\n        }\r\n        checkbox.checked = checked;\r\n        checkbox.disabled = disabled;\r\n        // Is selectable is used to easily scan the page for bulk checkboxes.\r\n        if (disabled) {\r\n            checkbox.removeAttribute('data-is-selectable');\r\n        } else {\r\n            checkbox.dataset.isSelectable = 1;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Check if cm bulk selection is available.\r\n     * @param {Object} bulk the current state bulk attribute\r\n     * @returns {Boolean}\r\n     */\r\n    _isSectionBulkEnabled(bulk) {\r\n        if (!bulk.enabled) {\r\n            return false;\r\n        }\r\n        return (bulk.selectedType === '' || bulk.selectedType === 'section');\r\n    }\r\n\r\n    /**\r\n     * Check if the section is bulk editable.\r\n     * @return {Boolean}\r\n     */\r\n    _isSectionBulkEditable() {\r\n        const section = this.reactive.get('section', this.id);\r\n        return section?.bulkeditable ?? false;\r\n    }\r\n\r\n    /**\r\n     * Check if the cm id is part of the current bulk selection.\r\n     * @param {Object} bulk the current state bulk attribute\r\n     * @returns {Boolean}\r\n     */\r\n    _isSelected(bulk) {\r\n        if (bulk.selectedType !== 'section') {\r\n            return false;\r\n        }\r\n        return bulk.selection.includes(this.id);\r\n    }\r\n}\r\n"],"names":["DndSectionItem","create","descriptor","name","selectors","ACTIONSMENU","BULKSELECT","BULKCHECKBOX","CHEVRON","classes","HIDE","SELECTED","id","section","course","fullregion","stateReady","state","configDragDrop","this","_refreshBulk","getWatchers","watch","handler","_refreshSectionTitle","param","element","getElement","setAttribute","title","_refreshSectionBulkSelector","checkbox","newLabel","reactive","getFormatString","label","innerText","bulk","_isSectionBulkEditable","setDraggable","enabled","classList","toggle","disabled","_isSectionBulkEnabled","selected","_isSelected","_setCheckboxValue","checked","removeAttribute","dataset","isSelectable","selectedType","get","bulkeditable","selection","includes"],"mappings":";;;;;;;;;;oLA4B6BA,wBAOzBC,OAAOC,iBAEEC,KAAO,8BAEPC,UAAY,CACbC,mCACAC,4CACAC,mCACAC,4CAECC,QAAU,CACXC,KAAM,SACNC,SAAU,iBAGTC,GAAKV,WAAWU,QAChBC,QAAUX,WAAWW,aACrBC,OAASZ,WAAWY,YACpBC,WAAab,WAAWa,WAQjCC,WAAWC,YACFC,eAAeC,KAAKP,GAAIK,MAAOE,KAAKJ,iBACpCK,aAAa,CAACH,MAAAA,QAQvBI,oBACW,CACH,CAACC,qBAAuBC,QAASJ,KAAKC,cACtC,CAACE,wBAAkBH,KAAKP,sBAAqBW,QAASJ,KAAKK,uBAanEA,qBAAqBC,kCACXC,QAAUD,MAAMC,sCACjBC,WAAWR,KAAKf,UAAUI,uDAAUoB,aAAa,aAAcF,QAAQG,YACvEC,4BAA4BL,mDASHC,QAACA,oBACzBK,SAAWZ,KAAKQ,WAAWR,KAAKf,UAAUG,kBAC3CwB,sBAGCC,eAAiBb,KAAKc,SAASC,gBAAgB,gBAAiBR,QAAQG,OAC9EE,SAASF,MAAQG,eACXG,MAAQhB,KAAKQ,gCAAyBI,SAASnB,UACjDuB,QACAA,MAAMC,UAAYJ,UAU1BZ,8CAAaH,MAACA,mBACJoB,KAAOpB,MAAMoB,SACdlB,KAAKmB,qCAILC,cAAcF,KAAKG,wCACnBb,WAAWR,KAAKf,UAAUE,4DAAamC,UAAUC,OAAOvB,KAAKV,QAAQC,MAAO2B,KAAKG,eAEhFG,UAAYxB,KAAKyB,sBAAsBP,MACvCQ,SAAW1B,KAAK2B,YAAYT,WAC7BX,QAAQe,UAAUC,OAAOvB,KAAKV,QAAQE,SAAUkC,eAChDE,kBAAkBF,SAAUF,UAQrCI,kBAAkBC,QAASL,gBACjBZ,SAAWZ,KAAKQ,WAAWR,KAAKf,UAAUG,cAC3CwB,WAGLA,SAASiB,QAAUA,QACnBjB,SAASY,SAAWA,SAEhBA,SACAZ,SAASkB,gBAAgB,sBAEzBlB,SAASmB,QAAQC,aAAe,GASxCP,sBAAsBP,cACbA,KAAKG,UAGoB,KAAtBH,KAAKe,cAA6C,YAAtBf,KAAKe,cAO7Cd,yDACUzB,QAAUM,KAAKc,SAASoB,IAAI,UAAWlC,KAAKP,yCAC3CC,MAAAA,eAAAA,QAASyC,qEAQpBR,YAAYT,YACkB,YAAtBA,KAAKe,cAGFf,KAAKkB,UAAUC,SAASrC,KAAKP"}